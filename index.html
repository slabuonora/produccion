<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producci√≥n ‚Äî La Buonora</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
    :root {
      --bg: #f7f8fa; --surface: #fff; --border: #e2e5ea;
      --text: #1a1d23; --text-2: #5a5f6b; --text-3: #8b909c;
      --accent: #2e5faa; --accent-hover: #24508f; --accent-light: #eaf0fb;
      --danger: #c93c3c; --success: #2a8a4a; --warn: #c78b17; --radius: 8px;
      --mono: 'JetBrains Mono', monospace;
    }
    html.dark {
      --bg: #1a1d23; --surface: #23272e; --border: #353a44;
      --text: #e8eaed; --text-2: #b0b5bf; --text-3: #6b7280;
      --accent: #5b8fd9; --accent-hover: #7ba7e5; --accent-light: #2a3444;
      --danger: #e05555; --success: #3bb06a; --warn: #d9a030;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    
    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .app-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 28px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 50; }
    .app-header h1 { font-size: 18px; font-weight: 700; color: var(--accent); }
    .app-header .subtitle { color: var(--text-3); font-size: 13px; }
    .header-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .nav-tabs { display: flex; gap: 2px; background: var(--bg); border-radius: 8px; padding: 3px; margin-left: 12px; align-items: center; }
    .nav-tab { padding: 6px 14px; font-size: 12.5px; font-weight: 500; font-family: inherit; border: none; background: transparent; color: var(--text-3); cursor: pointer; border-radius: 6px; transition: all 0.15s; white-space: nowrap; }
    .nav-tab:hover { color: var(--text); background: var(--surface); }
    .nav-tab.active { background: var(--accent); color: white; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .nav-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
    .nav-group { position: relative; }
    .nav-group:hover .nav-dropdown, .nav-group:focus-within .nav-dropdown { display: block; }
    .nav-dropdown {
      display: none; position: absolute; top: 100%; left: 0; margin-top: 4px;
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 4px; min-width: 180px; z-index: 40; box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }
    .nav-dropdown .nav-tab { display: block; width: 100%; text-align: left; border-radius: 4px; padding: 7px 12px; font-size: 12px; }
    .nav-dropdown .nav-tab.active { background: var(--accent); }
    .nav-dropdown .dd-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-3); padding: 6px 12px 3px; }

    /* ‚îÄ‚îÄ Dual indicator dots ‚îÄ‚îÄ */
    .dual-dots { display: flex; gap: 3px; justify-content: center; align-items: center; }
    .dot-mob { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; transition: all .2s; border: 2px solid var(--border); color: var(--text-3); }
    .dot-mob:hover { transform: scale(1.15); }
    .dot-mob.pending { border-color: var(--border); background: var(--bg); color: var(--text-3); }
    .dot-mob.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .dot-mob.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); }
    .dot-auto { width: 20px; height: 20px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; border: 1.5px dashed var(--border); color: var(--text-3); transition: all .2s; }
    .dot-auto.pending { border-color: var(--border); background: transparent; color: var(--text-3); }
    .dot-auto.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); border-style: solid; }
    .dot-auto.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); border-style: solid; }
    .dot-auto.no_data { border-color: transparent; background: transparent; color: transparent; }
    .dual-label { font-size: 8px; color: var(--text-3); text-align: center; margin-top: 1px; letter-spacing: .03em; }
    
    /* ‚îÄ‚îÄ Shared UI ‚îÄ‚îÄ */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
    .card-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; color: var(--text); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .card-title .badge { font-size: 11px; font-weight: 500; background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 500; font-family: inherit; border-radius: 6px; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--surface); color: var(--text); border-color: var(--border); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    label { font-size: 12px; font-weight: 500; color: var(--text-2); display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 8px 10px; font-size: 13px; font-family: inherit; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); transition: border-color 0.15s; }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 14px; }
    .form-group { display: flex; flex-direction: column; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-3); padding: 10px 12px; border-bottom: 2px solid var(--border); }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:hover td { background: var(--accent-light); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .toast-container { position: fixed; top: 70px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 10px 16px; border-radius: 8px; font-size: 13px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.15); animation: slideIn 0.25s ease; }
    .toast-success { background: var(--success); } .toast-error { background: var(--danger); } .toast-info { background: var(--accent); }
    @keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 12px; }
    html.dark .loading-overlay { background: rgba(0,0,0,0.6); }
    .loading-overlay.active { display: flex; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dark-toggle { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 14px; color: var(--text); }
    .empty { text-align: center; padding: 40px 20px; color: var(--text-3); }
    .mono { font-family: var(--mono); }

    /* ‚îÄ‚îÄ Status badges ‚îÄ‚îÄ */
    .status { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
    .status-pending { background: #fef3d1; color: var(--warn); }
    .status-in_progress { background: var(--accent-light); color: var(--accent); }
    .status-completed { background: #e3f5ea; color: var(--success); }
    .status-on_hold { background: #e8e8e8; color: #888; }

    /* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
    .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .progress-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-fill.blue { background: linear-gradient(90deg, var(--accent), #60a5fa); }
    .progress-fill.amber { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

    /* ‚îÄ‚îÄ Summary metrics ‚îÄ‚îÄ */
    .metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .metric-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; }
    .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-3); font-weight: 600; margin-bottom: 6px; }
    .metric-value { font-family: var(--mono); font-size: 28px; font-weight: 700; color: var(--text); }
    .metric-sub { font-size: 12px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Queue table ‚îÄ‚îÄ */
    .queue-table td { font-size: 13px; }
    .queue-table .svc-name { font-weight: 600; color: var(--text); }
    .queue-table .svc-client { font-size: 12px; color: var(--text-2); }
    .queue-table .svc-desc { font-size: 11px; color: var(--text-3); }
    .queue-actions { display: flex; gap: 4px; }

    /* ‚îÄ‚îÄ Station indicators ‚îÄ‚îÄ */
    .station-cell { text-align: center; min-width: 90px; }
    .station-dot { width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; transition: all .2s; border: 2px solid var(--border); color: var(--text-3); }
    .station-dot:hover { transform: scale(1.15); }
    .station-dot.pending { border-color: var(--border); background: var(--bg); color: var(--text-3); }
    .station-dot.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .station-dot.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); }
    .station-info { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-top: 3px; white-space: nowrap; }

    /* ‚îÄ‚îÄ Timeline (day view) ‚îÄ‚îÄ */
    .timeline-container { position: relative; height: 60px; margin: 12px 0; }
    .tl-bar { position: absolute; top: 10px; height: 30px; border-radius: 3px; opacity: 0.7; cursor: default; }
    .tl-bar.completed { background: var(--success); }
    .tl-bar.interrupted { background: var(--danger); }
    .tl-bar:hover { opacity: 1; }
    .tl-axis { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-between; font-size: 10px; font-family: var(--mono); color: var(--text-3); }
    .tl-grid { position: absolute; top: 5px; bottom: 16px; width: 1px; background: var(--border); }

    /* ‚îÄ‚îÄ Histogram ‚îÄ‚îÄ */
    .hist-wrap { display: flex; align-items: flex-end; gap: 4px; height: 100px; }
    .hist-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .hist-bar { width: 100%; border-radius: 3px 3px 0 0; background: var(--accent); min-height: 2px; transition: height 0.4s; }
    .hist-cnt { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-bottom: 2px; min-height: 14px; }
    .hist-lbl { font-family: var(--mono); font-size: 9px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Day chart (historical) ‚îÄ‚îÄ */
    .day-bars { display: flex; align-items: flex-end; gap: 4px; height: 120px; }
    .day-col { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .day-col:hover .day-bar { opacity: 1; }
    .day-bar { width: 100%; border-radius: 4px 4px 0 0; background: var(--accent); opacity: 0.6; min-height: 3px; transition: all 0.3s; }
    .day-bar.today { background: var(--success); opacity: 0.9; }
    .day-cnt { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-bottom: 3px; }
    .day-lbl { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Cycle detail table ‚îÄ‚îÄ */
    .cycle-table { font-size: 12px; }
    .cycle-table td { padding: 6px 10px; }
    .cycle-table .piece-name { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cycle-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .cycle-status.completed { background: var(--success); }
    .cycle-status.interrupted { background: var(--danger); }

    /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 14px; align-items: flex-end; flex-wrap: wrap; }
    .filter-bar .form-group { flex: 1; min-width: 140px; margin-bottom: 0; }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; align-items: center; justify-content: center; }
    .modal-backdrop.active { display: flex; }
    .modal { background: var(--surface); border-radius: 12px; padding: 24px; max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .modal h3 { font-size: 16px; margin-bottom: 16px; }

    /* ‚îÄ‚îÄ Capacity planning ‚îÄ‚îÄ */
    .cap-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .cap-block { padding: 16px; background: var(--bg); border-radius: 8px; }
    .cap-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-3); margin-bottom: 10px; }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .metrics-row { grid-template-columns: 1fr 1fr; }
      .cap-summary { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ Corte station ‚îÄ‚îÄ */
    .semaforo { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 700; margin: 0 auto 4px; transition: all .3s; }

    /* ‚îÄ‚îÄ Analytics panel ‚îÄ‚îÄ */
    .ai-summary { padding: 16px 20px; background: linear-gradient(135deg, #1e293b, #334155); color: #e2e8f0; border-radius: var(--radius); margin-bottom: 16px; font-size: 14px; line-height: 1.7; }
    html.dark .ai-summary { background: linear-gradient(135deg, #0f172a, #1e293b); }
    .ai-summary .ai-badge { display: inline-flex; align-items: center; gap: 5px; background: rgba(99,102,241,.25); color: #a5b4fc; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; padding: 3px 10px; border-radius: 12px; margin-bottom: 10px; }
    .ai-summary p { margin: 0; }
    .insight-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
    @media (max-width: 768px) { .insight-grid { grid-template-columns: 1fr; } }
    .insight-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; border-left: 3px solid var(--accent); }
    .insight-card.high { border-left-color: #ef4444; }
    .insight-card.medium { border-left-color: #eab308; }
    .insight-card.low { border-left-color: #22c55e; }
    .insight-card .insight-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; color: var(--text); }
    .insight-card .insight-evidence { font-size: 12px; color: var(--text-2); line-height: 1.5; }
    .rec-list { display: flex; flex-direction: column; gap: 10px; }
    .rec-item { display: flex; gap: 12px; align-items: flex-start; padding: 14px 16px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); }
    .rec-num { min-width: 28px; height: 28px; border-radius: 50%; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; flex-shrink: 0; }
    .rec-body { flex: 1; }
    .rec-action { font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
    .rec-impact { font-size: 12px; color: var(--success); }
    .rec-effort { font-size: 11px; color: var(--text-3); margin-left: 10px; }
    .corr-bar { height: 6px; border-radius: 3px; background: var(--border); overflow: hidden; margin-top: 6px; }
    .corr-fill { height: 100%; border-radius: 3px; transition: width .5s; }
    .corr-fill.neg { background: #ef4444; }
    .corr-fill.pos { background: #22c55e; }
    .kpi-change { font-size: 12px; font-weight: 600; }
    .kpi-change.up { color: var(--success); }
    .kpi-change.down { color: var(--danger); }
    .analytics-loading { text-align: center; padding: 60px 20px; color: var(--text-3); }
    .analytics-loading .spinner { width: 28px; height: 28px; margin-bottom: 12px; }
    .semaforo.VERDE { background: #22c55e; color: white; box-shadow: 0 0 16px rgba(34,197,94,.4); }
    .semaforo.AMARILLO { background: #eab308; color: white; box-shadow: 0 0 16px rgba(234,179,8,.4); }
    .semaforo.ROJO { background: #ef4444; color: white; box-shadow: 0 0 16px rgba(239,68,68,.4); animation: pulse-red 1.5s ease-in-out infinite; }
    @keyframes pulse-red { 0%,100% { opacity:1; } 50% { opacity:.7; } }
    .hourly-chart { display: flex; align-items: flex-end; gap: 3px; height: 140px; padding-bottom: 20px; position: relative; }
    .hourly-col { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; min-width: 0; }
    .hourly-bar { width: 100%; border-radius: 3px 3px 0 0; min-height: 2px; transition: height .4s; position: relative; z-index: 1; }
    .hourly-bar.low { background: #ef4444; opacity: .8; }
    .hourly-bar.mid { background: #eab308; opacity: .8; }
    .hourly-bar.high { background: #22c55e; opacity: .8; }
    .hourly-bar.future { background: var(--border); opacity: .3; }
    .hourly-cnt { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-bottom: 2px; min-height: 14px; }
    .hourly-lbl { font-family: var(--mono); font-size: 9px; color: var(--text-3); margin-top: 4px; }
    .baseline-dot { position: absolute; width: 6px; height: 6px; border-radius: 50%; background: var(--accent); z-index: 2; left: 50%; transform: translateX(-50%); }
    .baseline-line { position: absolute; height: 1px; background: var(--accent); opacity: .5; z-index: 1; }

    /* ‚îÄ‚îÄ Tracking project cards ‚îÄ‚îÄ */
    .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; }
    .track-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; transition: border-color .15s; }
    .track-card:hover { border-color: var(--accent); }
    .track-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .track-card-name { font-size: 15px; font-weight: 700; color: var(--text); }
    .track-card-dates { font-size: 11px; color: var(--text-3); font-family: var(--mono); }
    .track-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
    .track-stat { text-align: center; }
    .track-stat-num { font-family: var(--mono); font-size: 20px; font-weight: 700; }
    .track-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: var(--text-3); }
    .track-days { display: flex; gap: 2px; align-items: flex-end; height: 36px; }
    .track-day-bar { flex: 1; border-radius: 2px 2px 0 0; background: var(--accent); opacity: .6; min-height: 2px; transition: height .3s; }
    .track-day-bar:hover { opacity: 1; }

    /* ‚îÄ‚îÄ Print / PDF export ‚îÄ‚îÄ */
    .print-header { display: none; }
    @media print {
      /* Reset: hide everything */
      body > * { display: none !important; }
      
      /* Show only the print wrapper */
      #printWrapper { 
        display: block !important; 
        position: static !important;
        width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      #printWrapper * { visibility: visible; }
      
      /* Print header */
      .print-header { 
        display: block !important;
        text-align: center; 
        padding: 0 0 12px; 
        border-bottom: 2px solid #333;
        margin-bottom: 20px;
        break-after: avoid;
      }
      .print-header h2 { font-size: 22px; margin: 0 0 4px; color: #1a1d23; font-weight: 700; }
      .print-header .print-sub { font-size: 12px; color: #666; }
      
      /* Clean up cards for print */
      .card, .metric-card, .insight-card, .rec-item, .ai-summary {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
      .ai-summary { background: #f1f5f9 !important; color: #1a1d23 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .ai-badge { background: #e0e7ff !important; color: #4338ca !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .metrics-row { grid-template-columns: repeat(3, 1fr) !important; }
      .insight-grid { grid-template-columns: 1fr 1fr !important; }
      .insight-card.high { border-left: 3px solid #ef4444 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .insight-card.medium { border-left: 3px solid #eab308 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .rec-num { background: #2e5faa !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .corr-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .corr-fill.neg { background: #ef4444 !important; }
      .corr-fill.pos { background: #22c55e !important; }
      .kpi-change.up { color: #16a34a !important; }
      .kpi-change.down { color: #dc2626 !important; }
      
      /* Hide interactive elements */
      .no-print, #caRefreshBtn, #caTimestamp, button { display: none !important; }
      
      /* Page setup */
      @page { 
        size: A4; 
        margin: 15mm 12mm; 
      }
      .card-title { break-after: avoid; }
    }
  </style>
</head>
<body>

<div class="app-header">
  <h1>Producci√≥n</h1>
  <span class="subtitle">La Buonora</span>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('cola')" id="tab-cola">Cola</button>
    <div class="nav-sep"></div>
    <div class="nav-group">
      <button class="nav-tab" id="tab-estaciones">Estaciones ‚ñæ</button>
      <div class="nav-dropdown">
        <div class="dd-label">Estaciones</div>
        <button class="nav-tab" onclick="switchTab('corte')" id="tab-corte">‚úÇ Corte</button>
        <button class="nav-tab" onclick="switchTab('enchape')" id="tab-enchape">‚ñ§ Enchape</button>
        <button class="nav-tab" onclick="switchTab('mecanizado')" id="tab-mecanizado">‚öô Mecanizado</button>
        <button class="nav-tab" onclick="switchTab('packing')" id="tab-packing">üì¶ Packing</button>
      </div>
    </div>
    <div class="nav-group">
      <button class="nav-tab" id="tab-control">Control ‚ñæ</button>
      <div class="nav-dropdown">
        <div class="dd-label">Control</div>
        <button class="nav-tab" onclick="switchTab('capacidad')" id="tab-capacidad">Capacidad</button>
        <button class="nav-tab" onclick="switchTab('historico')" id="tab-historico">Hist√≥rico</button>
        <button class="nav-tab" onclick="switchTab('rendimiento')" id="tab-rendimiento">Rendimiento</button>
      </div>
    </div>
  </nav>
  <div class="header-actions">
    <a href="https://comercial-4xh.pages.dev/" class="btn btn-secondary btn-sm" style="text-decoration:none">‚Üê Comercial</a>
    <button class="dark-toggle" onclick="toggleDark()" title="Modo oscuro/claro">‚óê</button>
  </div>
</div>

<div class="container">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: MECANIZADO (CNC CX100)          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-mecanizado">

  <!-- Sub-tab navigation -->
  <div style="display:flex;gap:4px;margin-bottom:16px;background:var(--bg);border-radius:6px;padding:3px;width:fit-content">
    <button class="nav-tab active" onclick="switchMecSub('tracking')" id="mec-tracking">Tracking</button>
    <button class="nav-tab" onclick="switchMecSub('dia')" id="mec-dia">D√≠a CNC</button>
  </div>

  <!-- SUB: Tracking -->
  <div id="mec-panel-tracking">
  <div class="metrics-row" id="trackMetrics">
    <div class="metric-card"><div class="metric-label">Proyectos activos</div><div class="metric-value" id="tProjects">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas mecanizadas</div><div class="metric-value" id="tPieces">‚Äî</div><div class="metric-sub" id="tPiecesSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo total CNC</div><div class="metric-value" id="tTime">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas MobCloud √∫nicas</div><div class="metric-value" id="tMobParts">‚Äî</div><div class="metric-sub">con ID num√©rico</div></div>
  </div>

  <div class="card">
    <div class="card-title">
      Tracking por servicio MobCloud
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-3);cursor:pointer;margin-left:12px">
        <input type="checkbox" id="trackOnlyProd" checked onchange="renderTrackProjects();renderTrackMetrics()"> Solo en producci√≥n
      </label>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end;">
        <div class="form-group" style="margin-bottom:0">
          <label>Desde</label>
          <input type="date" id="trackFrom" onchange="loadTracking()" style="width:150px">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label>Hasta</label>
          <input type="date" id="trackTo" onchange="loadTracking()" style="width:150px">
        </div>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('week')">7d</button>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('month')">30d</button>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('all')">Todo</button>
      </div>
    </div>
    <div id="trackProjectCards" class="empty">Cargando...</div>
  </div>

  <div class="card">
    <div class="card-title">
      Piezas MobCloud detectadas
      <span class="badge" id="trackPartsBadge">0</span>
      <div style="margin-left:auto">
        <input type="text" id="trackPartSearch" placeholder="Buscar part ID..." oninput="renderTrackParts()" style="width:180px;padding:5px 8px;font-size:12px">
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-3);margin-bottom:12px">Piezas con ID num√©rico (MobCloud) ‚Äî muestra el servicio MobCloud al que pertenecen cuando los datos est√°n sincronizados.</p>
    <div class="table-wrap" style="max-height:500px;overflow-y:auto">
      <table class="cycle-table">
        <thead>
          <tr>
            <th>MobCloud Part ID</th>
            <th>Servicio / Proyecto</th>
            <th style="text-align:right">Repeticiones</th>
            <th style="text-align:right">Tiempo total</th>
            <th style="text-align:right">Promedio</th>
            <th>Primera vez</th>
            <th>√öltima vez</th>
          </tr>
        </thead>
        <tbody id="trackPartsBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- end mec-panel-tracking -->

  <!-- SUB: D√≠a CNC -->
  <div id="mec-panel-dia" style="display:none">
  <div class="filter-bar" style="margin-bottom:16px">
    <div class="form-group" style="flex:0 0 180px">
      <label>Fecha</label>
      <input type="date" id="dayDate" onchange="loadDayData()">
    </div>
    <button class="btn btn-sm btn-secondary" onclick="setDayToday()">Hoy</button>
    <button class="btn btn-sm btn-secondary" onclick="shiftDay(-1)">‚Üê Ayer</button>
    <button class="btn btn-sm btn-secondary" onclick="shiftDay(1)">Ma√±ana ‚Üí</button>
  </div>

  <div class="metrics-row" id="dayMetrics">
    <div class="metric-card"><div class="metric-label">Piezas completadas</div><div class="metric-value" id="dPieces">‚Äî</div><div class="metric-sub" id="dPiecesSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo mecanizado</div><div class="metric-value" id="dTime">‚Äî</div><div class="metric-sub" id="dTimeSub"></div></div>
    <div class="metric-card"><div class="metric-label">Promedio / pieza</div><div class="metric-value" id="dAvg">‚Äî</div><div class="metric-sub" id="dAvgSub"></div></div>
    <div class="metric-card"><div class="metric-label">Utilizaci√≥n</div><div class="metric-value" id="dUtil">‚Äî</div></div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
    <div class="card">
      <div class="card-title">Timeline</div>
      <div class="timeline-container" id="dayTimeline"></div>
    </div>
    <div class="card">
      <div class="card-title">Distribuci√≥n de ciclos</div>
      <div class="hist-wrap" id="dayHistogram"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Ciclos del d√≠a <span class="badge" id="dayCycleCount">0</span></div>
    <div class="filter-bar">
      <div class="form-group" style="flex:0 0 200px">
        <label>Buscar pieza</label>
        <input type="text" id="dayCycleSearch" placeholder="Nombre o ID..." oninput="renderDayCycles()">
      </div>
      <div class="form-group" style="flex:0 0 140px">
        <label>Estado</label>
        <select id="dayCycleFilter" onchange="renderDayCycles()">
          <option value="">Todos</option>
          <option value="completed">Completados</option>
          <option value="interrupted">Interrumpidos</option>
        </select>
      </div>
    </div>
    <div class="table-wrap" style="max-height:400px; overflow-y:auto;">
      <table class="cycle-table">
        <thead>
          <tr>
            <th style="width:30px"></th>
            <th>Pieza</th>
            <th>Proyecto</th>
            <th style="text-align:right">Duraci√≥n</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>MobCloud ID</th>
          </tr>
        </thead>
        <tbody id="dayCyclesBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- end mec-panel-dia -->

</div><!-- end panel-mecanizado -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 1: COLA DE PRODUCCI√ìN                  -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="panel-cola">

  <div class="metrics-row" id="queueMetrics">
    <div class="metric-card"><div class="metric-label">Pendientes</div><div class="metric-value" id="mPending">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">En proceso</div><div class="metric-value" id="mInProgress">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas CNC pendientes</div><div class="metric-value" id="mPiecesPending">‚Äî</div><div class="metric-sub" id="mPiecesPendingSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo CNC estimado</div><div class="metric-value" id="mTimePending">‚Äî</div><div class="metric-sub" id="mTimePendingSub"></div></div>
  </div>

  <div class="card">
    <div class="card-title">
      Cola de producci√≥n
      <span class="badge" id="queueCount">0</span>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn btn-sm btn-secondary" onclick="recalcAll()">‚Üª Recalcular CNC</button>
        <button class="btn btn-sm btn-primary" onclick="showAddModal()">+ Agregar servicio</button>
        <button class="btn btn-sm btn-success" onclick="showAddFromQuoteModal()">+ Desde cotizaci√≥n</button>
      </div>
    </div>
    
    <div class="filter-bar">
      <div class="form-group" style="flex:0 0 160px">
        <label>Estado</label>
        <select id="queueFilter" onchange="renderQueue()">
          <option value="">Todos</option>
          <option value="pending" selected>Pendientes</option>
          <option value="in_progress">En proceso</option>
          <option value="completed">Completados</option>
          <option value="on_hold">En espera</option>
        </select>
      </div>
      <div class="form-group" style="flex:0 0 160px">
        <label>Buscar</label>
        <input type="text" id="queueSearch" placeholder="Nombre, cliente..." oninput="renderQueue()">
      </div>
    </div>

    <div class="table-wrap">
      <table class="queue-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Servicio</th>
            <th style="text-align:center;min-width:60px"><div>‚úÇ Corte</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>‚ñ§ Enchape</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>‚öô CNC</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>üì¶ Packing</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
    <div class="empty" id="queueEmpty" style="display:none">No hay servicios en la cola</div>
  </div>
</div>

<!-- (D√≠a content merged into panel-mecanizado) -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 3: HIST√ìRICO                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-historico">
  <div class="metrics-row" id="histMetrics">
    <div class="metric-card"><div class="metric-label">D√≠as registrados</div><div class="metric-value" id="hDays">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Total piezas</div><div class="metric-value" id="hPieces">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Promedio/d√≠a</div><div class="metric-value" id="hAvgDay">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Promedio/pieza global</div><div class="metric-value" id="hAvgCycle">‚Äî</div></div>
  </div>

  <div class="card">
    <div class="card-title">Producci√≥n diaria (√∫ltimos 30 d√≠as)</div>
    <div class="day-bars" id="histBars" style="height:140px"></div>
    <div style="display:flex; justify-content:space-between; margin-top:12px; font-size:12px; color:var(--text-3);">
      <span>Click en un d√≠a para ver detalle</span>
      <span id="histSummary"></span>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Detalle por d√≠a</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th style="text-align:right">Completadas</th>
            <th style="text-align:right">Interrumpidas</th>
            <th style="text-align:right">Tiempo total</th>
            <th style="text-align:right">Promedio</th>
            <th style="text-align:right">Mediana</th>
            <th style="text-align:right">Utilizaci√≥n</th>
            <th>Rango</th>
          </tr>
        </thead>
        <tbody id="histTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 4: CAPACIDAD                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-capacidad">
  <div class="metrics-row">
    <div class="metric-card"><div class="metric-label">Capacidad CNC/d√≠a</div><div class="metric-value" id="capPieces">‚Äî</div><div class="metric-sub">piezas promedio</div></div>
    <div class="metric-card"><div class="metric-label">Mecanizado efectivo/d√≠a</div><div class="metric-value" id="capTime">‚Äî</div><div class="metric-sub" id="capTimeSub"></div></div>
    <div class="metric-card"><div class="metric-label">Promedio ciclo</div><div class="metric-value" id="capCycle">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Utilizaci√≥n promedio</div><div class="metric-value" id="capUtil">‚Äî</div></div>
  </div>

  <div class="cap-summary">
    <div class="card">
      <div class="card-title">Carga pendiente en CNC</div>
      <div class="cap-block" id="capQueueBlock">
        <div class="empty">Cargando...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Estimaci√≥n de capacidad</div>
      <div class="cap-block" id="capEstBlock">
        <div class="empty">Cargando...</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:20px">
    <div class="card-title">Estimaci√≥n vs Realidad</div>
    <p style="font-size:13px; color:var(--text-2); margin-bottom:12px;">Comparaci√≥n entre la estimaci√≥n fija (80s/pieza) y los datos reales de la CNC, basado en el hist√≥rico completo.</p>
    <div id="capComparison"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: PACKING                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-packing">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
    <div>
      <h3 style="font-size:18px;font-weight:700;margin:0">Control Pre Packing</h3>
      <p style="font-size:13px;color:var(--text-2);margin-top:2px">Verificaci√≥n de piezas por servicio antes del embalaje</p>
    </div>
    <a href="prepacking.html" target="_blank" class="btn btn-primary" style="text-decoration:none;font-size:14px;padding:10px 20px">
      ‚Üó Abrir Esc√°ner (ventana completa)
    </a>
  </div>

  <div class="metrics-row" id="ppMetrics">
    <div class="metric-card"><div class="metric-label">En producci√≥n (MobCloud)</div><div class="metric-value" id="ppServices">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Scan en proceso</div><div class="metric-value" id="ppInProgress">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Completos</div><div class="metric-value" id="ppComplete">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Scans hoy</div><div class="metric-value" id="ppToday">‚Äî</div></div>
  </div>

  <div class="card">
    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
      Estado por servicio
      <button class="btn btn-sm btn-secondary" onclick="loadPrePacking()">‚Üª Actualizar</button>
    </div>
    <div class="table-wrap" style="max-height:500px;overflow-y:auto">
      <table class="queue-table">
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Cliente</th>
            <th style="text-align:center">Esperadas</th>
            <th style="text-align:center">Escaneadas</th>
            <th style="text-align:center">Faltantes</th>
            <th>Progreso</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="ppBody"></tbody>
      </table>
    </div>
    <div class="empty" id="ppEmpty" style="display:none">No hay servicios en producci√≥n, o no se pudo conectar con MobCloud.</div>
  </div>
</div>

</div><!-- /container -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: CORTE ‚Äî SCM Seccionadora          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-corte">
<div class="container">

  <!-- Sub-tab navigation -->
  <div style="display:flex;gap:4px;margin-bottom:16px;background:var(--bg);border-radius:6px;padding:3px;width:fit-content">
    <button class="nav-tab active" onclick="switchCorteSub('hoy')" id="corte-hoy">Hoy en vivo</button>
    <button class="nav-tab" onclick="switchCorteSub('servicios')" id="corte-servicios">Servicios</button>
    <button class="nav-tab" onclick="switchCorteSub('tendencia')" id="corte-tendencia">Tendencia</button>
    <button class="nav-tab" onclick="switchCorteSub('prep')" id="corte-prep">üì¶ Prep Material</button>
    <button class="nav-tab" onclick="switchCorteSub('analytics')" id="corte-analytics">ü§ñ Analytics IA</button>
  </div>

  <!-- SUB: HOY EN VIVO -->
  <div id="corte-panel-hoy">

    <!-- KPIs + Sem√°foro -->
    <div class="metrics-row" style="grid-template-columns:auto 1fr 1fr 1fr 1fr 1fr">
      <div class="metric-card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:100px">
        <div class="semaforo" id="cSemaforo">‚Äî</div>
        <div style="font-size:10px;color:var(--text-3);text-align:center" id="cSemaforoLabel">cargando...</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Placas hoy</div>
        <div class="metric-value" id="cPlacasHoy">‚Äî</div>
        <div class="metric-sub" id="cPlacasHoySub"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Primer corte</div>
        <div class="metric-value" id="cPrimerCorte">‚Äî</div>
        <div class="metric-sub" id="cPrimerCorteSub"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Min / placa</div>
        <div class="metric-value" id="cMinPlaca">‚Äî</div>
        <div class="metric-sub">tiempo promedio</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">√öltimo corte</div>
        <div class="metric-value" id="cUltimoCorte">‚Äî</div>
        <div class="metric-sub" id="cUltimoCorteSub"></div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Minutos corte</div>
        <div class="metric-value" id="cMinutosCorte">‚Äî</div>
        <div class="metric-sub" id="cMinutosCorteSub"></div>
      </div>
    </div>

    <!-- Utilizaci√≥n + Ritmo + Proyecci√≥n -->
    <div class="metrics-row" style="grid-template-columns:1fr 1fr 1fr">
      <div class="metric-card">
        <div class="metric-label">Utilizaci√≥n efectiva</div>
        <div class="metric-value" id="cUtilPct">‚Äî</div>
        <div style="height:10px;background:var(--border);border-radius:99px;overflow:hidden;margin-top:8px;position:relative">
          <div style="position:absolute;top:0;left:0;height:100%;background:rgba(234,179,8,.35);border-radius:99px;transition:width .4s" id="cElapsedBar"></div>
          <div style="position:absolute;top:0;left:0;height:100%;background:var(--accent);border-radius:99px;transition:width .4s" id="cUtilBar"></div>
        </div>
        <div class="metric-sub" style="display:flex;justify-content:space-between;margin-top:4px">
          <span id="cUtilDetail">‚Äî</span>
          <span id="cGapDetail">‚Äî</span>
        </div>
      </div>
      <div class="metric-card" id="cPaceCard">
        <div class="metric-label">Ritmo vs objetivo</div>
        <div class="metric-value" id="cPaceValue">‚Äî</div>
        <div class="metric-sub">Esperado: <span id="cExpected">‚Äî</span> placas</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Proyecci√≥n cierre</div>
        <div class="metric-value" id="cForecast">‚Äî</div>
        <div class="metric-sub">si mantiene el ritmo actual</div>
      </div>
    </div>

    <!-- Barras por hora + baseline -->
    <div class="card">
      <div class="card-title">
        Producci√≥n por hora ‚Äî hoy
        <span style="font-size:11px;color:var(--text-3);margin-left:8px">
          <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent);vertical-align:middle;margin-right:3px"></span>baseline 30d
        </span>
        <span style="font-size:11px;color:var(--text-3);margin-left:12px">
          <span style="display:inline-block;width:8px;height:4px;border-radius:2px;background:#22c55e;vertical-align:middle;margin-right:3px"></span>‚â• baseline
          <span style="display:inline-block;width:8px;height:4px;border-radius:2px;background:#eab308;vertical-align:middle;margin-left:6px;margin-right:3px"></span>50-99%
          <span style="display:inline-block;width:8px;height:4px;border-radius:2px;background:#ef4444;vertical-align:middle;margin-left:6px;margin-right:3px"></span>&lt;50%
        </span>
        <div style="margin-left:auto">
          <button class="btn btn-sm btn-secondary" onclick="loadCorte()">‚Üª Actualizar</button>
        </div>
      </div>
      <div class="hourly-chart" id="cHourlyChart">
        <div class="empty" style="width:100%">Cargando datos de seccionadora...</div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-3);margin-top:8px">
        <span id="cChartSummary"></span>
        <span>Target: <strong id="cTarget">‚Äî</strong> placas/d√≠a</span>
      </div>
    </div>

    <!-- √öltimos cortes (tabla reciente) -->
    <div class="card">
      <div class="card-title">√öltimos eventos de corte <span class="badge" id="cRecentCount">0</span></div>
      <div class="table-wrap" style="max-height:300px;overflow-y:auto">
        <table class="cycle-table">
          <thead>
            <tr>
              <th>Inicio</th>
              <th style="text-align:right">Duraci√≥n</th>
              <th style="text-align:right">Placas</th>
              <th>Programa</th>
              <th>Archivo</th>
            </tr>
          </thead>
          <tbody id="cRecentBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- end corte-panel-hoy -->

  <!-- SUB: SERVICIOS PENDIENTES -->
  <div id="corte-panel-servicios" style="display:none">

    <div class="metrics-row">
      <div class="metric-card"><div class="metric-label">Servicios en cola</div><div class="metric-value" id="cqTotal">‚Äî</div></div>
      <div class="metric-card"><div class="metric-label">Tiempo corte total</div><div class="metric-value" id="cqTime">‚Äî</div><div class="metric-sub">estimado MobCloud</div></div>
      <div class="metric-card"><div class="metric-label">Cortados (MobCloud)</div><div class="metric-value" id="cqDone">‚Äî</div></div>
      <div class="metric-card"><div class="metric-label">Pendientes corte</div><div class="metric-value" id="cqPending">‚Äî</div></div>
    </div>

    <div class="card">
      <div class="card-title">Servicios pendientes de corte</div>
      <p style="color:var(--text-3);font-size:12px;margin-bottom:12px">
        Estado manual (MobCloud/Alan). A√∫n no vinculado autom√°ticamente con los eventos de la seccionadora.
      </p>
      <div class="table-wrap">
        <table class="queue-table">
          <thead><tr><th>#</th><th>Servicio</th><th>Cliente</th><th style="text-align:right">Tiempo corte est.</th><th style="text-align:center">Estado</th></tr></thead>
          <tbody id="corteBody"></tbody>
        </table>
      </div>
    </div>

  </div><!-- end corte-panel-servicios -->

  <!-- SUB: TENDENCIA 30 D√çAS -->
  <div id="corte-panel-tendencia" style="display:none">

    <div class="metrics-row">
      <div class="metric-card"><div class="metric-label">D√≠as registrados</div><div class="metric-value" id="ctDays">‚Äî</div></div>
      <div class="metric-card"><div class="metric-label">Total placas</div><div class="metric-value" id="ctTotal">‚Äî</div></div>
      <div class="metric-card"><div class="metric-label">Promedio/d√≠a</div><div class="metric-value" id="ctAvgDay">‚Äî</div></div>
      <div class="metric-card"><div class="metric-label">Mejor d√≠a</div><div class="metric-value" id="ctBestDay">‚Äî</div><div class="metric-sub" id="ctBestDaySub"></div></div>
    </div>

    <div class="card">
      <div class="card-title">Producci√≥n diaria ‚Äî √∫ltimos 30 d√≠as</div>
      <div class="day-bars" id="ctDailyBars" style="height:140px"></div>
      <div style="display:flex;justify-content:space-between;margin-top:12px;font-size:12px;color:var(--text-3)">
        <span>Placas cortadas por d√≠a</span>
        <span id="ctDailySummary"></span>
      </div>
    </div>

  </div><!-- end corte-panel-tendencia -->

  <!-- SUB: PREP MATERIAL -->
  <div id="corte-panel-prep" style="display:none">

    <div class="card">
      <div class="card-title">üì¶ Preparar material para corte</div>
      <p style="font-size:12px;color:var(--text-2);margin:0 0 12px">
        Seleccion√° los proyectos que van a corte ma√±ana. El sistema calcula las placas por espesor y el orden de apilado por proyecto.
      </p>

      <!-- Service selector -->
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
        <label style="font-size:12px;font-weight:600">Fecha de corte:</label>
        <input type="date" id="prepDate" style="padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;background:var(--surface);color:var(--text)">
        <button class="btn btn-primary btn-sm" onclick="calcPrepMaterial()">Calcular materiales</button>
        <button class="btn btn-secondary btn-sm" onclick="toggleAllPrep()" id="prepToggleBtn">Seleccionar todos</button>
      </div>

      <div id="prepServiceList" style="max-height:320px;overflow-y:auto;border:1px solid var(--border);border-radius:var(--radius);padding:8px">
        <div class="empty">Cargando cola de producci√≥n...</div>
      </div>
    </div>

    <!-- Results -->
    <div id="prepResults" style="display:none">

      <!-- Summary KPIs -->
      <div class="metrics-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="metric-card">
          <div class="metric-label">Proyectos</div>
          <div class="metric-value" id="prepProjects">0</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total placas</div>
          <div class="metric-value" id="prepTotalBoards">0</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Espesores distintos</div>
          <div class="metric-value" id="prepThicknesses">0</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Cortes estimados</div>
          <div class="metric-value" id="prepCuts">0</div>
        </div>
      </div>

      <!-- Stacking order: per project, then by thickness -->
      <div class="card">
        <div class="card-title">üèóÔ∏è Orden de apilado (por proyecto)</div>
        <p style="font-size:11px;color:var(--text-3);margin:0 0 10px">
          Apilar en este orden: primero el √∫ltimo proyecto (queda abajo), √∫ltimo el primero (queda arriba, se corta primero).
        </p>
        <div id="prepStackOrder"></div>
      </div>

      <!-- Global totals by thickness -->
      <div class="card">
        <div class="card-title">üìä Resumen total por espesor</div>
        <table class="queue-table" style="font-size:12px">
          <thead>
            <tr><th>Espesor</th><th>Descripci√≥n</th><th style="text-align:right">Placas</th><th style="text-align:right">Proyectos</th></tr>
          </thead>
          <tbody id="prepThicknessTable"></tbody>
          <tfoot id="prepThicknessFoot" style="font-weight:700;border-top:2px solid var(--border)"></tfoot>
        </table>
      </div>

      <!-- Print button -->
      <div style="text-align:center;margin-top:12px">
        <button class="btn btn-secondary" onclick="printPrepMaterial()">üñ®Ô∏è Imprimir lista de materiales</button>
      </div>

    </div><!-- end prepResults -->

  </div><!-- end corte-panel-prep -->

  <!-- SUB: ANALYTICS IA -->
  <div id="corte-panel-analytics" style="display:none">

    <!-- Loading state -->
    <div id="caLoading" class="analytics-loading">
      <div class="spinner" style="display:inline-block"></div>
      <div>Consultando agente de analytics...</div>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="caContent" style="display:none">

      <!-- AI Executive Summary -->
      <div class="ai-summary" id="caSummary">
        <div class="ai-badge">ü§ñ An√°lisis IA</div>
        <p id="caSummaryText">‚Äî</p>
      </div>

      <!-- KPI Cards Row -->
      <div class="metrics-row" style="grid-template-columns:repeat(6,1fr)">
        <div class="metric-card">
          <div class="metric-label">Promedio 2026</div>
          <div class="metric-value" id="caAvg2026">‚Äî</div>
          <div class="metric-sub"><span class="kpi-change" id="caYoyChange">‚Äî</span> vs 2025</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">R√©cord</div>
          <div class="metric-value" id="caRecord">‚Äî</div>
          <div class="metric-sub" id="caRecordSub">placas/d√≠a</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Utilizaci√≥n</div>
          <div class="metric-value" id="caUtil">‚Äî</div>
          <div class="metric-sub"><span class="kpi-change" id="caUtilChange">‚Äî</span> vs 2025</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Demora arranque</div>
          <div class="metric-value" id="caDelay">‚Äî</div>
          <div class="metric-sub"><span class="kpi-change" id="caDelaySub">‚Äî</span></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Mejor d√≠a</div>
          <div class="metric-value" id="caBestDay">‚Äî</div>
          <div class="metric-sub" id="caBestDayAvg">‚Äî</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">√öltimos 7 d√≠as</div>
          <div class="metric-value" id="caRecent7">‚Äî</div>
          <div class="metric-sub">promedio</div>
        </div>
      </div>

      <!-- Alertas activas -->
      <div class="card" id="caAlertsCard" style="display:none">
        <div class="card-title">‚ö†Ô∏è Alertas activas <span class="badge" id="caAlertsBadge">0</span></div>
        <div id="caAlertsList"></div>
      </div>

      <!-- Patrones ocultos -->
      <div class="card">
        <div class="card-title">üîç Patrones ocultos detectados</div>
        <div class="insight-grid" id="caPatterns"></div>
      </div>

      <!-- Correlaciones -->
      <div class="card">
        <div class="card-title">üìä Correlaciones clave</div>
        <div id="caCorrelations"></div>
      </div>

      <!-- Recomendaciones -->
      <div class="card">
        <div class="card-title">üéØ Recomendaciones priorizadas</div>
        <div class="rec-list" id="caRecommendations"></div>
      </div>

      <!-- Anomal√≠as -->
      <div class="card">
        <div class="card-title">üö® Anomal√≠as detectadas</div>
        <div id="caAnomalies"></div>
      </div>

      <!-- Risks & Opportunities -->
      <div class="insight-grid">
        <div class="card" style="margin-bottom:0">
          <div class="card-title">‚ö° Oportunidades</div>
          <ul id="caOpportunities" style="list-style:none;padding:0;font-size:13px;color:var(--text-2)"></ul>
        </div>
        <div class="card" style="margin-bottom:0">
          <div class="card-title">‚ö†Ô∏è Riesgos</div>
          <ul id="caRisks" style="list-style:none;padding:0;font-size:13px;color:var(--text-2)"></ul>
        </div>
      </div>

      <!-- Action buttons -->
      <div style="text-align:center;margin-top:16px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="loadCorteAnalytics(true)" id="caRefreshBtn">
          üîÑ Actualizar an√°lisis (usa cr√©ditos AI)
        </button>
        <button class="btn btn-primary" onclick="generateAnalyticsPDF()">
          üìÑ Reporte PDF
        </button>
        <button class="btn btn-primary" onclick="generateBothPDFs()" style="background:var(--success)">
          üìÑ‚úâÔ∏è Reporte + Narrativa
        </button>
        <button class="btn btn-secondary" onclick="printAnalytics()">
          üñ®Ô∏è Imprimir
        </button>
      </div>
      <div style="font-size:11px;color:var(--text-3);margin-top:6px;text-align:center" id="caTimestamp">‚Äî</div>

    </div><!-- end caContent -->
  </div><!-- end corte-panel-analytics -->

</div><!-- container -->
</div><!-- end panel-corte -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: ENCHAPE                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-enchape">
<div class="container">
  <div class="metrics-row">
    <div class="metric-card"><div class="metric-label">Servicios en cola</div><div class="metric-value" id="eqTotal">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Metros tapacanto</div><div class="metric-value" id="eqMeters">‚Äî</div><div class="metric-sub">estimados</div></div>
    <div class="metric-card"><div class="metric-label">Tiempo enchape</div><div class="metric-value" id="eqTime">‚Äî</div><div class="metric-sub">a 7 m/min</div></div>
    <div class="metric-card"><div class="metric-label">Enchapados (MobCloud)</div><div class="metric-value" id="eqDone">‚Äî</div></div>
  </div>
  <div class="card">
    <div class="card-title">‚ñ§ Estaci√≥n de Enchape ‚Äî Enchapadora</div>
    <p style="color:var(--text-3);font-size:13px;margin-bottom:16px">
      Vista de enchape por servicio. Los metros de tapacanto se estiman de los lados con borde de cada pieza.
      <br>Futuro: integraci√≥n directa con enchapadora para tracking en tiempo real.
    </p>
    <div class="table-wrap">
      <table class="queue-table">
        <thead><tr><th>#</th><th>Servicio</th><th>Cliente</th><th style="text-align:right">Lados</th><th style="text-align:right">Metros est.</th><th style="text-align:right">Tiempo est.</th><th style="text-align:center">Estado MobCloud</th></tr></thead>
        <tbody id="enchapeBody"></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- CONTROL: RENDIMIENTO                       -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-rendimiento">
<div class="container">
  <div class="card">
    <div class="card-title">Rendimiento ‚Äî Estimado vs Real por estaci√≥n</div>
    <p style="color:var(--text-3);font-size:13px;margin-bottom:16px">
      Comparaci√≥n de tiempos estimados vs reales para cada estaci√≥n de producci√≥n.
      <br>Actualmente solo disponible para Mecanizado CNC (datos reales de ciclos).
    </p>
    <div id="rendimientoContent">
      <div class="empty">Cargando datos de rendimiento...</div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="addModal">
  <div class="modal">
    <h3>Agregar servicio a la cola</h3>
    <div class="form-row">
      <div class="form-group"><label>Service ID (MobCloud)</label><input type="number" id="mServiceId"></div>
      <div class="form-group"><label>Nombre</label><input type="text" id="mServiceName" placeholder="Ej: Cocina L√≥pez"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Cliente</label><input type="text" id="mClientName"></div>
      <div class="form-group"><label>Fecha programada</label><input type="date" id="mScheduledDate"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Descripci√≥n</label><input type="text" id="mDescription" placeholder="Notas..."></div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('addModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="addManualService()">Agregar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="quoteModal">
  <div class="modal">
    <h3>Agregar desde cotizaci√≥n aceptada</h3>
    <p style="font-size:13px; color:var(--text-2); margin-bottom:14px;">Seleccion√° una cotizaci√≥n aceptada para agregar sus servicios a la cola de producci√≥n.</p>
    <div id="quoteList" class="empty">Cargando cotizaciones...</div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('quoteModal')">Cerrar</button>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner" style="width:32px;height:32px;border-width:3px"></div>
  <span id="loadingText" style="color:var(--text-2);font-size:14px">Cargando...</span>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = "https://qnjizqowddtvzzfillmo.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFuaml6cW93ZGR0dnp6ZmlsbG1vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDY2NzUsImV4cCI6MjA4NTQ4MjY3NX0.5P0nSzjO8Y3N-0RFTKcoS5G-ntF0OUixGMOkPqGUHc4";
const APP_KEY = "";
const MACHINE_ID = "cx100";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const qs = s => document.querySelector(s);
const qa = s => document.querySelectorAll(s);

function fmtSec(s) { if (s==null) return "‚Äî"; s=Math.round(s); return s>=60?`${Math.floor(s/60)}m ${s%60}s`:`${s}s`; }
function fmtMin(s) { if (s==null) return "‚Äî"; const m=Math.round(s/60); return m>=60?`${Math.floor(m/60)}h ${m%60}m`:`${m} min`; }
function fmtMinFromMin(m) { if (m==null) return "‚Äî"; m=Math.round(m); return m>=60?`${Math.floor(m/60)}h ${m%60}m`:`${m} min`; }
function fmtTime(iso) { if (!iso) return "‚Äî"; return new Date(iso).toLocaleTimeString("es-UY",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false}); }
function fmtTimeShort(iso) { if (!iso) return ""; return new Date(iso).toLocaleTimeString("es-UY",{hour:"2-digit",minute:"2-digit",hour12:false}); }
function cleanName(n) { return (n||"").replace(/^\[J\]\s*/,""); }
function todayStr() { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function escH(s) { return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;"); }

const DAY_NAMES = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];

async function sbQuery(table, params="") {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, {
    headers: { "apikey":SUPABASE_ANON, "Authorization":`Bearer ${SUPABASE_ANON}`, "Accept":"application/json" }
  });
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

async function sbRpc(fn, params={}) {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${fn}`, {
    method: "POST",
    headers: { "Content-Type":"application/json", "apikey":SUPABASE_ANON, "Authorization":`Bearer ${SUPABASE_ANON}`, "Accept":"application/json" },
    body: JSON.stringify(params)
  });
  if (!r.ok) throw new Error(`RPC ${fn}: ${r.status} ${r.statusText}`);
  return r.json();
}

async function invokeFunction(name, payload) {
  const r = await fetch(`${SUPABASE_URL}/functions/v1/${name}`, {
    method:"POST",
    headers: { "Content-Type":"application/json", "apikey":SUPABASE_ANON, "Authorization":`Bearer ${SUPABASE_ANON}` },
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || data.message || r.statusText);
  return data;
}

function toast(msg, type="info") {
  const t = document.createElement("div");
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  qs("#toastContainer").appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function showLoading(msg="Cargando...") { qs("#loadingText").textContent=msg; qs("#loadingOverlay").classList.add("active"); }
function hideLoading() { qs("#loadingOverlay").classList.remove("active"); }
function showModal(id) { document.getElementById(id).classList.add("active"); }
function closeModal(id) { document.getElementById(id).classList.remove("active"); }

function toggleDark() {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", document.documentElement.classList.contains("dark"));
}
if (localStorage.getItem("dark")==="true") document.documentElement.classList.add("dark");

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab = "cola";
const ESTACIONES_TABS = ["corte","enchape","mecanizado","packing"];
const CONTROL_TABS = ["capacidad","historico","rendimiento"];

function switchTab(tab) {
  currentTab = tab;
  // Deactivate all tabs and panels
  qa(".nav-tab").forEach(t => t.classList.remove("active"));
  qa(".tab-panel").forEach(p => p.classList.remove("active"));
  
  // Activate the clicked tab button
  const tabBtn = qs(`#tab-${tab}`);
  if (tabBtn) tabBtn.classList.add("active");
  
  // Highlight parent dropdown label
  if (ESTACIONES_TABS.includes(tab)) {
    qs("#tab-estaciones").classList.add("active");
  } else if (CONTROL_TABS.includes(tab)) {
    qs("#tab-control").classList.add("active");
  }
  
  // Show panel ‚Äî D√≠a is a sub-section of mecanizado, handle separately  
  const panel = qs(`#panel-${tab}`);
  if (panel) panel.classList.add("active");
  
  // Load data for the tab
  const loaders = {
    cola: loadQueue,
    corte: loadCorte,
    enchape: loadEnchape,
    mecanizado: loadTracking,
    packing: loadPrePacking,
    capacidad: loadCapacity,
    historico: loadHistorical,
    rendimiento: loadRendimiento,
  };
  if (loaders[tab]) loaders[tab]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MECANIZADO SUB-TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMecSub(sub) {
  ["tracking","dia"].forEach(s => {
    const p = qs(`#mec-panel-${s}`);
    const t = qs(`#mec-${s}`);
    if (p) p.style.display = s === sub ? "" : "none";
    if (t) t.classList.toggle("active", s === sub);
  });
  if (sub === "dia") loadDayData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTACI√ìN: CORTE ‚Äî SCM Seccionadora
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CORTE_MACHINE = "CORTE_1";
const JORNADA_HORAS = [7,8,9,10,11,12,13,14,15,16]; // 7:30‚Äì17:00

let corteKpi = null;
let corteHourly = [];
let corteBaseline = [];
let corteDaily = [];

function switchCorteSub(sub) {
  ["hoy","servicios","tendencia","prep","analytics"].forEach(s => {
    const p = qs(`#corte-panel-${s}`);
    const t = qs(`#corte-${s}`);
    if (p) p.style.display = s === sub ? "" : "none";
    if (t) t.classList.toggle("active", s === sub);
  });
  if (sub === "servicios") loadCorteServicios();
  if (sub === "tendencia") loadCorteTendencia();
  if (sub === "prep") loadPrepPanel();
  if (sub === "analytics") loadCorteAnalytics();
}

async function loadCorte() {
  let kpiOk = false, hourlyOk = false, baselineOk = false, recentOk = false;
  
  // 1) KPIs
  try {
    const kpiArr = await sbRpc("fn_kpi_live", { p_machine_id: CORTE_MACHINE });
    corteKpi = Array.isArray(kpiArr) ? kpiArr[0] : kpiArr;
    kpiOk = true;
    console.log("[Corte] KPIs:", corteKpi);
  } catch(e) {
    console.error("[Corte] fn_kpi_live failed:", e.message);
    toast("Corte KPIs: " + e.message, "error");
  }
  
  // 2) Hourly
  try {
    corteHourly = await sbRpc("fn_hourly_today", { p_machine_id: CORTE_MACHINE }) || [];
    hourlyOk = true;
    console.log("[Corte] Hourly:", corteHourly.length, "rows");
  } catch(e) {
    console.error("[Corte] fn_hourly_today failed:", e.message);
    corteHourly = [];
  }
  
  // 3) Baseline
  try {
    corteBaseline = await sbRpc("fn_hourly_baseline", { p_machine_id: CORTE_MACHINE, p_days: 30 }) || [];
    baselineOk = true;
    console.log("[Corte] Baseline:", corteBaseline.length, "rows");
  } catch(e) {
    console.error("[Corte] fn_hourly_baseline failed:", e.message);
    corteBaseline = [];
  }
  
  // 4) Recent events via RPC (fn_recent_cuts)
  let recent = [];
  try {
    recent = await sbRpc("fn_recent_cuts", { p_machine_id: CORTE_MACHINE, p_limit: 30 }) || [];
    recentOk = true;
    console.log("[Corte] Recent cuts:", recent.length);
  } catch(e) {
    console.warn("[Corte] fn_recent_cuts failed:", e.message);
    // Fallback: direct table query
    try {
      recent = await sbQuery("cortes_eventos", `machine_id=eq.${CORTE_MACHINE}&production_date=eq.${todayStr()}&order=data_inicio_local.desc&limit=30`);
      recentOk = true;
      console.log("[Corte] Recent via table:", recent.length);
    } catch(e2) {
      console.warn("[Corte] cortes_eventos query also failed:", e2.message);
    }
  }
  
  // Render what we have
  renderCorteKpis();
  if (hourlyOk || baselineOk) renderCorteHourly();
  renderCorteRecent(recent);
  
  // Status summary
  const status = [
    kpiOk ? "‚úì KPIs" : "‚úï KPIs",
    hourlyOk ? "‚úì Hourly" : "‚úï Hourly", 
    baselineOk ? "‚úì Baseline" : "‚úï Baseline",
    recentOk ? "‚úì Eventos" : "‚úï Eventos",
  ].join(" | ");
  console.log("[Corte] Status:", status);
  if (!kpiOk && !hourlyOk) toast("Corte: no se pudieron cargar los datos. Verificar RPCs.", "error");
}

function renderCorteKpis() {
  if (!corteKpi) {
    qs("#cSemaforo").textContent = "?";
    qs("#cSemaforo").className = "semaforo";
    qs("#cSemaforoLabel").textContent = "sin datos";
    return;
  }
  const k = corteKpi;

  // Sem√°foro ‚Äî handle SIN_DATOS
  const estado = k.estado || "SIN_DATOS";
  const estadoClass = (estado === "VERDE" || estado === "AMARILLO" || estado === "ROJO") ? estado : "";
  qs("#cSemaforo").textContent = estado === "VERDE" ? "‚úì" : estado === "AMARILLO" ? "!" : estado === "ROJO" ? "‚úï" : "‚Äî";
  qs("#cSemaforo").className = `semaforo ${estadoClass}`;
  qs("#cSemaforo").style.background = estadoClass ? "" : "var(--border)";
  qs("#cSemaforo").style.color = estadoClass ? "" : "var(--text-3)";
  qs("#cSemaforo").style.boxShadow = estadoClass ? "" : "none";
  const minDesde = k.min_desde_ultimo != null ? Math.max(0, k.min_desde_ultimo) : null;
  qs("#cSemaforoLabel").textContent = estado === "SIN_DATOS" ? "sin datos hoy" : minDesde != null ? (minDesde <= 0 ? "activo ahora" : `hace ${Math.round(minDesde)} min`) : "‚Äî";

  // KPIs
  qs("#cPlacasHoy").textContent = k.placas_hoy || 0;
  qs("#cPlacasHoySub").textContent = k.placas_ult_60 ? `${k.placas_ult_60} √∫lt. 60 min` : "";
  
  // Primer corte + demora arranque
  if (k.primer_corte_local) {
    const t = new Date(k.primer_corte_local);
    qs("#cPrimerCorte").textContent = t.toLocaleTimeString("es-UY", {hour:"2-digit",minute:"2-digit",hour12:false});
    const demora = k.demora_arranque_min;
    if (demora != null) {
      const dm = Math.round(demora);
      if (dm <= 0) {
        qs("#cPrimerCorteSub").innerHTML = `<span style="color:var(--success)">a tiempo ‚úì</span>`;
      } else if (dm <= 15) {
        qs("#cPrimerCorteSub").innerHTML = `<span style="color:#eab308">+${dm} min vs 7:30</span>`;
      } else {
        qs("#cPrimerCorteSub").innerHTML = `<span style="color:#ef4444">+${dm} min vs 7:30</span>`;
      }
    } else {
      qs("#cPrimerCorteSub").textContent = "";
    }
  } else {
    qs("#cPrimerCorte").textContent = "‚Äî";
    qs("#cPrimerCorteSub").textContent = "sin arranque";
  }
  
  qs("#cMinPlaca").textContent = k.min_por_placa ? `${Number(k.min_por_placa).toFixed(1)}‚Ä≤` : "‚Äî";
  
  // √öltimo corte
  if (k.ultimo_corte_local) {
    const t = new Date(k.ultimo_corte_local);
    qs("#cUltimoCorte").textContent = t.toLocaleTimeString("es-UY", {hour:"2-digit",minute:"2-digit",hour12:false});
  } else {
    qs("#cUltimoCorte").textContent = "‚Äî";
  }
  qs("#cUltimoCorteSub").textContent = minDesde != null && minDesde > 0 ? `hace ${Math.round(minDesde)} min` : (k.ultimo_corte_local ? "ahora" : "sin actividad");

  // Minutos corte
  const minCorte = Number(k.minutos_corte_hoy || 0);
  qs("#cMinutosCorte").textContent = minCorte > 0 ? `${Math.round(minCorte)}‚Ä≤` : "0‚Ä≤";
  qs("#cMinutosCorteSub").textContent = `${k.eventos_hoy || 0} eventos`;
  
  qs("#cTarget").textContent = k.target_plates || "‚Äî";
  
  // Utilizaci√≥n, Ritmo, Proyecci√≥n (same logic as TV dashboard)
  const target = Number(k.target_plates || 50);
  const mins = Number(k.minutos_corte_hoy || 0);
  const utilPct = Math.max(0, Math.min(100, (mins / 540) * 100));
  
  qs("#cUtilPct").textContent = utilPct.toFixed(1) + "%";
  qs("#cUtilBar").style.width = utilPct + "%";
  
  // Elapsed time in shift
  const now = new Date();
  const shiftStart = new Date(now); shiftStart.setHours(7, 30, 0, 0);
  let elapsedMin = Math.max(0, Math.min(540, (now - shiftStart) / 60000));
  const elapsedPct = (elapsedMin / 540) * 100;
  qs("#cElapsedBar").style.width = elapsedPct + "%";
  qs("#cUtilDetail").textContent = `${Math.round(mins)} / 540 min`;
  
  // Gap (idle time)
  const gap = Math.max(0, elapsedMin - mins);
  qs("#cGapDetail").textContent = gap > 0 ? `Brecha: ${Math.round(gap)} min` : "";
  
  // Pace vs target
  const expected = (elapsedMin / 540) * target;
  const diff = (k.placas_hoy || 0) - expected;
  const paceCard = qs("#cPaceCard");
  paceCard.style.borderLeft = diff >= 0 ? "3px solid var(--success)" : diff >= -5 ? "3px solid #eab308" : "3px solid #ef4444";
  qs("#cPaceValue").textContent = diff >= 0 ? `+${diff.toFixed(1)}` : diff.toFixed(1);
  qs("#cPaceValue").style.color = diff >= 0 ? "var(--success)" : diff >= -5 ? "#eab308" : "#ef4444";
  qs("#cExpected").textContent = expected.toFixed(1);
  
  // Forecast
  let forecast = 0;
  if (elapsedMin > 30) {
    forecast = ((k.placas_hoy || 0) / elapsedMin) * 540;
  }
  qs("#cForecast").textContent = forecast > 0 ? `${Math.round(forecast)} placas` : "‚Äî";
  qs("#cForecast").style.color = forecast >= target ? "var(--success)" : forecast >= target * 0.8 ? "#eab308" : "var(--text-2)";
}

function renderCorteHourly() {
  const chart = qs("#cHourlyChart");
  
  // Build hourly map ‚Äî hora_local is ISO timestamp like "2026-02-19T07:00:00"
  const hourMap = {};
  for (const h of corteHourly) {
    let hora = null;
    if (h.hora_local != null) {
      if (typeof h.hora_local === "string" && h.hora_local.includes("T")) {
        hora = new Date(h.hora_local).getHours();
      } else {
        hora = Number(h.hora_local);
      }
    }
    if (hora != null) hourMap[hora] = h.placas || 0;
  }
  
  // Build baseline map ‚Äî fields: hour_of_day, avg_plates
  const blMap = {};
  for (const b of corteBaseline) {
    const hora = b.hour_of_day != null ? Number(b.hour_of_day) : (b.hora_local != null ? Number(b.hora_local) : null);
    if (hora != null) blMap[hora] = Number(b.avg_plates || b.avg_placas || 0);
  }
  
  const now = new Date();
  const currentHour = now.getHours();
  
  // Find max for scaling
  const allVals = JORNADA_HORAS.map(h => Math.max(hourMap[h]||0, blMap[h]||0));
  const maxVal = Math.max(...allVals, 1);
  
  let totalHoy = 0;
  
  chart.innerHTML = JORNADA_HORAS.map(h => {
    const placas = hourMap[h] || 0;
    const bl = blMap[h] || 0;
    totalHoy += placas;
    const barH = Math.max(2, (placas / maxVal) * 120);
    const blH = bl > 0 ? Math.max(2, (bl / maxVal) * 120) : 0;
    
    // Color based on baseline comparison
    let barClass = "future";
    if (h < currentHour || (h === currentHour && placas > 0)) {
      if (bl <= 0 || placas >= bl) barClass = "high";
      else if (placas >= bl * 0.5) barClass = "mid";
      else barClass = "low";
    } else if (h === currentHour) {
      barClass = placas > 0 ? "mid" : "future";
    }
    
    return `
      <div class="hourly-col" title="${h}:00 ‚Äî ${placas} placas (baseline: ${bl.toFixed(1)})">
        <div class="hourly-cnt">${placas || ""}</div>
        <div style="position:relative;width:100%;flex:1;display:flex;align-items:flex-end">
          <div class="hourly-bar ${barClass}" style="height:${barH}px"></div>
          ${blH > 0 ? `<div class="baseline-dot" style="bottom:${blH}px" title="Baseline: ${bl.toFixed(1)}"></div>` : ""}
        </div>
        <div class="hourly-lbl">${String(h).padStart(2,"0")}</div>
      </div>`;
  }).join("");
  
  qs("#cChartSummary").textContent = `Hoy: ${totalHoy} placas`;
}

function renderCorteRecent(events) {
  qs("#cRecentCount").textContent = events.length;
  if (!events.length) {
    qs("#cRecentBody").innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-3)">Sin cortes hoy</td></tr>';
    return;
  }
  // Fields from fn_recent_cuts: inicio_local, duracion_min, placas, programa, file_name
  // OR from cortes_eventos: data_inicio_local, tempo_corte_s, quantidade, programa, file_name
  qs("#cRecentBody").innerHTML = events.map(e => {
    const inicio = e.inicio_local || e.data_inicio_local;
    const durMin = e.duracion_min != null ? Number(e.duracion_min).toFixed(1) + "‚Ä≤" : (e.tempo_corte_s ? fmtSec(e.tempo_corte_s) : "‚Äî");
    const placas = e.placas ?? e.quantidade ?? 1;
    const programa = e.programa || "‚Äî";
    const archivo = e.file_name || "";
    return `<tr>
      <td style="font-family:var(--mono);font-size:12px">${inicio ? fmtTime(inicio) : "‚Äî"}</td>
      <td style="text-align:right;font-family:var(--mono)">${durMin}</td>
      <td style="text-align:right;font-family:var(--mono)">${placas}</td>
      <td style="font-size:12px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escH(programa)}">${escH(programa)}</td>
      <td style="font-size:11px;color:var(--text-3);max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escH(archivo)}">${escH(archivo)}</td>
    </tr>`;
  }).join("");
}

// Servicios pendientes de corte (sub-tab)
async function loadCorteServicios() {
  try {
    const data = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc");
    const items = data.filter(i => i.status !== "completed");
    
    const total = items.length;
    const cutDone = items.filter(i => (i.stations||{}).corte === "completed").length;
    const totalCutMin = items.reduce((s,i) => s + (i.cutting_time_est||0), 0);
    
    qs("#cqTotal").textContent = total;
    qs("#cqTime").textContent = fmtMinFromMin(totalCutMin);
    qs("#cqDone").textContent = cutDone;
    qs("#cqPending").textContent = total - cutDone;
    
    qs("#corteBody").innerHTML = items.map((item, idx) => {
      const st = (item.stations||{}).corte || "pending";
      const dotIcon = st === "completed" ? "‚úì" : st === "in_progress" ? "‚ñ∂" : "¬∑";
      const cutMin = item.cutting_time_est || 0;
      return `<tr>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${idx+1}</td>
        <td><div class="svc-name">${escH(item.service_name||"")}</div></td>
        <td class="svc-client">${escH(item.client_name||"")}</td>
        <td style="text-align:right;font-family:var(--mono)">${cutMin > 0 ? fmtMinFromMin(cutMin) : "‚Äî"}</td>
        <td style="text-align:center"><div class="dot-mob ${st}" style="margin:0 auto">${dotIcon}</div></td>
      </tr>`;
    }).join("");
  } catch(e) { toast(e.message,"error"); }
}

// Tendencia 30 d√≠as (sub-tab)
async function loadCorteTendencia() {
  try {
    corteDaily = await sbRpc("fn_daily_last", { p_machine_id: CORTE_MACHINE, p_days: 30 });
    if (!corteDaily || !corteDaily.length) {
      qs("#ctDailyBars").innerHTML = '<div class="empty">Sin datos de los √∫ltimos 30 d√≠as</div>';
      return;
    }
    
    const sorted = [...corteDaily].sort((a,b) => (a.dia||"").localeCompare(b.dia||""));
    const totalPlacas = sorted.reduce((s,d) => s + (d.placas||0), 0);
    const avgDay = Math.round(totalPlacas / sorted.length);
    const best = sorted.reduce((a,b) => (b.placas||0) > (a.placas||0) ? b : a, sorted[0]);
    
    qs("#ctDays").textContent = sorted.length;
    qs("#ctTotal").textContent = totalPlacas.toLocaleString();
    qs("#ctAvgDay").textContent = avgDay;
    qs("#ctBestDay").textContent = best.placas || 0;
    qs("#ctBestDaySub").textContent = best.dia || "";
    
    const maxP = Math.max(...sorted.map(d => d.placas||0), 1);
    qs("#ctDailyBars").innerHTML = sorted.map(d => {
      const h = ((d.placas||0) / maxP) * 120;
      const date = new Date(d.dia + "T12:00:00");
      const isToday = d.dia === todayStr();
      return `
        <div class="day-col" title="${d.dia}: ${d.placas} placas">
          <div class="day-cnt">${d.placas}</div>
          <div class="day-bar${isToday?" today":""}" style="height:${h}px"></div>
          <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${DAY_NAMES[date.getDay()]}</div>
          <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${date.getDate()}</div>
        </div>`;
    }).join("");
    
    qs("#ctDailySummary").textContent = `Total: ${totalPlacas} placas ‚Äî Prom: ${avgDay}/d√≠a`;
  } catch(e) {
    console.error("loadCorteTendencia:", e);
    toast("Tendencia corte: " + e.message, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORTE: PREP MATERIAL (Pre-staging)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let prepQueueData = [];
let prepAllSelected = false;

async function loadPrepPanel() {
  // Set default date to tomorrow
  const dateEl = qs("#prepDate");
  if (dateEl && !dateEl.value) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    dateEl.value = tomorrow.toISOString().split("T")[0];
  }
  
  // Load production queue (pending & in_progress)
  try {
    const data = await sbQuery("production_queue_status", "order=priority.asc");
    prepQueueData = data.filter(i => i.status === "pending" || i.status === "in_progress");
    renderPrepServiceList();
  } catch(e) {
    console.error("[prep]", e);
    qs("#prepServiceList").innerHTML = `<div class="empty" style="color:var(--danger)">Error: ${e.message}</div>`;
  }
}

function renderPrepServiceList() {
  const el = qs("#prepServiceList");
  if (!prepQueueData.length) {
    el.innerHTML = '<div class="empty">No hay servicios en cola de producci√≥n</div>';
    return;
  }
  
  el.innerHTML = prepQueueData.map((svc, idx) => {
    const parts = svc.total_parts || "?";
    const boards = svc.boards_est || "?";
    const statusBadge = svc.status === "in_progress" 
      ? '<span style="background:#eab308;color:#000;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:600;margin-left:6px">En curso</span>' 
      : '';
    return `<label style="display:flex;gap:10px;align-items:flex-start;padding:8px;border-bottom:1px solid var(--border);cursor:pointer;border-radius:4px;transition:background .15s"
              onmouseover="this.style.background='var(--surface)'" onmouseout="this.style.background=''">
      <input type="checkbox" class="prep-check" value="${svc.service_id}" data-idx="${idx}"
        style="margin-top:3px;width:18px;height:18px;accent-color:var(--accent);flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="font-size:13px;font-weight:600;display:flex;align-items:center;gap:4px">
          ${escH(svc.service_name || "Servicio " + svc.service_id)}${statusBadge}
        </div>
        <div style="font-size:11px;color:var(--text-2)">
          ${escH(svc.client_name || "")}${svc.description ? " ‚Äî " + escH(svc.description) : ""}
        </div>
        <div style="font-size:11px;color:var(--text-3);display:flex;gap:12px;margin-top:2px">
          <span>ID: ${svc.service_id}</span>
          <span>Piezas: ${parts}</span>
          <span>Prioridad: ${svc.priority}</span>
        </div>
      </div>
    </label>`;
  }).join("");
}

function toggleAllPrep() {
  prepAllSelected = !prepAllSelected;
  qa(".prep-check").forEach(cb => cb.checked = prepAllSelected);
  qs("#prepToggleBtn").textContent = prepAllSelected ? "Deseleccionar todos" : "Seleccionar todos";
}

async function calcPrepMaterial() {
  const checks = [...qa(".prep-check:checked")];
  if (!checks.length) {
    toast("Seleccion√° al menos un proyecto", "error");
    return;
  }
  
  const selectedIds = checks.map(cb => parseInt(cb.value));
  showLoading("Calculando materiales...");
  
  try {
    // Fetch mob_quotes_detail for each selected service
    const details = await sbQuery("mob_quotes_detail", 
      `service_id=in.(${selectedIds.join(",")})&select=service_id,materials_optimizations_json,itens_json,raw_detail_json,optimizations_json`
    );
    
    // Track services without material data
    const detailIds = new Set(details.map(d => d.service_id));
    const missingIds = selectedIds.filter(id => {
      if (!detailIds.has(id)) return true;
      const d = details.find(x => x.service_id === id);
      const matSrc = d?.materials_optimizations_json || d?.itens_json || {};
      return !(matSrc.boards?.length > 0);
    });
    
    // Map detail by service_id
    const detailMap = {};
    for (const d of details) detailMap[d.service_id] = d;
    
    // Build project board data
    const projects = [];
    let globalTotalBoards = 0;
    let globalTotalCuts = 0;
    const globalByThickness = {}; // thickness => { desc, qty, projects: Set }
    
    for (const svc of prepQueueData) {
      if (!selectedIds.includes(svc.service_id)) continue;
      
      const det = detailMap[svc.service_id];
      const matSrc = det?.materials_optimizations_json || det?.itens_json || {};
      const rawDet = det?.raw_detail_json || {};
      const boards = matSrc.boards || [];
      const opt = det?.optimizations_json || {};
      
      // Official board quantities from raw_detail
      const officialBoards = rawDet.materials?.boards || [];
      const officialMap = {};
      for (const ob of officialBoards) {
        if (ob.internal_code) officialMap[ob.internal_code] = parseInt(ob.quantity || 0);
      }
      
      // Group boards by thickness for this project
      const byThickness = {};
      let projTotal = 0;
      
      for (const b of boards) {
        const thick = parseFloat(b.thickness || b.depth || b.espesor || 0);
        if (thick <= 0) continue;
        
        const code = b.code || b.internal_code || "";
        const qty = officialMap[code] || parseInt(b.consumption || b.quantity || 1);
        const desc = boardDesc(b);
        const thickKey = thick.toFixed(1);
        
        if (!byThickness[thickKey]) {
          byThickness[thickKey] = { thickness: thick, boards: [], total: 0 };
        }
        byThickness[thickKey].boards.push({ desc, qty, code, thick, dims: boardDims(b) });
        byThickness[thickKey].total += qty;
        projTotal += qty;
        
        // Global aggregation
        if (!globalByThickness[thickKey]) {
          globalByThickness[thickKey] = { thickness: thick, desc: desc, qty: 0, projects: new Set() };
        }
        globalByThickness[thickKey].qty += qty;
        globalByThickness[thickKey].projects.add(svc.service_name || svc.service_id);
      }
      
      projects.push({
        service_id: svc.service_id,
        name: svc.service_name || "Servicio " + svc.service_id,
        client: svc.client_name || "",
        byThickness,
        totalBoards: projTotal,
        cuttingTimes: parseInt(opt.cutting_times || 0),
      });
      
      globalTotalBoards += projTotal;
      globalTotalCuts += parseInt(opt.cutting_times || 0);
    }
    
    // Sort projects by priority (same order as queue)
    // Thicknesses sorted descending (thicker first = bottom of stack)
    
    // Render KPIs
    const thicknessCount = Object.keys(globalByThickness).length;
    qs("#prepProjects").textContent = projects.length;
    qs("#prepTotalBoards").textContent = globalTotalBoards;
    qs("#prepThicknesses").textContent = thicknessCount;
    qs("#prepCuts").textContent = globalTotalCuts || "?";
    
    // Render stacking order (per project)
    renderStackOrder(projects);
    
    // Render global thickness table
    renderThicknessTable(globalByThickness, globalTotalBoards);
    
    // Show warning for services without material data
    let missingHtml = "";
    if (missingIds.length > 0) {
      const missingNames = missingIds.map(id => {
        const svc = prepQueueData.find(s => s.service_id === id);
        return svc ? `${svc.service_name || "ID " + id} (${id})` : `ID ${id}`;
      });
      missingHtml = `<div class="card" style="border-left:3px solid var(--warn);background:rgba(234,179,8,.06)">
        <div class="card-title" style="color:var(--warn)">‚ö† Servicios sin datos de materiales</div>
        <p style="font-size:12px;color:var(--text-2);margin:0 0 10px">${missingNames.map(n => escH(n)).join(", ")}</p>
        <p style="font-size:11px;color:var(--text-3);margin:0 0 10px">Necesitan sincronizar desde MobCloud para traer los materiales.</p>
        <button class="btn btn-secondary btn-sm" onclick="syncMissingServices([${missingIds.join(",")}])">üîÑ Sincronizar servicios faltantes</button>
      </div>`;
    }
    
    // Insert warning before results if needed
    let warningEl = qs("#prepMissingWarning");
    if (!warningEl) {
      warningEl = document.createElement("div");
      warningEl.id = "prepMissingWarning";
      qs("#prepResults").prepend(warningEl);
    }
    warningEl.innerHTML = missingHtml;
    
    qs("#prepResults").style.display = "";
    
  } catch(e) {
    console.error("[prep] calc error:", e);
    toast("Error calculando materiales: " + e.message, "error");
  } finally {
    hideLoading();
  }
}

function boardDesc(b) {
  const parts = [];
  if (b.brand) parts.push(String(b.brand).replace(/¬Æ/g, "").trim());
  if (b.color) parts.push(String(b.color).trim());
  if (b.kind) parts.push(String(b.kind).trim());
  if (b.finishing) parts.push(String(b.finishing).trim());
  if (parts.length) return parts.join(" ");
  if (b.custom_name) return b.custom_name;
  if (b.commercial_name) return b.commercial_name;
  if (b.description) return b.description;
  return b.code || "Placa s/desc";
}

function boardDims(b) {
  const c = parseFloat(b.c || b.width || 0);
  const l = parseFloat(b.l || b.height || 0);
  if (c > 0 && l > 0) return `${c}x${l}`;
  return "";
}

function renderStackOrder(projects) {
  const el = qs("#prepStackOrder");
  
  // Color palette for thickness badges
  const thickColors = {
    "3.0": "#f87171", "6.0": "#fb923c", "9.0": "#fbbf24",
    "12.0": "#a3e635", "15.0": "#34d399", "18.0": "#38bdf8",
    "22.0": "#818cf8", "25.0": "#c084fc", "30.0": "#f472b6",
  };
  const defaultColor = "var(--accent)";
  
  el.innerHTML = projects.map((proj, idx) => {
    const thickKeys = Object.keys(proj.byThickness).sort((a, b) => parseFloat(b) - parseFloat(a));
    
    const boardRows = thickKeys.map(tk => {
      const g = proj.byThickness[tk];
      const color = thickColors[tk] || defaultColor;
      
      // Group same-desc boards
      const grouped = {};
      for (const b of g.boards) {
        const key = b.desc;
        if (!grouped[key]) grouped[key] = { desc: b.desc, dims: b.dims, qty: 0 };
        grouped[key].qty += b.qty;
      }
      
      return Object.values(grouped).map(bg => 
        `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
          <span style="background:${color};color:#fff;font-weight:700;padding:2px 8px;border-radius:10px;font-size:11px;min-width:42px;text-align:center">${tk}mm</span>
          <span style="flex:1;font-size:12px;color:var(--text)">${escH(bg.desc)}</span>
          ${bg.dims ? `<span style="font-size:10px;color:var(--text-3);font-family:var(--mono)">${bg.dims}</span>` : ""}
          <span style="font-family:var(--mono);font-weight:700;font-size:14px;min-width:30px;text-align:right">${bg.qty}</span>
          <span style="font-size:10px;color:var(--text-3)">placas</span>
        </div>`
      ).join("");
    }).join("");
    
    const stackPosition = projects.length - idx;
    const arrow = idx === 0 ? "‚¨Ü ARRIBA (se corta primero)" : idx === projects.length - 1 ? "‚¨á ABAJO (se corta √∫ltimo)" : "";
    
    return `<div style="border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden">
      <div style="background:var(--surface);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)">
        <div>
          <span style="background:var(--accent);color:#fff;font-weight:700;font-size:11px;padding:2px 8px;border-radius:10px;margin-right:6px">#${stackPosition}</span>
          <strong style="font-size:13px">${escH(proj.name)}</strong>
          ${proj.client ? `<span style="font-size:11px;color:var(--text-2);margin-left:8px">${escH(proj.client)}</span>` : ""}
        </div>
        <div style="font-family:var(--mono);font-weight:700;font-size:15px">${proj.totalBoards} <span style="font-size:10px;font-weight:400;color:var(--text-3)">placas</span></div>
      </div>
      ${arrow ? `<div style="text-align:center;font-size:10px;font-weight:600;color:var(--accent);padding:3px;background:rgba(99,102,241,.08)">${arrow}</div>` : ""}
      <div style="padding:6px 14px">${boardRows || '<div style="font-size:12px;color:var(--text-3);padding:8px 0">Sin datos de materiales cacheados</div>'}</div>
    </div>`;
  }).join("") || '<div class="empty">Sin proyectos seleccionados</div>';
}

function renderThicknessTable(globalByThickness, totalBoards) {
  const sorted = Object.entries(globalByThickness).sort((a, b) => parseFloat(b[0]) - parseFloat(a[0]));
  
  qs("#prepThicknessTable").innerHTML = sorted.map(([tk, g]) => {
    const pct = totalBoards > 0 ? ((g.qty / totalBoards) * 100).toFixed(0) : 0;
    const barW = totalBoards > 0 ? ((g.qty / totalBoards) * 100) : 0;
    return `<tr>
      <td><strong>${tk} mm</strong></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden">
            <div style="width:${barW}%;height:100%;background:var(--accent);border-radius:4px"></div>
          </div>
          <span style="font-size:11px;color:var(--text-3);min-width:28px">${pct}%</span>
        </div>
      </td>
      <td style="text-align:right;font-family:var(--mono);font-weight:700">${g.qty}</td>
      <td style="text-align:right;font-size:11px">${g.projects.size}</td>
    </tr>`;
  }).join("");
  
  qs("#prepThicknessFoot").innerHTML = `<tr>
    <td>TOTAL</td><td></td>
    <td style="text-align:right;font-family:var(--mono)">${totalBoards}</td>
    <td></td>
  </tr>`;
}

async function syncMissingServices(serviceIds) {
  showLoading(`Sincronizando ${serviceIds.length} servicio(s) desde MobCloud...`);
  let synced = 0, failed = 0;
  
  for (const sid of serviceIds) {
    try {
      await invokeFunction("sales-quotes-service", { action: "detail", service_id: sid });
      synced++;
    } catch(e) {
      console.warn(`[sync] SVC ${sid} failed:`, e.message);
      failed++;
    }
  }
  
  hideLoading();
  
  if (synced > 0) {
    toast(`${synced} servicio(s) sincronizado(s)${failed > 0 ? `, ${failed} fallaron` : ""}`, synced > 0 ? "success" : "error");
    // Re-run calculation
    calcPrepMaterial();
  } else {
    toast(`Error sincronizando: ${failed} servicio(s) fallaron`, "error");
  }
}

function printPrepMaterial() {
  const results = qs("#prepResults");
  if (!results || results.style.display === "none") {
    toast("Calcul√° los materiales primero", "error");
    return;
  }
  
  const dateVal = qs("#prepDate")?.value || "sin fecha";
  
  let wrapper = document.getElementById("printWrapper");
  if (wrapper) wrapper.remove();
  
  wrapper = document.createElement("div");
  wrapper.id = "printWrapper";
  wrapper.style.display = "none";
  wrapper.innerHTML = `
    <div class="print-header">
      <h2>Lista de Materiales para Corte</h2>
      <div class="print-sub">Fecha: ${dateVal} - Generado: ${new Date().toLocaleString("es-UY")} - La Buonora</div>
    </div>
  `;
  
  const clone = results.cloneNode(true);
  clone.style.display = "block";
  clone.querySelectorAll("button").forEach(el => el.remove());
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);
  
  window.print();
  setTimeout(() => { const pw = document.getElementById("printWrapper"); if (pw) pw.remove(); }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CORTE: ANALYTICS IA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let caCache = null;
let caCacheTime = 0;
const CA_CACHE_TTL = 5 * 60 * 1000; // 5 min cache for deterministic, skip for AI

async function fetchAgent(action, extra = '') {
  const url = `${SUPABASE_URL}/functions/v1/corte-analytics-agent?action=${action}${extra}`;
  const r = await fetch(url, {
    headers: { "apikey": SUPABASE_ANON, "Authorization": `Bearer ${SUPABASE_ANON}` }
  });
  if (!r.ok) throw new Error(`Agent ${action}: ${r.status} ${r.statusText}`);
  return r.json();
}

async function loadCorteAnalytics(forceAI = false) {
  const loading = qs("#caLoading");
  const content = qs("#caContent");
  const refreshBtn = qs("#caRefreshBtn");
  
  // Use cache if available and not forcing AI
  if (!forceAI && caCache && (Date.now() - caCacheTime < CA_CACHE_TTL)) {
    loading.style.display = "none";
    content.style.display = "";
    return;
  }
  
  loading.style.display = "";
  content.style.display = "none";
  if (refreshBtn) refreshBtn.disabled = true;
  
  try {
    // Fetch KPIs (always fast, deterministic)
    const kpis = await fetchAgent("kpis");
    
    // If forceAI, also fetch full AI analysis
    let aiAnalysis = null;
    if (forceAI) {
      loading.querySelector("div:last-child").textContent = "Analizando con IA... (puede tardar 15-20s)";
      try {
        aiAnalysis = await fetchAgent("analyze");
      } catch(e) {
        console.warn("[Analytics] AI analysis failed, using deterministic:", e.message);
      }
    }
    
    // If no AI, try deterministic insights
    let discipline = null, alerts = null;
    if (!aiAnalysis || !aiAnalysis.analysis?.executive_summary) {
      [discipline, alerts] = await Promise.all([
        fetchAgent("discipline"),
        fetchAgent("alerts", "&days=30")
      ]);
    }
    
    // Render everything
    renderAnalyticsKPIs(kpis);
    
    if (aiAnalysis?.analysis?.executive_summary) {
      renderAIAnalysis(aiAnalysis);
    } else {
      renderDeterministicAnalysis(kpis, discipline, alerts);
    }
    
    caCache = { kpis, aiAnalysis, discipline, alerts };
    caCacheTime = Date.now();
    
    loading.style.display = "none";
    content.style.display = "";
    
    const ts = new Date().toLocaleString("es-UY");
    qs("#caTimestamp").textContent = `√öltima actualizaci√≥n: ${ts}${aiAnalysis?.analysis?.executive_summary ? " (con IA)" : " (determin√≠stico)"}`;
    
  } catch(e) {
    console.error("[Analytics] Error:", e);
    loading.innerHTML = `<div style="color:var(--danger)">Error al cargar analytics: ${e.message}</div>
      <button class="btn btn-secondary btn-sm" onclick="loadCorteAnalytics()" style="margin-top:12px">Reintentar</button>`;
  } finally {
    if (refreshBtn) refreshBtn.disabled = false;
  }
}

function renderAnalyticsKPIs(kpis) {
  const cy = kpis.current_year || {};
  const vs = kpis.vs_last_year || {};
  const cap = kpis.capacity || {};
  const disc = kpis.discipline || {};
  const pat = kpis.patterns || {};
  
  qs("#caAvg2026").textContent = cy.avg_placas_dia || "‚Äî";
  
  const yoy = vs.placas_change_pct;
  if (yoy != null) {
    const el = qs("#caYoyChange");
    el.textContent = `${yoy > 0 ? "+" : ""}${yoy}%`;
    el.className = `kpi-change ${yoy >= 0 ? "up" : "down"}`;
  }
  
  qs("#caRecord").textContent = cap.record || "‚Äî";
  qs("#caUtil").textContent = cy.utilizacion ? cy.utilizacion + "%" : "‚Äî";
  
  const uc = vs.utilizacion_change;
  if (uc != null) {
    const el = qs("#caUtilChange");
    el.textContent = `${uc > 0 ? "+" : ""}${uc}pp`;
    el.className = `kpi-change ${uc >= 0 ? "up" : "down"}`;
  }
  
  // Demora arranque - convert to h:mm
  const dm = disc.avg_demora_2026;
  if (dm != null) {
    const h = Math.floor(dm / 60);
    const m = Math.round(dm % 60);
    qs("#caDelay").textContent = h > 0 ? `${h}h${String(m).padStart(2,"0")}` : `${m}‚Ä≤`;
    const mejora = disc.mejora_min;
    if (mejora) {
      const el = qs("#caDelaySub");
      el.innerHTML = `<span class="kpi-change up">-${Math.round(mejora)}min</span> vs 2025`;
    }
  }
  
  qs("#caBestDay").textContent = pat.best_day || "‚Äî";
  qs("#caBestDayAvg").textContent = pat.best_day_avg ? `${pat.best_day_avg} placas/d√≠a` : "";
  qs("#caRecent7").textContent = pat.recent_7d_avg || "‚Äî";
}

function renderAIAnalysis(data) {
  const a = data.analysis || {};
  
  // Summary
  qs("#caSummaryText").textContent = a.executive_summary || "Sin resumen disponible";
  
  // Alerts
  const alertSum = data.alerts_summary || {};
  const totalAlerts = (alertSum.criticals || 0) + (alertSum.warnings || 0);
  if (totalAlerts > 0) {
    qs("#caAlertsCard").style.display = "";
    qs("#caAlertsBadge").textContent = totalAlerts;
    qs("#caAlertsBadge").style.background = alertSum.criticals > 0 ? "var(--danger)" : "var(--warn)";
    qs("#caAlertsBadge").style.color = "white";
    
    let alertHtml = "";
    if (alertSum.longest_negative_streak) {
      const s = alertSum.longest_negative_streak;
      alertHtml += `<div style="padding:8px 12px;background:var(--bg);border-radius:6px;margin-bottom:8px;font-size:12px">
        <strong>Peor racha:</strong> ${s.dias} d√≠as (${s.fecha_inicio} ‚Üí ${s.fecha_fin}), promedio ${s.avg_placas} placas vs referencia ${s.referencia}
      </div>`;
    }
    qs("#caAlertsList").innerHTML = alertHtml;
  } else {
    qs("#caAlertsCard").style.display = "none";
  }
  
  // Patterns
  renderPatterns(a.hidden_patterns || []);
  
  // Correlations
  renderCorrelations(a.correlations || []);
  
  // Recommendations
  renderRecommendations(a.recommendations || []);
  
  // Anomalies
  renderAnomalies(a.anomalies || []);
  
  // Opportunities & Risks
  renderListItems("#caOpportunities", a.opportunities || [], "‚úÖ");
  renderListItems("#caRisks", a.risks || [], "‚ö†Ô∏è");
}

function renderDeterministicAnalysis(kpis, discipline, alerts) {
  // Build summary from KPIs
  const cy = kpis.current_year || {};
  const vs = kpis.vs_last_year || {};
  const disc = kpis.discipline || {};
  
  const summaryParts = [];
  if (vs.placas_change_pct) summaryParts.push(`Producci√≥n 2026 subi√≥ ${vs.placas_change_pct}% vs 2025.`);
  if (disc.avg_demora_2026) {
    const h = Math.floor(disc.avg_demora_2026 / 60);
    const m = Math.round(disc.avg_demora_2026 % 60);
    summaryParts.push(`Demora promedio de arranque: ${h}h${String(m).padStart(2,"0")} (mejor√≥ ${Math.round(disc.mejora_min || 0)} min vs 2025).`);
  }
  summaryParts.push("Us√° el bot√≥n 'Actualizar an√°lisis' para obtener insights profundos con IA.");
  
  qs("#caSummaryText").textContent = summaryParts.join(" ");
  
  // Alerts from fn_cortes_alertas
  if (alerts) {
    const alertList = Array.isArray(alerts) ? alerts : (alerts.alerts || []);
    const criticals = alertList.filter(a => a.tipo === "critico" || a.severity === "critical");
    const warnings = alertList.filter(a => a.tipo === "warning" || a.severity === "warning");
    const total = criticals.length + warnings.length;
    
    if (total > 0) {
      qs("#caAlertsCard").style.display = "";
      qs("#caAlertsBadge").textContent = total;
      qs("#caAlertsBadge").style.background = criticals.length > 0 ? "var(--danger)" : "var(--warn)";
      qs("#caAlertsBadge").style.color = "white";
      qs("#caAlertsList").innerHTML = alertList.slice(0, 5).map(a => 
        `<div style="padding:8px 12px;background:var(--bg);border-radius:6px;margin-bottom:6px;font-size:12px">
          <strong>${a.alerta || a.title || "Alerta"}:</strong> ${a.detalle || a.description || ""}
        </div>`
      ).join("");
    } else {
      qs("#caAlertsCard").style.display = "none";
    }
  }
  
  // Patterns from discipline data
  const patterns = [];
  if (discipline) {
    const corr = discipline.delay_vs_production_correlation;
    if (corr != null) {
      patterns.push({
        pattern: `Correlaci√≥n arranque ‚Üî producci√≥n: ${corr}`,
        evidence: "Cada hora menos de demora se traduce directamente en m√°s placas producidas. Esta correlaci√≥n es la palanca m√°s importante.",
        impact: "alto"
      });
    }
    const dt = discipline.recent_dead_time;
    if (dt) {
      patterns.push({
        pattern: `Tiempo muerto promedio: ${Math.round(dt.avg_pct || 0)}%`,
        evidence: `${Math.round(dt.avg_minutes || 0)} minutos promedio de gaps entre cortes.`,
        impact: dt.avg_pct > 30 ? "alto" : "medio"
      });
    }
  }
  const pat = kpis.patterns || {};
  if (pat.worst_day) {
    patterns.push({
      pattern: `${pat.worst_day} es el peor d√≠a (${pat.worst_day_avg} placas)`,
      evidence: `Mejor d√≠a: ${pat.best_day} (${pat.best_day_avg} placas). Diferencia de ${(pat.best_day_avg - pat.worst_day_avg).toFixed(1)} placas entre mejor y peor.`,
      impact: "medio"
    });
  }
  renderPatterns(patterns);
  
  // Deterministic recommendations
  const recs = [];
  const disc2 = kpis.discipline || {};
  if (disc2.avg_demora_2026 > 60) {
    recs.push({
      action: `Reducir demora de arranque de ${Math.round(disc2.avg_demora_2026)} min a <60 min`,
      expected_impact: "+15-20 placas/d√≠a",
      priority: 1, effort: "medio"
    });
  }
  const cap = kpis.capacity || {};
  if (cap.utilizacion_historica < 30) {
    recs.push({
      action: `Aumentar utilizaci√≥n del ${cap.utilizacion_historica}% al 50%+ con material pre-preparado`,
      expected_impact: "+10-15 placas/d√≠a",
      priority: 2, effort: "medio"
    });
  }
  if (pat.worst_day_avg && pat.best_day_avg) {
    recs.push({
      action: `Investigar ca√≠da de ${pat.worst_day}: preparar material la noche anterior`,
      expected_impact: `+${(pat.best_day_avg - pat.worst_day_avg).toFixed(0)} placas ese d√≠a`,
      priority: 3, effort: "bajo"
    });
  }
  renderRecommendations(recs);
  
  // Correlations from discipline
  const corrs = [];
  if (discipline?.delay_vs_production_correlation != null) {
    corrs.push({
      variables: "Demora arranque vs Placas/d√≠a",
      finding: "Correlaci√≥n negativa fuerte: menos demora = m√°s producci√≥n",
      r_value: discipline.delay_vs_production_correlation
    });
  }
  renderCorrelations(corrs);
  
  // Clear anomalies and lists for deterministic mode
  qs("#caAnomalies").innerHTML = '<div style="font-size:12px;color:var(--text-3);padding:8px">Ejecut√° el an√°lisis con IA para detectar anomal√≠as espec√≠ficas.</div>';
  renderListItems("#caOpportunities", [
    `R√©cord de ${cap.record} placas demuestra capacidad real de la m√°quina`,
    `√öltimos 7 d√≠as: ${pat.recent_7d_avg} promedio ‚Äî tendencia fuerte al alza`
  ], "‚úÖ");
  renderListItems("#caRisks", [
    `Gap al target: ${Math.abs(cap.gap_to_target || 0)} placas por debajo del objetivo`,
    `0% arranques a horario en toda la historia`
  ], "‚ö†Ô∏è");
}

function renderPatterns(patterns) {
  qs("#caPatterns").innerHTML = patterns.map(p => {
    const impact = (p.impact || "medio").toLowerCase();
    return `<div class="insight-card ${impact}">
      <div class="insight-title">${escH(p.pattern)}</div>
      <div class="insight-evidence">${escH(p.evidence)}</div>
    </div>`;
  }).join("") || '<div class="empty" style="padding:16px">Sin patrones detectados</div>';
}

function renderCorrelations(correlations) {
  qs("#caCorrelations").innerHTML = correlations.map(c => {
    const r = Number(c.r_value) || 0;
    const absR = Math.abs(r);
    const pct = absR * 100;
    const cls = r < 0 ? "neg" : "pos";
    return `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-size:13px;font-weight:600">${escH(c.variables)}</div>
          <div style="font-size:12px;color:var(--text-2)">${escH(c.finding)}</div>
        </div>
        <div style="font-family:var(--mono);font-size:18px;font-weight:700;color:${r < 0 ? "var(--danger)" : "var(--success)"}">${r.toFixed(2)}</div>
      </div>
      <div class="corr-bar"><div class="corr-fill ${cls}" style="width:${pct}%"></div></div>
    </div>`;
  }).join("") || '<div style="font-size:12px;color:var(--text-3);padding:8px">Sin correlaciones disponibles</div>';
}

function renderRecommendations(recs) {
  const sorted = [...recs].sort((a, b) => (a.priority || 99) - (b.priority || 99));
  qs("#caRecommendations").innerHTML = sorted.map((r, i) => {
    const effortBadge = r.effort === "bajo" ? "üü¢ Bajo esfuerzo" : r.effort === "medio" ? "üü° Esfuerzo medio" : "üî¥ Alto esfuerzo";
    return `<div class="rec-item">
      <div class="rec-num">${i + 1}</div>
      <div class="rec-body">
        <div class="rec-action">${escH(r.action)}</div>
        <div><span class="rec-impact">${escH(r.expected_impact)}</span><span class="rec-effort">${effortBadge}</span></div>
      </div>
    </div>`;
  }).join("") || '<div class="empty" style="padding:16px">Sin recomendaciones</div>';
}

function renderAnomalies(anomalies) {
  qs("#caAnomalies").innerHTML = anomalies.map(a => 
    `<div style="padding:10px 0;border-bottom:1px solid var(--border)">
      <div style="display:flex;gap:12px;align-items:flex-start">
        <div style="font-family:var(--mono);font-size:11px;color:var(--accent);min-width:110px;font-weight:600">${escH(a.date_range)}</div>
        <div>
          <div style="font-size:13px;font-weight:500">${escH(a.description)}</div>
          <div style="font-size:12px;color:var(--text-3);margin-top:2px">Posible causa: ${escH(a.possible_cause)}</div>
        </div>
      </div>
    </div>`
  ).join("") || '<div style="font-size:12px;color:var(--text-3);padding:8px">Sin anomal√≠as detectadas</div>';
}

function renderListItems(selector, items, emoji) {
  const list = qs(selector);
  if (!list) return;
  const arr = Array.isArray(items) ? items : [];
  list.innerHTML = arr.map(item => 
    `<li style="padding:6px 0;border-bottom:1px solid var(--border);display:flex;gap:8px">
      <span>${emoji}</span><span>${escH(typeof item === "string" ? item : item.text || JSON.stringify(item))}</span>
    </li>`
  ).join("") || `<li style="padding:6px 0;color:var(--text-3)">Sin datos</li>`;
}

async function generateAnalyticsPDF() {
  if (!caCache) {
    toast("Carg√° el an√°lisis primero", "error");
    return;
  }
  
  showLoading("Generando reporte PDF con Data Storytelling...");
  
  try {
    const result = await invokeFunction("report-pdf-engine", buildPdfPayload("corte-analytics"));
    
    if (result.signed_url) {
      window.open(result.signed_url, "_blank");
      toast(`Reporte PDF generado (${result.pages} p√°ginas)`, "success");
    } else {
      throw new Error("No se recibi√≥ URL del PDF");
    }
  } catch(e) {
    console.error("[PDF Engine]", e);
    toast("Error generando PDF: " + e.message, "error");
  } finally {
    hideLoading();
  }
}

async function generateBothPDFs() {
  if (!caCache) {
    toast("Carg√° el an√°lisis primero", "error");
    return;
  }
  
  showLoading("Generando Reporte + Narrativa Ejecutiva...");
  
  try {
    // Generate both in parallel
    const [report, narrative] = await Promise.all([
      invokeFunction("report-pdf-engine", buildPdfPayload("corte-analytics")),
      invokeFunction("report-pdf-engine", buildPdfPayload("corte-analytics-narrative")),
    ]);
    
    // Open both
    if (narrative.signed_url) window.open(narrative.signed_url, "_blank");
    if (report.signed_url) window.open(report.signed_url, "_blank");
    
    toast(`Reporte (${report.pages} p√°g) + Narrativa ejecutiva generados`, "success");
  } catch(e) {
    console.error("[PDF Engine]", e);
    toast("Error: " + e.message, "error");
  } finally {
    hideLoading();
  }
}

function buildPdfPayload(type) {
  return {
    type,
    data: {
      kpis: caCache.kpis || {},
      analysis: caCache.aiAnalysis?.analysis || {},
      alerts_summary: caCache.aiAnalysis?.alerts_summary || {},
      discipline: caCache.discipline || {},
    }
  };
}

function printAnalytics() {
  const content = qs("#caContent");
  if (!content || content.style.display === "none") {
    toast("Carg√° el an√°lisis primero", "error");
    return;
  }
  
  // Build date string
  const now = new Date();
  const dateStr = now.toLocaleDateString("es-UY", { 
    weekday: "long", year: "numeric", month: "long", day: "numeric" 
  });
  const timeStr = now.toLocaleTimeString("es-UY", { hour: "2-digit", minute: "2-digit" });
  
  // Check if AI or deterministic
  const isAI = caCache?.aiAnalysis?.analysis?.executive_summary;
  const modeLabel = isAI ? "An√°lisis con IA (Claude Sonnet)" : "An√°lisis determin√≠stico";
  
  // Create print wrapper with header + cloned content
  let wrapper = document.getElementById("printWrapper");
  if (wrapper) wrapper.remove();
  
  wrapper = document.createElement("div");
  wrapper.id = "printWrapper";
  wrapper.style.display = "none"; // hidden until print
  
  wrapper.innerHTML = `
    <div class="print-header">
      <h2>ü§ñ Corte Analytics ‚Äî La Buonora</h2>
      <div class="print-sub">${dateStr} ‚Äî ${timeStr} ¬∑ ${modeLabel} ¬∑ M√°quina: SCM Seccionadora (CORTE_1)</div>
    </div>
  `;
  
  // Clone the analytics content
  const clone = content.cloneNode(true);
  clone.style.display = "block";
  
  // Remove buttons from clone
  clone.querySelectorAll("button, #caRefreshBtn, #caTimestamp").forEach(el => el.remove());
  
  wrapper.appendChild(clone);
  document.body.appendChild(wrapper);
  
  // Print
  window.print();
  
  // Cleanup after print
  setTimeout(() => {
    const pw = document.getElementById("printWrapper");
    if (pw) pw.remove();
  }, 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTACI√ìN: ENCHAPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadEnchape() {
  try {
    const data = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc");
    const items = data.filter(i => i.status !== "completed");
    
    const total = items.length;
    const edgeDone = items.filter(i => (i.stations||{}).enchape === "completed").length;
    const totalEdgeSides = items.reduce((s,i) => s + (i.total_edge_sides||0), 0);
    const totalEdgeMeters = items.reduce((s,i) => s + (i.edge_meters||0), 0);
    const totalEdgeMin = items.reduce((s,i) => s + (i.edge_time_est_min||0), 0);
    
    qs("#eqTotal").textContent = total;
    qs("#eqMeters").textContent = `${Math.round(totalEdgeMeters)} m`;
    qs("#eqTime").textContent = fmtMinFromMin(totalEdgeMin);
    qs("#eqDone").textContent = edgeDone;
    
    qs("#enchapeBody").innerHTML = items.map((item, idx) => {
      const st = (item.stations||{}).enchape || "pending";
      const dotIcon = st === "completed" ? "‚úì" : st === "in_progress" ? "‚ñ∂" : "¬∑";
      return `<tr>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${idx+1}</td>
        <td><div class="svc-name">${escH(item.service_name||"")}</div></td>
        <td class="svc-client">${escH(item.client_name||"")}</td>
        <td style="text-align:right;font-family:var(--mono)">${item.total_edge_sides||0}</td>
        <td style="text-align:right;font-family:var(--mono)">${(item.edge_meters||0).toFixed(1)} m</td>
        <td style="text-align:right;font-family:var(--mono)">${item.edge_time_est_min ? fmtMinFromMin(item.edge_time_est_min) : "‚Äî"}</td>
        <td style="text-align:center"><div class="dot-mob ${st}" style="margin:0 auto">${dotIcon}</div></td>
      </tr>`;
    }).join("");
  } catch(e) { toast(e.message,"error"); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROL: RENDIMIENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadRendimiento() {
  try {
    const [cap, queue] = await Promise.all([
      invokeFunction("production-service", { action:"capacity" }),
      sbQuery("production_queue_status", "status=in.(pending,in_progress)&order=priority.asc"),
    ]);
    
    const realAvg = cap.avg_cycle_seconds || 75;
    const fixedEst = 80;
    const diffPct = ((realAvg / fixedEst) - 1) * 100;

    // Services with CNC data
    const withCNC = queue.filter(i => (i.cnc_total_seconds||0) > 0 && (i.cnc_parts_done||0) > 0);
    
    qs("#rendimientoContent").innerHTML = `
      <div class="card" style="margin-bottom:16px">
        <div class="card-title">‚öô Mecanizado CNC ‚Äî Estimado vs Real</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center;margin-bottom:20px">
          <div style="padding:16px;background:var(--bg);border-radius:8px;">
            <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Estimaci√≥n fija</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700">80s</div>
            <div style="font-size:12px;color:var(--text-3)">por pieza</div>
          </div>
          <div style="padding:16px;background:var(--bg);border-radius:8px;">
            <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Promedio real</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700;color:var(--accent)">${Math.round(realAvg)}s</div>
            <div style="font-size:12px;color:var(--text-3)">por pieza (${cap.days_count} d√≠as)</div>
          </div>
          <div style="padding:16px;background:${diffPct>10?'var(--danger)':diffPct<-10?'var(--success)':'var(--warn)'};border-radius:8px;color:white;">
            <div style="font-size:12px;opacity:.8;margin-bottom:8px">Diferencia</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700">${diffPct>0?"+":""}${Math.round(diffPct)}%</div>
            <div style="font-size:12px;opacity:.8">${diffPct>0?"Real m√°s lento":"Real m√°s r√°pido"}</div>
          </div>
        </div>
        ${withCNC.length ? `
        <div class="card-title">Por servicio (con datos CNC reales)</div>
        <div class="table-wrap">
          <table class="queue-table">
            <thead><tr><th>Servicio</th><th style="text-align:right">Piezas CNC</th><th style="text-align:right">Estimado</th><th style="text-align:right">Real</th><th style="text-align:right">Diferencia</th></tr></thead>
            <tbody>${withCNC.map(i => {
              const realSec = i.cnc_total_seconds;
              const estSec = (i.cnc_parts_done||0) * 80;
              const diff = estSec > 0 ? Math.round(((realSec/estSec)-1)*100) : 0;
              return `<tr>
                <td>${escH(i.service_name||"")}</td>
                <td style="text-align:right;font-family:var(--mono)">${i.cnc_parts_done}/${i.parts_with_machining}</td>
                <td style="text-align:right;font-family:var(--mono)">${fmtMin(estSec)}</td>
                <td style="text-align:right;font-family:var(--mono);font-weight:600">${fmtMin(realSec)}</td>
                <td style="text-align:right;font-family:var(--mono);color:${diff>10?'var(--danger)':diff<-10?'var(--success)':'var(--text)'}">${diff>0?"+":""}${diff}%</td>
              </tr>`;
            }).join("")}</tbody>
          </table>
        </div>` : `<p style="color:var(--text-3)">No hay servicios con datos CNC reales todav√≠a.</p>`}
      </div>
      <div class="card">
        <div class="card-title">‚úÇ Corte / ‚ñ§ Enchape ‚Äî Solo estimaciones</div>
        <p style="color:var(--text-3);font-size:13px">
          Los datos reales de corte y enchape estar√°n disponibles cuando se integren las m√°quinas correspondientes.
          Actualmente solo se muestran estimaciones de MobCloud.
        </p>
      </div>
    `;
  } catch(e) { toast(e.message,"error"); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 0: TRACKING POR PROYECTO (MECANIZADO)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let trackServices = [];
let trackProjects = [];
let trackParts = [];
let hasServiceMap = false;

function trackSetRange(range) {
  const to = new Date();
  const toStr = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  qs("#trackTo").value = toStr(to);
  if (range === "week") { const f = new Date(); f.setDate(f.getDate()-7); qs("#trackFrom").value = toStr(f); }
  else if (range === "month") { const f = new Date(); f.setDate(f.getDate()-30); qs("#trackFrom").value = toStr(f); }
  else { qs("#trackFrom").value = ""; }
  loadTracking();
}

async function loadTracking() {
  try {
    // Ensure queueData is loaded for production filter
    if (!queueData.length) {
      try { queueData = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc"); } catch {}
    }
    
    const from = qs("#trackFrom").value;
    const to = qs("#trackTo").value;
    let dateFilter = "";
    if (from) dateFilter += `&log_date=gte.${from}`;
    if (to) dateFilter += `&log_date=lte.${to}`;

    // Try service-level progress (requires parts_list_json + SQL views)
    let services = [];
    let partsEnriched = [];
    try {
      [services, partsEnriched] = await Promise.all([
        sbQuery("cnc_service_progress", "order=total_cnc_seconds.desc"),
        sbQuery("cnc_part_stats_enriched", "order=total_seconds.desc&limit=1000"),
      ]);
    } catch(e) {
      console.warn("Service views not available:", e.message);
    }

    const [projects, parts] = await Promise.all([
      sbQuery("cnc_project_progress", `machine_id=eq.${MACHINE_ID}${dateFilter}&order=log_date.desc`),
      sbQuery("cnc_part_stats", `order=total_seconds.desc&limit=1000`),
    ]);

    trackServices = services;
    trackProjects = projects;
    trackParts = partsEnriched.length > 0 ? partsEnriched : parts;
    hasServiceMap = services.length > 0;

    renderTrackMetrics();
    renderTrackProjects();
    renderTrackParts();
  } catch(e) { toast(e.message, "error"); }
}

function renderTrackMetrics() {
  if (hasServiceMap) {
    const filtered = getFilteredTrackServices();
    const totalCycles = filtered.reduce((s, r) => s + (r.total_cycles || 0), 0);
    const totalSeconds = filtered.reduce((s, r) => s + (r.total_cnc_seconds || 0), 0);
    const totalMobParts = filtered.reduce((s, r) => s + (r.parts_machined || 0), 0);
    qs("#tProjects").textContent = filtered.length;
    qs("#tPieces").textContent = totalCycles.toLocaleString();
    qs("#tPiecesSub").textContent = `ciclos completados`;
    qs("#tTime").textContent = fmtMin(totalSeconds);
    qs("#tMobParts").textContent = totalMobParts;
  } else {
    const byProject = {};
    for (const row of trackProjects) byProject[row.project_folder || "(sin carpeta)"] = true;
    const totalCycles = trackProjects.reduce((s, r) => s + (r.completed_cycles || 0), 0);
    const totalSeconds = trackProjects.reduce((s, r) => s + (r.total_seconds || 0), 0);
    qs("#tProjects").textContent = Object.keys(byProject).length;
    qs("#tPieces").textContent = totalCycles.toLocaleString();
    qs("#tPiecesSub").textContent = `ciclos completados`;
    qs("#tTime").textContent = fmtMin(totalSeconds);
    qs("#tMobParts").textContent = trackParts.filter(p => p.mob_part_id).length;
  }
}

function renderTrackProjects() {
  const container = qs("#trackProjectCards");
  if (hasServiceMap) {
    renderServiceCards(container);
  } else {
    renderFolderCards(container);
  }
}

function getFilteredTrackServices() {
  let svcs = trackServices.filter(s => s.total_cycles > 0 || s.parts_needing_machining > 0);
  if (qs("#trackOnlyProd").checked && queueData.length > 0) {
    const prodIds = new Set(queueData.map(q => q.service_id));
    svcs = svcs.filter(s => prodIds.has(s.service_id));
  }
  return svcs;
}

function renderServiceCards(container) {
  const services = getFilteredTrackServices();
  if (!services.length) {
    container.innerHTML = `<div class="empty">Servicios sincronizados pero sin actividad CNC detectada a√∫n</div>`;
    return;
  }

  container.innerHTML = `<div class="track-grid">${services.map(svc => {
    const pct = svc.progress_pct || 0;
    const barClass = pct >= 100 ? "green" : pct > 0 ? "blue" : "amber";
    const avgSec = svc.avg_seconds_per_cycle || 0;
    const estMin = svc.parts_needing_machining > 0 ? Math.round(svc.parts_needing_machining * 75 / 60) : 0;
    const realMin = svc.total_cnc_seconds > 0 ? Math.round(svc.total_cnc_seconds / 60) : 0;

    return `
      <div class="track-card">
        <div class="track-card-header">
          <div>
            <div class="track-card-name">${escH(svc.service_name)}</div>
            <div style="font-size:12px;color:var(--text-2);margin-top:2px">
              ${svc.client_name ? escH(svc.client_name) : ""}
              ${svc.quote_ref ? `<span style="color:var(--text-3)">(${escH(svc.quote_ref)})</span>` : ""}
            </div>
            <div class="track-card-dates" style="margin-top:2px">
              Servicio #${svc.service_id}
              ${svc.first_machined_at ? ` ‚Äî ${new Date(svc.first_machined_at).toLocaleDateString("es-UY")} ‚Üí ${new Date(svc.last_machined_at).toLocaleDateString("es-UY")}` : ""}
            </div>
          </div>
        </div>
        <div style="margin:12px 0 8px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
            <span style="color:var(--text-2)">Piezas CNC: <strong>${svc.parts_machined}</strong> / ${svc.parts_needing_machining}</span>
            <span style="font-family:var(--mono);font-weight:700;color:${pct>=100?'var(--success)':'var(--accent)'}">${pct}%</span>
          </div>
          <div class="progress-bar" style="height:10px">
            <div class="progress-fill ${barClass}" style="width:${Math.min(100,pct)}%"></div>
          </div>
        </div>
        <div class="track-stats">
          <div class="track-stat">
            <div class="track-stat-num" style="color:var(--accent)">${svc.total_cycles}</div>
            <div class="track-stat-label">Ciclos</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${realMin > 0 ? fmtMinFromMin(realMin) : "‚Äî"}</div>
            <div class="track-stat-label">Tiempo real</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtSec(avgSec)}</div>
            <div class="track-stat-label">Prom/pieza</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;font-size:11px;color:var(--text-3);margin-top:4px">
          <span>Est CNC: ${fmtMinFromMin(estMin)}</span>
          <span>Piezas servicio: ${svc.total_parts_in_service}</span>
          <span>Qty esperada: ${svc.total_qty_expected}</span>
        </div>
      </div>
    `;
  }).join("")}</div>`;
}

function renderFolderCards(container) {
  const byProject = {};
  for (const row of trackProjects) {
    const key = row.project_folder || "(sin carpeta)";
    if (!byProject[key]) byProject[key] = { 
      name: key, totalCycles: 0, totalSeconds: 0,
      days: {}, firstDate: row.log_date, lastDate: row.log_date
    };
    const p = byProject[key];
    p.totalCycles += row.completed_cycles || 0;
    p.totalSeconds += row.total_seconds || 0;
    p.days[row.log_date] = (p.days[row.log_date] || 0) + (row.completed_cycles || 0);
    if (row.log_date < p.firstDate) p.firstDate = row.log_date;
    if (row.log_date > p.lastDate) p.lastDate = row.log_date;
  }
  const projects = Object.values(byProject).sort((a, b) => b.totalCycles - a.totalCycles);
  if (!projects.length) {
    container.innerHTML = `<div class="empty">Sin datos para el rango seleccionado</div>`;
    return;
  }

  container.innerHTML = `
    <div style="padding:10px 14px;background:var(--accent-light);border-radius:6px;margin-bottom:14px;font-size:13px;color:var(--accent)">
      <strong>Nota:</strong> Mostrando por carpeta CNC. Para ver por proyecto MobCloud real, 
      ejecutar la migraci√≥n SQL de <code>cnc_part_service_map</code>, aplicar el patch de <code>parts_list_json</code> 
      en sales-quotes-service y re-sincronizar los servicios desde Comercial.
    </div>
    <div class="track-grid">${projects.map(p => {
    const avgSec = p.totalCycles > 0 ? Math.round(p.totalSeconds / p.totalCycles) : 0;
    const daysCount = Object.keys(p.days).length;
    const allDates = Object.keys(p.days).sort();
    const maxDay = Math.max(...Object.values(p.days), 1);
    const dayBars = allDates.map(d => {
      const h = (p.days[d] / maxDay) * 30;
      const dateObj = new Date(d + "T12:00:00");
      return `<div class="track-day-bar" style="height:${Math.max(2,h)}px" title="${d} (${DAY_NAMES[dateObj.getDay()]}): ${p.days[d]} piezas"></div>`;
    }).join("");
    const projectMobParts = trackParts.filter(pt => pt.project_folder === (p.name === "(sin carpeta)" ? null : p.name));

    return `
      <div class="track-card">
        <div class="track-card-header">
          <div>
            <div class="track-card-name">${escH(p.name)}</div>
            <div class="track-card-dates">${p.firstDate} ‚Üí ${p.lastDate} (${daysCount} d√≠as)</div>
          </div>
          <span style="font-family:var(--mono);font-size:12px;color:var(--accent)">${projectMobParts.length} IDs MobCloud</span>
        </div>
        <div class="track-stats">
          <div class="track-stat">
            <div class="track-stat-num" style="color:var(--accent)">${p.totalCycles}</div>
            <div class="track-stat-label">Ciclos</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtMin(p.totalSeconds)}</div>
            <div class="track-stat-label">Tiempo</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtSec(avgSec)}</div>
            <div class="track-stat-label">Promedio</div>
          </div>
        </div>
        ${dayBars ? `<div style="margin-top:4px"><div style="font-size:10px;color:var(--text-3);margin-bottom:4px">Producci√≥n por d√≠a</div><div class="track-days">${dayBars}</div></div>` : ""}
      </div>
    `;
  }).join("")}</div>`;
}

function renderTrackParts() {
  const search = (qs("#trackPartSearch").value || "").toLowerCase();
  let items = trackParts;
  if (search) items = items.filter(p => 
    String(p.mob_part_id).includes(search) ||
    (p.piece_name||"").toLowerCase().includes(search) ||
    (p.project_folder||"").toLowerCase().includes(search) ||
    (p.service_name||"").toLowerCase().includes(search) ||
    (p.client_name||"").toLowerCase().includes(search) ||
    (p.quote_ref||"").toLowerCase().includes(search) ||
    String(p.service_id||"").includes(search)
  );
  qs("#trackPartsBadge").textContent = items.length;

  // Check if we have enriched data (service_name present)
  const enriched = items.length > 0 && items[0].service_name !== undefined;

  qs("#trackPartsBody").innerHTML = items.map(p => `
    <tr>
      <td style="font-family:var(--mono);font-weight:600">${p.mob_part_id}</td>
      <td style="font-size:12px;color:var(--text-2)">${enriched && p.service_name 
        ? `${escH(p.service_name)}${p.client_name ? ' <span style="color:var(--text-3)">'+escH(p.client_name)+'</span>' : ''}${p.quote_ref ? ' <span style="font-family:var(--mono);font-size:10px;color:var(--text-3)">('+escH(p.quote_ref)+')</span>' : ''}` 
        : escH(p.project_folder || "‚Äî")}</td>
      <td style="text-align:right;font-family:var(--mono)">${p.repetitions_completed}${p.repetitions_interrupted > 0 ? ` <span style="color:var(--danger)">(+${p.repetitions_interrupted}‚úó)</span>` : ""}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(p.total_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(p.avg_seconds)}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${p.first_seen ? new Date(p.first_seen).toLocaleDateString("es-UY") : "‚Äî"}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${p.last_seen ? new Date(p.last_seen).toLocaleDateString("es-UY") : "‚Äî"}</td>
    </tr>
  `).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 1: COLA DE PRODUCCI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let queueData = [];
let packingProgress = {};  // service_id ‚Üí {total, scanned, complete}
let corteActivityToday = false;  // true if seccionadora active today

async function loadQueue() {
  try {
    // Auto-sync production queue from MobCloud
    try {
      const syncResult = await invokeFunction("production-service", { action: "sync-queue" });
      const msgs = [];
      if (syncResult.synced > 0) msgs.push(`${syncResult.synced} nuevos`);
      if (syncResult.updated > 0) msgs.push(`${syncResult.updated} actualizados`);
      if (syncResult.cleaned > 0) msgs.push(`${syncResult.cleaned} eliminados`);
      if (msgs.length) toast(`MobCloud: ${msgs.join(", ")}`, "success");
    } catch (e) {
      console.warn("sync-queue failed (offline?):", e.message);
    }
    
    // Load queue + packing progress + corte KPI in parallel
    const [qData, ppData, corteKpiArr] = await Promise.all([
      sbQuery("production_queue_status", "order=priority.asc,created_at.asc"),
      sbQuery("vw_packing_service_progress", "").catch(() => []),
      sbRpc("fn_kpi_live", { p_machine_id: "CORTE_1" }).catch(e => { console.warn("[Cola] Corte KPI failed:", e.message); return []; }),
    ]);
    queueData = qData;
    
    packingProgress = {};
    for (const p of ppData) {
      packingProgress[p.service_id] = {
        total: p.total_expected || 0,
        scanned: p.total_scanned || 0,
        complete: (p.pct_complete || 0) >= 100,
      };
    }
    
    // Corte activity: if seccionadora has cut today
    const ck = Array.isArray(corteKpiArr) ? corteKpiArr[0] : corteKpiArr;
    corteActivityToday = ck && (ck.placas_hoy || 0) > 0;
    
    renderQueue();
  } catch(e) { toast(e.message,"error"); }
}

function renderQueue() {
  const filter = qs("#queueFilter").value;
  const search = qs("#queueSearch").value.toLowerCase();
  let items = queueData;
  if (filter) items = items.filter(i => i.status === filter);
  if (search) items = items.filter(i => 
    (i.service_name||"").toLowerCase().includes(search) || 
    (i.client_name||"").toLowerCase().includes(search) ||
    String(i.service_id).includes(search)
  );

  qs("#queueCount").textContent = items.length;
  qs("#queueEmpty").style.display = items.length ? "none" : "block";

  // Metrics
  const pending = queueData.filter(i => i.status==="pending" || i.status==="in_progress");
  const piecesPending = pending.reduce((s,i) => s + Math.max(0, (i.parts_with_machining||0) - (i.cnc_parts_done||0)), 0);
  const timePendingSec = piecesPending * 75;
  qs("#mPending").textContent = queueData.filter(i=>i.status==="pending").length;
  qs("#mInProgress").textContent = queueData.filter(i=>i.status==="in_progress").length;
  qs("#mPiecesPending").textContent = piecesPending;
  qs("#mPiecesPendingSub").textContent = `de ${pending.reduce((s,i)=>s+(i.parts_with_machining||0),0)} totales`;
  qs("#mTimePending").textContent = fmtMin(timePendingSec);
  qs("#mTimePendingSub").textContent = `~${Math.ceil(piecesPending / 184)} d√≠as h√°biles`;

  const tbody = qs("#queueBody");
  tbody.innerHTML = items.map((item, idx) => {
    const pct = item.cnc_progress_pct || 0;
    const cncEst = item.cnc_time_est_min ? fmtMinFromMin(item.cnc_time_est_min) : "";
    const cncReal = item.cnc_total_seconds > 0 ? fmtMin(item.cnc_total_seconds) : "";
    const cutEst = item.cutting_time_est > 0 ? fmtMinFromMin(item.cutting_time_est) : "";
    const edgeEst = item.edge_time_est_min ? fmtMinFromMin(item.edge_time_est_min) : "";

    // MobCloud stations (manual, from Alan)
    const st = item.stations || {};
    const stCorte = st.corte || "pending";
    const stEnchape = st.enchape || "pending";
    const stMecanizado = st.mecanizado || "pending";
    const stPacking = st.packing || "pending";
    
    // Auto-detected stations (from real machine data)
    // Corte: general signal ‚Äî seccionadora active today (no per-service link yet)
    const mobCorte = (st.corte||"pending");
    const autoCorte = corteActivityToday 
      ? (mobCorte === "completed" ? "completed" : "in_progress")  
      : "no_data";
    // Enchape: no machine integration yet ‚Üí no_data
    const autoEnchape = "no_data";
    // Mecanizado: from CNC cycles (real data!)
    const autoCNC = pct >= 100 ? "completed" : pct > 0 ? "in_progress" : "pending";
    // Packing: from barcode scans
    const pp = packingProgress[item.service_id];
    const autoPacking = pp ? (pp.complete ? "completed" : pp.scanned > 0 ? "in_progress" : "pending") : "no_data";
    
    const dotIcon = s => s === "completed" ? "‚úì" : s === "in_progress" ? "‚ñ∂" : s === "no_data" ? "" : "¬∑";

    return `<tr data-id="${item.id}">
      <td style="color:var(--text-3);font-family:var(--mono);font-size:11px">${idx+1}</td>
      <td>
        <div class="svc-name">${escH(item.service_name||"")} <span style="font-family:var(--mono);font-size:11px;color:var(--text-3)">#${item.service_id}</span></div>
        ${item.client_name ? `<div class="svc-client">${escH(item.client_name)}</div>` : ""}
        ${item.description ? `<div class="svc-desc">${escH(item.description)}</div>` : ""}
        ${item.scheduled_date ? `<div style="font-size:10px;color:var(--text-3);font-family:var(--mono);margin-top:2px">üìÖ ${item.scheduled_date}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stCorte}" onclick="cycleStation('${item.id}','corte',this)" title="MobCloud (manual)">${dotIcon(stCorte)}</div>
          <div class="dot-auto ${autoCorte}" title="Auto: seccionadora ${corteActivityToday ? 'activa hoy' : 'sin datos'}">${dotIcon(autoCorte)}</div>
        </div>
        ${cutEst ? `<div class="station-info">${cutEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stEnchape}" onclick="cycleStation('${item.id}','enchape',this)" title="MobCloud (manual)">${dotIcon(stEnchape)}</div>
          <div class="dot-auto ${autoEnchape}" title="Auto-detectado">${dotIcon(autoEnchape)}</div>
        </div>
        ${edgeEst ? `<div class="station-info">${edgeEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stMecanizado}" onclick="cycleStation('${item.id}','mecanizado',this)" title="MobCloud (manual)">${dotIcon(stMecanizado)}</div>
          <div class="dot-auto ${autoCNC}" title="Auto: ${item.cnc_parts_done||0}/${item.parts_with_machining||0}">${dotIcon(autoCNC)}</div>
        </div>
        <div class="station-info">${item.cnc_parts_done||0}/${item.parts_with_machining||0} pzas</div>
        ${cncEst || cncReal ? `<div class="station-info">${cncReal ? '<b>'+cncReal+'</b>' : cncEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stPacking}" onclick="cycleStation('${item.id}','packing',this)" title="MobCloud (manual)">${dotIcon(stPacking)}</div>
          <div class="dot-auto ${autoPacking}" title="Auto: scanner">${dotIcon(autoPacking)}</div>
        </div>
        ${pp ? `<div class="station-info">${pp.scanned}/${pp.total}</div>` : ""}
      </td>
      <td class="queue-actions">
        <button class="btn btn-sm btn-secondary" onclick="removeFromQueue('${item.id}')" title="Quitar">‚úï</button>
      </td>
    </tr>`;
  }).join("");
}

function statusLabel(s) {
  return {pending:"Pendiente",in_progress:"En proceso",completed:"Completado",on_hold:"En espera"}[s]||s;
}

async function updateStatus(id, status) {
  try {
    await invokeFunction("production-service", { action:"update", id, status });
    toast(`Estado ‚Üí ${statusLabel(status)}`,"success");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
}

async function removeFromQueue(id) {
  if (!confirm("¬øQuitar este servicio de la cola?")) return;
  try {
    await invokeFunction("production-service", { action:"remove", id });
    toast("Servicio quitado","info");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
}

// Station status cycling: pending ‚Üí in_progress ‚Üí completed ‚Üí pending
const STATION_CYCLE = { pending: "in_progress", in_progress: "completed", completed: "pending" };

async function cycleStation(itemId, station, dotEl) {
  const item = queueData.find(i => i.id === itemId);
  if (!item) return;
  
  const st = item.stations || {};
  const current = st[station] || "pending";
  const next = STATION_CYCLE[current] || "pending";
  st[station] = next;
  item.stations = st;

  // Visual update immediately
  const icon = next === "completed" ? "‚úì" : next === "in_progress" ? "‚ñ∂" : "¬∑";
  dotEl.className = `dot-mob ${next}`;
  dotEl.textContent = icon;

  // Auto-update overall status based on stations
  let newStatus = item.status;
  const allStations = ["corte","enchape","mecanizado","packing"];
  const allCompleted = allStations.every(s => (st[s] || "pending") === "completed");
  const anyInProgress = allStations.some(s => ["in_progress","completed"].includes(st[s] || "pending"));
  if (allCompleted) newStatus = "completed";
  else if (anyInProgress) newStatus = "in_progress";
  else newStatus = "pending";

  // Persist
  try {
    await invokeFunction("production-service", { 
      action: "update-stations", 
      id: itemId, 
      stations: st,
      status: newStatus
    });
  } catch(e) { 
    console.warn("Station save:", e.message);
  }
}

async function recalcAll() {
  showLoading("Recalculando progreso CNC...");
  try {
    const r = await invokeFunction("production-service", { action:"recalc" });
    toast(`Recalculados: ${r.recalculated?.length || 0} servicios`,"success");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

function showAddModal() { showModal("addModal"); }

async function addManualService() {
  const sid = qs("#mServiceId").value;
  if (!sid) { toast("Ingres√° el Service ID","error"); return; }
  showLoading("Agregando...");
  try {
    await invokeFunction("production-service", {
      action: "add-manual",
      service_id: parseInt(sid),
      service_name: qs("#mServiceName").value,
      client_name: qs("#mClientName").value,
      description: qs("#mDescription").value,
      scheduled_date: qs("#mScheduledDate").value || null,
    });
    toast("Servicio agregado","success");
    closeModal("addModal");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

async function showAddFromQuoteModal() {
  showModal("quoteModal");
  const list = qs("#quoteList");
  list.innerHTML = '<div class="empty"><div class="spinner"></div> Cargando...</div>';
  
  try {
    const quotes = await sbQuery("quotes", "status=eq.accepted&order=created_at.desc&limit=20&select=id,referencia,client_name,grand_total,currency,created_at");
    if (!quotes.length) {
      list.innerHTML = '<div class="empty">No hay cotizaciones aceptadas</div>';
      return;
    }
    list.innerHTML = quotes.map(q => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:border-color .15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
        <div>
          <div style="font-weight:600;font-size:14px">${escH(q.referencia||"")} ‚Äî ${escH(q.client_name||"Sin cliente")}</div>
          <div style="font-size:12px;color:var(--text-3)">${new Date(q.created_at).toLocaleDateString("es-UY")}</div>
        </div>
        <button class="btn btn-sm btn-primary" onclick="addFromQuote('${q.id}')">Agregar</button>
      </div>
    `).join("");
  } catch(e) {
    list.innerHTML = `<div class="empty">${e.message}</div>`;
  }
}

async function addFromQuote(quoteId) {
  showLoading("Agregando servicios...");
  try {
    const r = await invokeFunction("production-service", { action:"add-from-quote", quote_id: quoteId });
    toast(`Agregados: ${r.added} servicios`,"success");
    closeModal("quoteModal");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 2: PANEL DEL D√çA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dayCycles = [];
let dayStats = null;

function setDayToday() { qs("#dayDate").value = todayStr(); loadDayData(); }
function shiftDay(dir) {
  const d = new Date(qs("#dayDate").value + "T12:00:00");
  d.setDate(d.getDate() + dir);
  qs("#dayDate").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  loadDayData();
}

async function loadDayData() {
  if (!qs("#dayDate").value) qs("#dayDate").value = todayStr();
  const date = qs("#dayDate").value;
  try {
    [dayCycles, dayStats] = await Promise.all([
      sbQuery("cnc_cycles", `machine_id=eq.${MACHINE_ID}&log_date=eq.${date}&order=started_at.desc`),
      sbQuery("cnc_daily_stats", `machine_id=eq.${MACHINE_ID}&log_date=eq.${date}`).then(a => a[0] || null),
    ]);
    renderDayMetrics();
    renderDayTimeline();
    renderDayHistogram();
    renderDayCycles();
  } catch(e) { toast(e.message,"error"); }
}

function renderDayMetrics() {
  if (!dayStats) {
    ["dPieces","dTime","dAvg","dUtil"].forEach(id => qs(`#${id}`).textContent = "‚Äî");
    qs("#dPiecesSub").textContent = ""; qs("#dTimeSub").textContent = ""; qs("#dAvgSub").textContent = "";
    return;
  }
  qs("#dPieces").textContent = dayStats.completed_cycles || 0;
  qs("#dPiecesSub").textContent = dayStats.interrupted_cycles > 0 ? `+ ${dayStats.interrupted_cycles} interrumpidas` : "";
  qs("#dTime").textContent = fmtMin(dayStats.total_machining_seconds);
  qs("#dTimeSub").textContent = `${dayStats.unique_programs||0} programas √∫nicos`;
  qs("#dAvg").textContent = fmtSec(dayStats.avg_cycle_seconds);
  qs("#dAvgSub").textContent = `mediana: ${fmtSec(dayStats.median_cycle_seconds)}`;
  qs("#dUtil").textContent = `${dayStats.utilization_pct||0}%`;
}

function renderDayTimeline() {
  const c = qs("#dayTimeline");
  const completed = dayCycles.filter(x => x.started_at && x.ended_at);
  if (!completed.length) { c.innerHTML = `<div class="empty" style="padding:10px">Sin datos</div>`; return; }

  const dayStart = new Date(completed[completed.length-1].started_at);
  dayStart.setHours(7,0,0,0);
  const dayEnd = new Date(completed[0].ended_at);
  dayEnd.setHours(Math.max(dayEnd.getHours()+1, 18),0,0,0);
  const rangeMs = dayEnd - dayStart;

  let html = "";
  for (let h=dayStart.getHours(); h<=dayEnd.getHours(); h++) {
    const t = new Date(dayStart); t.setHours(h,0,0,0);
    const pct = (t - dayStart) / rangeMs * 100;
    if (pct >= 0 && pct <= 100) html += `<div class="tl-grid" style="left:${pct}%"></div>`;
  }

  completed.forEach(x => {
    const s = new Date(x.started_at).getTime(), e = new Date(x.ended_at).getTime();
    const left = Math.max(0, (s - dayStart) / rangeMs * 100);
    const width = Math.max(0.3, (e - s) / rangeMs * 100);
    html += `<div class="tl-bar ${x.status}" style="left:${left}%;width:${width}%" title="${cleanName(x.piece_name)} ‚Äî ${fmtSec(x.duration_seconds)}"></div>`;
  });

  html += `<div class="tl-axis">`;
  for (let h=dayStart.getHours(); h<=dayEnd.getHours(); h++) html += `<span>${String(h).padStart(2,"0")}:00</span>`;
  html += `</div>`;
  c.innerHTML = html;
}

function renderDayHistogram() {
  const c = qs("#dayHistogram");
  const completed = dayCycles.filter(x => x.status==="completed");
  if (!completed.length) { c.innerHTML = `<div class="empty" style="width:100%">Sin datos</div>`; return; }

  const buckets = [{min:0,max:30,l:"<30s"},{min:30,max:60,l:"30-60"},{min:60,max:90,l:"60-90"},{min:90,max:120,l:"90-120"},{min:120,max:180,l:"2-3m"},{min:180,max:300,l:"3-5m"},{min:300,max:Infinity,l:">5m"}];
  const counts = buckets.map(b => ({...b, n: completed.filter(x => x.duration_seconds >= b.min && x.duration_seconds < b.max).length}));
  const maxN = Math.max(...counts.map(x=>x.n), 1);

  c.innerHTML = counts.map(b => `
    <div class="hist-col">
      <div class="hist-cnt">${b.n||""}</div>
      <div class="hist-bar" style="height:${(b.n/maxN)*90}px"></div>
      <div class="hist-lbl">${b.l}</div>
    </div>
  `).join("");
}

function renderDayCycles() {
  const search = (qs("#dayCycleSearch").value||"").toLowerCase();
  const filter = qs("#dayCycleFilter").value;
  let items = dayCycles;
  if (filter) items = items.filter(x => x.status === filter);
  if (search) items = items.filter(x => 
    cleanName(x.piece_name).toLowerCase().includes(search) || 
    String(x.mob_part_id||"").includes(search) ||
    (x.project_folder||"").toLowerCase().includes(search)
  );
  qs("#dayCycleCount").textContent = items.length;

  qs("#dayCyclesBody").innerHTML = items.map(x => `
    <tr>
      <td><span class="cycle-status ${x.status}"></span></td>
      <td class="piece-name" title="${escH(cleanName(x.piece_name))}">${escH(cleanName(x.piece_name))}</td>
      <td style="font-size:12px;color:var(--text-2)">${escH(x.project_folder||"‚Äî")}</td>
      <td style="text-align:right;font-family:var(--mono);font-weight:${x.status==='completed'?600:400}">${fmtSec(x.duration_seconds)}</td>
      <td style="font-family:var(--mono);font-size:12px">${fmtTime(x.started_at)}</td>
      <td style="font-family:var(--mono);font-size:12px">${fmtTime(x.ended_at)}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${x.mob_part_id||"‚Äî"}</td>
    </tr>
  `).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 3: HIST√ìRICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let histData = [];

async function loadHistorical() {
  try {
    histData = await sbQuery("cnc_daily_stats", `machine_id=eq.${MACHINE_ID}&order=log_date.desc&limit=30`);
    renderHistorical();
  } catch(e) { toast(e.message,"error"); }
}

function renderHistorical() {
  if (!histData.length) return;

  const sorted = [...histData].sort((a,b) => a.log_date.localeCompare(b.log_date));
  const totalPieces = sorted.reduce((s,d) => s + (d.completed_cycles||0), 0);
  const avgDay = Math.round(totalPieces / sorted.length);
  const avgCycle = Math.round(sorted.reduce((s,d) => s + (d.avg_cycle_seconds||0), 0) / sorted.length);

  qs("#hDays").textContent = sorted.length;
  qs("#hPieces").textContent = totalPieces.toLocaleString();
  qs("#hAvgDay").textContent = avgDay;
  qs("#hAvgCycle").textContent = fmtSec(avgCycle);

  // Bar chart
  const maxP = Math.max(...sorted.map(d => d.completed_cycles||0), 1);
  qs("#histBars").innerHTML = sorted.map(d => {
    const h = ((d.completed_cycles||0) / maxP) * 120;
    const date = new Date(d.log_date + "T12:00:00");
    const isToday = d.log_date === todayStr();
    return `
      <div class="day-col" onclick="goToDay('${d.log_date}')" title="${d.log_date}: ${d.completed_cycles} piezas, avg ${Math.round(d.avg_cycle_seconds)}s">
        <div class="day-cnt">${d.completed_cycles}</div>
        <div class="day-bar${isToday?" today":""}" style="height:${h}px"></div>
        <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${DAY_NAMES[date.getDay()]}</div>
        <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${date.getDate()}</div>
      </div>
    `;
  }).join("");

  qs("#histSummary").textContent = `Total: ${totalPieces} piezas ‚Äî Prom: ${avgDay}/d√≠a ‚Äî Ciclo: ${avgCycle}s`;

  // Table
  qs("#histTableBody").innerHTML = [...histData].map(d => `
    <tr style="cursor:pointer" onclick="goToDay('${d.log_date}')">
      <td style="font-weight:600">${d.log_date}</td>
      <td style="text-align:right;font-family:var(--mono)">${d.completed_cycles}</td>
      <td style="text-align:right;font-family:var(--mono);color:${d.interrupted_cycles>0?"var(--danger)":"var(--text-3)"}">${d.interrupted_cycles}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtMin(d.total_machining_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(d.avg_cycle_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(d.median_cycle_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${d.utilization_pct||0}%</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${fmtTimeShort(d.first_cycle_at)} ‚Äî ${fmtTimeShort(d.last_cycle_at)}</td>
    </tr>
  `).join("");
}

function goToDay(date) {
  qs("#dayDate").value = date;
  switchTab("mecanizado");
  switchMecSub("dia");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 4: CAPACIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadCapacity() {
  try {
    const [cap, queue] = await Promise.all([
      invokeFunction("production-service", { action:"capacity" }),
      sbQuery("production_queue_status", "status=in.(pending,in_progress)&order=priority.asc"),
    ]);

    qs("#capPieces").textContent = cap.avg_pieces_per_day || "‚Äî";
    qs("#capTime").textContent = fmtMinFromMin(cap.avg_machining_min_per_day);
    qs("#capTimeSub").textContent = `basado en ${cap.days_count} d√≠as`;
    qs("#capCycle").textContent = fmtSec(cap.avg_cycle_seconds);
    qs("#capUtil").textContent = `${cap.utilization_avg||0}%`;

    // Queue load
    const totalPieces = queue.reduce((s,i) => s + Math.max(0, (i.parts_with_machining||0) - (i.cnc_parts_done||0)), 0);
    const totalCutMin = queue.reduce((s,i) => s + (i.cutting_time_est||0), 0);
    const totalEdgeMin = queue.reduce((s,i) => s + (i.edge_time_est_min||0), 0);
    const totalCncMin = Math.round(totalPieces * (cap.avg_cycle_seconds||75) / 60);
    const daysNeeded = cap.avg_pieces_per_day > 0 ? Math.ceil(totalPieces / cap.avg_pieces_per_day) : "?";

    qs("#capQueueBlock").innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><span style="font-size:12px;color:var(--text-3)">Servicios pendientes</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${queue.length}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Piezas CNC pendientes</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${totalPieces}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo CNC estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalCncMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo corte estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalCutMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo enchape estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalEdgeMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">D√≠as h√°biles estimados</span><div style="font-family:var(--mono);font-size:24px;font-weight:700;color:var(--accent)">${daysNeeded}</div></div>
      </div>
    `;

    qs("#capEstBlock").innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><span style="font-size:12px;color:var(--text-3)">Capacidad CNC/d√≠a</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${cap.avg_pieces_per_day} pzas</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Mecanizado efectivo/d√≠a</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${fmtMinFromMin(cap.avg_machining_min_per_day)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Utilizaci√≥n promedio</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${cap.utilization_avg}%</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Ciclo promedio real</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtSec(cap.avg_cycle_seconds)}</div></div>
      </div>
      <div style="margin-top:14px;padding:10px;background:var(--surface);border-radius:6px;font-size:13px;color:var(--text-2);">
        <strong>Nota:</strong> El promedio real (${cap.avg_cycle_seconds}s/pieza) vs la estimaci√≥n fija (80s/pieza) 
        da un error del <strong>${cap.avg_cycle_seconds ? Math.round((cap.avg_cycle_seconds/80 - 1)*100) : 0}%</strong>. 
        Las estimaciones en la cola usan el promedio real.
      </div>
    `;

    // Comparison
    renderComparison(cap);

  } catch(e) { toast(e.message,"error"); }
}

function renderComparison(cap) {
  const c = qs("#capComparison");
  const realAvg = cap.avg_cycle_seconds || 75;
  const fixedEst = 80;
  const diff = realAvg - fixedEst;
  const diffPct = ((realAvg / fixedEst) - 1) * 100;

  c.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center;">
      <div style="padding:16px;background:var(--bg);border-radius:8px;">
        <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Estimaci√≥n fija</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700">80s</div>
        <div style="font-size:12px;color:var(--text-3)">por pieza</div>
      </div>
      <div style="padding:16px;background:var(--bg);border-radius:8px;">
        <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Promedio real</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700;color:var(--accent)">${Math.round(realAvg)}s</div>
        <div style="font-size:12px;color:var(--text-3)">por pieza (${cap.days_count} d√≠as)</div>
      </div>
      <div style="padding:16px;background:${diffPct>10?'var(--danger)':diffPct<-10?'var(--success)':'var(--warn)'};border-radius:8px;color:white;">
        <div style="font-size:12px;opacity:.8;margin-bottom:8px">Diferencia</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700">${diffPct>0?"+":""}${Math.round(diffPct)}%</div>
        <div style="font-size:12px;opacity:.8">${diff>0?"Real m√°s lento":"Real m√°s r√°pido"}</div>
      </div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 5: PACKING (was Pre Packing)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPrePacking() {
  try {
    // Get production list from MobCloud
    let prodServices = [];
    try {
      prodServices = await invokeFunction("production-service", { action: "list-production" });
    } catch (e) {
      console.warn("Production list not available:", e.message);
    }

    // Get packing progress from local views
    let ppData = [];
    try {
      ppData = await sbQuery("vw_packing_service_progress", "order=service_id.desc");
    } catch (e) { console.warn("Packing views not ready:", e.message); }
    const ppMap = {};
    for (const p of ppData) ppMap[p.service_id] = p;

    // Today's scan count
    const todayStart = todayStr() + "T00:00:00";
    let todayScans = 0;
    try {
      const scans = await sbQuery("packing_scans", `scanned_at=gte.${todayStart}&select=id`);
      todayScans = scans?.length || 0;
    } catch (e) {}

    // Merge: production services + packing progress
    const merged = prodServices.map(s => {
      const pp = ppMap[s.service_id] || {};
      return { ...s, expected: +(pp.expected||0), scanned: +(pp.scanned||0), missing: +(pp.missing||0), complete: !!pp.complete };
    });

    // Metrics
    const total = merged.length;
    const withParts = merged.filter(s => s.has_parts_cached).length;
    const inProgress = merged.filter(s => s.scanned > 0 && !s.complete).length;
    const complete = merged.filter(s => s.complete).length;
    
    qs("#ppServices").textContent = total;
    qs("#ppInProgress").textContent = inProgress;
    qs("#ppComplete").textContent = complete;
    qs("#ppToday").textContent = todayScans;

    // Table
    const tbody = qs("#ppBody");
    qs("#ppEmpty").style.display = merged.length ? "none" : "block";

    tbody.innerHTML = merged.map(s => {
      const exp = s.expected || 0;
      const sc = s.scanned || 0;
      const mis = s.missing || 0;
      const pct = exp > 0 ? Math.round(sc / exp * 100) : 0;
      const barClass = pct >= 100 ? "green" : pct > 0 ? "blue" : "";
      const name = s.internal_code || "Servicio " + s.service_id;
      const partsIcon = s.has_parts_cached ? "‚úì" : "‚ö†";
      const partsColor = s.has_parts_cached ? "var(--success)" : "var(--warn)";

      // Step badges
      const stepBadge = (val, label) => val 
        ? `<span style="font-size:10px;color:var(--success)">‚úì${label}</span>` 
        : `<span style="font-size:10px;color:var(--text-3)">¬∑${label}</span>`;

      return `<tr>
        <td>
          <div style="font-weight:600">${escH(name)}</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--text-3)">#${s.service_id} <span style="color:${partsColor}">${partsIcon} partes</span></div>
          <div style="margin-top:3px;display:flex;gap:6px">
            ${stepBadge(s.step_cut,"Corte")} ${stepBadge(s.step_edge,"Enchape")} ${stepBadge(s.step_machining,"CNC")} ${stepBadge(s.step_packing,"Pack")}
          </div>
        </td>
        <td style="font-size:12px">${escH(s.client_name || "")}</td>
        <td style="text-align:center;font-family:var(--mono)">${exp || "‚Äî"}</td>
        <td style="text-align:center;font-family:var(--mono)">${sc || "‚Äî"}</td>
        <td style="text-align:center;font-family:var(--mono);${mis>0?"color:var(--danger);font-weight:700":""}">${mis || "‚Äî"}</td>
        <td style="min-width:110px">
          ${exp > 0 ? `<div style="display:flex;align-items:center;gap:6px">
            <div class="progress-bar" style="flex:1"><div class="progress-fill ${barClass}" style="width:${Math.min(100,pct)}%"></div></div>
            <span style="font-family:var(--mono);font-size:11px;min-width:32px">${pct}%</span>
          </div>` : `<span style="font-size:11px;color:var(--text-3)">${s.has_parts_cached?"Sin scans":"Sincronizar"}</span>`}
        </td>
        <td><a href="prepacking.html" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration:none;font-size:11px">Escanear ‚Üó</a></td>
      </tr>`;
    }).join("");
  } catch (e) {
    console.error("loadPrePacking:", e);
    toast(e.message, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
trackSetRange("month");
qs("#dayDate").value = todayStr();
// Load Cola (default tab)
loadQueue();
</script>
</body>
</html>
