<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Producci√≥n ‚Äî La Buonora</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
    :root {
      --bg: #f7f8fa; --surface: #fff; --border: #e2e5ea;
      --text: #1a1d23; --text-2: #5a5f6b; --text-3: #8b909c;
      --accent: #2e5faa; --accent-hover: #24508f; --accent-light: #eaf0fb;
      --danger: #c93c3c; --success: #2a8a4a; --warn: #c78b17; --radius: 8px;
      --mono: 'JetBrains Mono', monospace;
    }
    html.dark {
      --bg: #1a1d23; --surface: #23272e; --border: #353a44;
      --text: #e8eaed; --text-2: #b0b5bf; --text-3: #6b7280;
      --accent: #5b8fd9; --accent-hover: #7ba7e5; --accent-light: #2a3444;
      --danger: #e05555; --success: #3bb06a; --warn: #d9a030;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; }
    
    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .app-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 28px; display: flex; align-items: center; gap: 16px; position: sticky; top: 0; z-index: 50; }
    .app-header h1 { font-size: 18px; font-weight: 700; color: var(--accent); }
    .app-header .subtitle { color: var(--text-3); font-size: 13px; }
    .header-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
    .nav-tabs { display: flex; gap: 2px; background: var(--bg); border-radius: 8px; padding: 3px; margin-left: 12px; align-items: center; }
    .nav-tab { padding: 6px 14px; font-size: 12.5px; font-weight: 500; font-family: inherit; border: none; background: transparent; color: var(--text-3); cursor: pointer; border-radius: 6px; transition: all 0.15s; white-space: nowrap; }
    .nav-tab:hover { color: var(--text); background: var(--surface); }
    .nav-tab.active { background: var(--accent); color: white; font-weight: 600; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .nav-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
    .nav-group { position: relative; }
    .nav-group:hover .nav-dropdown, .nav-group:focus-within .nav-dropdown { display: block; }
    .nav-dropdown {
      display: none; position: absolute; top: 100%; left: 0; margin-top: 4px;
      background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
      padding: 4px; min-width: 180px; z-index: 40; box-shadow: 0 8px 24px rgba(0,0,0,.15);
    }
    .nav-dropdown .nav-tab { display: block; width: 100%; text-align: left; border-radius: 4px; padding: 7px 12px; font-size: 12px; }
    .nav-dropdown .nav-tab.active { background: var(--accent); }
    .nav-dropdown .dd-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: .06em; color: var(--text-3); padding: 6px 12px 3px; }

    /* ‚îÄ‚îÄ Dual indicator dots ‚îÄ‚îÄ */
    .dual-dots { display: flex; gap: 3px; justify-content: center; align-items: center; }
    .dot-mob { width: 20px; height: 20px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; transition: all .2s; border: 2px solid var(--border); color: var(--text-3); }
    .dot-mob:hover { transform: scale(1.15); }
    .dot-mob.pending { border-color: var(--border); background: var(--bg); color: var(--text-3); }
    .dot-mob.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .dot-mob.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); }
    .dot-auto { width: 20px; height: 20px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; border: 1.5px dashed var(--border); color: var(--text-3); transition: all .2s; }
    .dot-auto.pending { border-color: var(--border); background: transparent; color: var(--text-3); }
    .dot-auto.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); border-style: solid; }
    .dot-auto.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); border-style: solid; }
    .dot-auto.no_data { border-color: transparent; background: transparent; color: transparent; }
    .dual-label { font-size: 8px; color: var(--text-3); text-align: center; margin-top: 1px; letter-spacing: .03em; }
    
    /* ‚îÄ‚îÄ Shared UI ‚îÄ‚îÄ */
    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 20px; }
    .card-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; color: var(--text); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .card-title .badge { font-size: 11px; font-weight: 500; background: var(--accent-light); color: var(--accent); padding: 2px 8px; border-radius: 12px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 13px; font-weight: 500; font-family: inherit; border-radius: 6px; border: 1px solid transparent; cursor: pointer; transition: all 0.15s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--surface); color: var(--text); border-color: var(--border); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    label { font-size: 12px; font-weight: 500; color: var(--text-2); display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 8px 10px; font-size: 13px; font-family: inherit; border: 1px solid var(--border); border-radius: 6px; background: var(--surface); color: var(--text); transition: border-color 0.15s; }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 14px; }
    .form-group { display: flex; flex-direction: column; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-3); padding: 10px 12px; border-bottom: 2px solid var(--border); }
    td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    tr:hover td { background: var(--accent-light); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .toast-container { position: fixed; top: 70px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 8px; }
    .toast { padding: 10px 16px; border-radius: 8px; font-size: 13px; color: white; box-shadow: 0 4px 16px rgba(0,0,0,0.15); animation: slideIn 0.25s ease; }
    .toast-success { background: var(--success); } .toast-error { background: var(--danger); } .toast-info { background: var(--accent); }
    @keyframes slideIn { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.7); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 12px; }
    html.dark .loading-overlay { background: rgba(0,0,0,0.6); }
    .loading-overlay.active { display: flex; }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .dark-toggle { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; font-size: 14px; color: var(--text); }
    .empty { text-align: center; padding: 40px 20px; color: var(--text-3); }
    .mono { font-family: var(--mono); }

    /* ‚îÄ‚îÄ Status badges ‚îÄ‚îÄ */
    .status { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; }
    .status-pending { background: #fef3d1; color: var(--warn); }
    .status-in_progress { background: var(--accent-light); color: var(--accent); }
    .status-completed { background: #e3f5ea; color: var(--success); }
    .status-on_hold { background: #e8e8e8; color: #888; }

    /* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */
    .progress-bar { width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .progress-fill.green { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-fill.blue { background: linear-gradient(90deg, var(--accent), #60a5fa); }
    .progress-fill.amber { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

    /* ‚îÄ‚îÄ Summary metrics ‚îÄ‚îÄ */
    .metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .metric-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 20px; }
    .metric-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-3); font-weight: 600; margin-bottom: 6px; }
    .metric-value { font-family: var(--mono); font-size: 28px; font-weight: 700; color: var(--text); }
    .metric-sub { font-size: 12px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Queue table ‚îÄ‚îÄ */
    .queue-table td { font-size: 13px; }
    .queue-table .svc-name { font-weight: 600; color: var(--text); }
    .queue-table .svc-client { font-size: 12px; color: var(--text-2); }
    .queue-table .svc-desc { font-size: 11px; color: var(--text-3); }
    .queue-actions { display: flex; gap: 4px; }

    /* ‚îÄ‚îÄ Station indicators ‚îÄ‚îÄ */
    .station-cell { text-align: center; min-width: 90px; }
    .station-dot { width: 22px; height: 22px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 11px; cursor: pointer; transition: all .2s; border: 2px solid var(--border); color: var(--text-3); }
    .station-dot:hover { transform: scale(1.15); }
    .station-dot.pending { border-color: var(--border); background: var(--bg); color: var(--text-3); }
    .station-dot.in_progress { border-color: var(--accent); background: var(--accent-light); color: var(--accent); }
    .station-dot.completed { border-color: var(--success); background: #e3f5ea; color: var(--success); }
    .station-info { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-top: 3px; white-space: nowrap; }

    /* ‚îÄ‚îÄ Timeline (day view) ‚îÄ‚îÄ */
    .timeline-container { position: relative; height: 60px; margin: 12px 0; }
    .tl-bar { position: absolute; top: 10px; height: 30px; border-radius: 3px; opacity: 0.7; cursor: default; }
    .tl-bar.completed { background: var(--success); }
    .tl-bar.interrupted { background: var(--danger); }
    .tl-bar:hover { opacity: 1; }
    .tl-axis { position: absolute; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-between; font-size: 10px; font-family: var(--mono); color: var(--text-3); }
    .tl-grid { position: absolute; top: 5px; bottom: 16px; width: 1px; background: var(--border); }

    /* ‚îÄ‚îÄ Histogram ‚îÄ‚îÄ */
    .hist-wrap { display: flex; align-items: flex-end; gap: 4px; height: 100px; }
    .hist-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .hist-bar { width: 100%; border-radius: 3px 3px 0 0; background: var(--accent); min-height: 2px; transition: height 0.4s; }
    .hist-cnt { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-bottom: 2px; min-height: 14px; }
    .hist-lbl { font-family: var(--mono); font-size: 9px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Day chart (historical) ‚îÄ‚îÄ */
    .day-bars { display: flex; align-items: flex-end; gap: 4px; height: 120px; }
    .day-col { flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
    .day-col:hover .day-bar { opacity: 1; }
    .day-bar { width: 100%; border-radius: 4px 4px 0 0; background: var(--accent); opacity: 0.6; min-height: 3px; transition: all 0.3s; }
    .day-bar.today { background: var(--success); opacity: 0.9; }
    .day-cnt { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-bottom: 3px; }
    .day-lbl { font-family: var(--mono); font-size: 10px; color: var(--text-3); margin-top: 4px; }

    /* ‚îÄ‚îÄ Cycle detail table ‚îÄ‚îÄ */
    .cycle-table { font-size: 12px; }
    .cycle-table td { padding: 6px 10px; }
    .cycle-table .piece-name { max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .cycle-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .cycle-status.completed { background: var(--success); }
    .cycle-status.interrupted { background: var(--danger); }

    /* ‚îÄ‚îÄ Filter bar ‚îÄ‚îÄ */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 14px; align-items: flex-end; flex-wrap: wrap; }
    .filter-bar .form-group { flex: 1; min-width: 140px; margin-bottom: 0; }

    /* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
    .modal-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300; align-items: center; justify-content: center; }
    .modal-backdrop.active { display: flex; }
    .modal { background: var(--surface); border-radius: 12px; padding: 24px; max-width: 520px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .modal h3 { font-size: 16px; margin-bottom: 16px; }

    /* ‚îÄ‚îÄ Capacity planning ‚îÄ‚îÄ */
    .cap-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .cap-block { padding: 16px; background: var(--bg); border-radius: 8px; }
    .cap-title { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-3); margin-bottom: 10px; }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .metrics-row { grid-template-columns: 1fr 1fr; }
      .cap-summary { grid-template-columns: 1fr; }
    }

    /* ‚îÄ‚îÄ Tracking project cards ‚îÄ‚îÄ */
    .track-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 14px; }
    .track-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; transition: border-color .15s; }
    .track-card:hover { border-color: var(--accent); }
    .track-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .track-card-name { font-size: 15px; font-weight: 700; color: var(--text); }
    .track-card-dates { font-size: 11px; color: var(--text-3); font-family: var(--mono); }
    .track-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
    .track-stat { text-align: center; }
    .track-stat-num { font-family: var(--mono); font-size: 20px; font-weight: 700; }
    .track-stat-label { font-size: 10px; text-transform: uppercase; letter-spacing: .8px; color: var(--text-3); }
    .track-days { display: flex; gap: 2px; align-items: flex-end; height: 36px; }
    .track-day-bar { flex: 1; border-radius: 2px 2px 0 0; background: var(--accent); opacity: .6; min-height: 2px; transition: height .3s; }
    .track-day-bar:hover { opacity: 1; }
  </style>
</head>
<body>

<div class="app-header">
  <h1>Producci√≥n</h1>
  <span class="subtitle">La Buonora</span>
  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('cola')" id="tab-cola">Cola</button>
    <div class="nav-sep"></div>
    <div class="nav-group">
      <button class="nav-tab" id="tab-estaciones">Estaciones ‚ñæ</button>
      <div class="nav-dropdown">
        <div class="dd-label">Estaciones</div>
        <button class="nav-tab" onclick="switchTab('corte')" id="tab-corte">‚úÇ Corte</button>
        <button class="nav-tab" onclick="switchTab('enchape')" id="tab-enchape">‚ñ§ Enchape</button>
        <button class="nav-tab" onclick="switchTab('mecanizado')" id="tab-mecanizado">‚öô Mecanizado</button>
        <button class="nav-tab" onclick="switchTab('packing')" id="tab-packing">üì¶ Packing</button>
      </div>
    </div>
    <div class="nav-group">
      <button class="nav-tab" id="tab-control">Control ‚ñæ</button>
      <div class="nav-dropdown">
        <div class="dd-label">Control</div>
        <button class="nav-tab" onclick="switchTab('capacidad')" id="tab-capacidad">Capacidad</button>
        <button class="nav-tab" onclick="switchTab('historico')" id="tab-historico">Hist√≥rico</button>
        <button class="nav-tab" onclick="switchTab('rendimiento')" id="tab-rendimiento">Rendimiento</button>
      </div>
    </div>
  </nav>
  <div class="header-actions">
    <a href="https://comercial-4xh.pages.dev/" class="btn btn-secondary btn-sm" style="text-decoration:none">‚Üê Comercial</a>
    <button class="dark-toggle" onclick="toggleDark()" title="Modo oscuro/claro">‚óê</button>
  </div>
</div>

<div class="container">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: MECANIZADO (CNC CX100)          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-mecanizado">

  <!-- Sub-tab navigation -->
  <div style="display:flex;gap:4px;margin-bottom:16px;background:var(--bg);border-radius:6px;padding:3px;width:fit-content">
    <button class="nav-tab active" onclick="switchMecSub('tracking')" id="mec-tracking">Tracking</button>
    <button class="nav-tab" onclick="switchMecSub('dia')" id="mec-dia">D√≠a CNC</button>
  </div>

  <!-- SUB: Tracking -->
  <div id="mec-panel-tracking">
  <div class="metrics-row" id="trackMetrics">
    <div class="metric-card"><div class="metric-label">Proyectos activos</div><div class="metric-value" id="tProjects">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas mecanizadas</div><div class="metric-value" id="tPieces">‚Äî</div><div class="metric-sub" id="tPiecesSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo total CNC</div><div class="metric-value" id="tTime">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas MobCloud √∫nicas</div><div class="metric-value" id="tMobParts">‚Äî</div><div class="metric-sub">con ID num√©rico</div></div>
  </div>

  <div class="card">
    <div class="card-title">
      Tracking por servicio MobCloud
      <label style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-3);cursor:pointer;margin-left:12px">
        <input type="checkbox" id="trackOnlyProd" checked onchange="renderTrackProjects();renderTrackMetrics()"> Solo en producci√≥n
      </label>
      <div style="margin-left:auto; display:flex; gap:8px; align-items:flex-end;">
        <div class="form-group" style="margin-bottom:0">
          <label>Desde</label>
          <input type="date" id="trackFrom" onchange="loadTracking()" style="width:150px">
        </div>
        <div class="form-group" style="margin-bottom:0">
          <label>Hasta</label>
          <input type="date" id="trackTo" onchange="loadTracking()" style="width:150px">
        </div>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('week')">7d</button>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('month')">30d</button>
        <button class="btn btn-sm btn-secondary" onclick="trackSetRange('all')">Todo</button>
      </div>
    </div>
    <div id="trackProjectCards" class="empty">Cargando...</div>
  </div>

  <div class="card">
    <div class="card-title">
      Piezas MobCloud detectadas
      <span class="badge" id="trackPartsBadge">0</span>
      <div style="margin-left:auto">
        <input type="text" id="trackPartSearch" placeholder="Buscar part ID..." oninput="renderTrackParts()" style="width:180px;padding:5px 8px;font-size:12px">
      </div>
    </div>
    <p style="font-size:12px;color:var(--text-3);margin-bottom:12px">Piezas con ID num√©rico (MobCloud) ‚Äî muestra el servicio MobCloud al que pertenecen cuando los datos est√°n sincronizados.</p>
    <div class="table-wrap" style="max-height:500px;overflow-y:auto">
      <table class="cycle-table">
        <thead>
          <tr>
            <th>MobCloud Part ID</th>
            <th>Servicio / Proyecto</th>
            <th style="text-align:right">Repeticiones</th>
            <th style="text-align:right">Tiempo total</th>
            <th style="text-align:right">Promedio</th>
            <th>Primera vez</th>
            <th>√öltima vez</th>
          </tr>
        </thead>
        <tbody id="trackPartsBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- end mec-panel-tracking -->

  <!-- SUB: D√≠a CNC -->
  <div id="mec-panel-dia" style="display:none">
  <div class="filter-bar" style="margin-bottom:16px">
    <div class="form-group" style="flex:0 0 180px">
      <label>Fecha</label>
      <input type="date" id="dayDate" onchange="loadDayData()">
    </div>
    <button class="btn btn-sm btn-secondary" onclick="setDayToday()">Hoy</button>
    <button class="btn btn-sm btn-secondary" onclick="shiftDay(-1)">‚Üê Ayer</button>
    <button class="btn btn-sm btn-secondary" onclick="shiftDay(1)">Ma√±ana ‚Üí</button>
  </div>

  <div class="metrics-row" id="dayMetrics">
    <div class="metric-card"><div class="metric-label">Piezas completadas</div><div class="metric-value" id="dPieces">‚Äî</div><div class="metric-sub" id="dPiecesSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo mecanizado</div><div class="metric-value" id="dTime">‚Äî</div><div class="metric-sub" id="dTimeSub"></div></div>
    <div class="metric-card"><div class="metric-label">Promedio / pieza</div><div class="metric-value" id="dAvg">‚Äî</div><div class="metric-sub" id="dAvgSub"></div></div>
    <div class="metric-card"><div class="metric-label">Utilizaci√≥n</div><div class="metric-value" id="dUtil">‚Äî</div></div>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
    <div class="card">
      <div class="card-title">Timeline</div>
      <div class="timeline-container" id="dayTimeline"></div>
    </div>
    <div class="card">
      <div class="card-title">Distribuci√≥n de ciclos</div>
      <div class="hist-wrap" id="dayHistogram"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Ciclos del d√≠a <span class="badge" id="dayCycleCount">0</span></div>
    <div class="filter-bar">
      <div class="form-group" style="flex:0 0 200px">
        <label>Buscar pieza</label>
        <input type="text" id="dayCycleSearch" placeholder="Nombre o ID..." oninput="renderDayCycles()">
      </div>
      <div class="form-group" style="flex:0 0 140px">
        <label>Estado</label>
        <select id="dayCycleFilter" onchange="renderDayCycles()">
          <option value="">Todos</option>
          <option value="completed">Completados</option>
          <option value="interrupted">Interrumpidos</option>
        </select>
      </div>
    </div>
    <div class="table-wrap" style="max-height:400px; overflow-y:auto;">
      <table class="cycle-table">
        <thead>
          <tr>
            <th style="width:30px"></th>
            <th>Pieza</th>
            <th>Proyecto</th>
            <th style="text-align:right">Duraci√≥n</th>
            <th>Inicio</th>
            <th>Fin</th>
            <th>MobCloud ID</th>
          </tr>
        </thead>
        <tbody id="dayCyclesBody"></tbody>
      </table>
    </div>
  </div>
  </div><!-- end mec-panel-dia -->

</div><!-- end panel-mecanizado -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 1: COLA DE PRODUCCI√ìN                  -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel active" id="panel-cola">

  <div class="metrics-row" id="queueMetrics">
    <div class="metric-card"><div class="metric-label">Pendientes</div><div class="metric-value" id="mPending">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">En proceso</div><div class="metric-value" id="mInProgress">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Piezas CNC pendientes</div><div class="metric-value" id="mPiecesPending">‚Äî</div><div class="metric-sub" id="mPiecesPendingSub"></div></div>
    <div class="metric-card"><div class="metric-label">Tiempo CNC estimado</div><div class="metric-value" id="mTimePending">‚Äî</div><div class="metric-sub" id="mTimePendingSub"></div></div>
  </div>

  <div class="card">
    <div class="card-title">
      Cola de producci√≥n
      <span class="badge" id="queueCount">0</span>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button class="btn btn-sm btn-secondary" onclick="recalcAll()">‚Üª Recalcular CNC</button>
        <button class="btn btn-sm btn-primary" onclick="showAddModal()">+ Agregar servicio</button>
        <button class="btn btn-sm btn-success" onclick="showAddFromQuoteModal()">+ Desde cotizaci√≥n</button>
      </div>
    </div>
    
    <div class="filter-bar">
      <div class="form-group" style="flex:0 0 160px">
        <label>Estado</label>
        <select id="queueFilter" onchange="renderQueue()">
          <option value="">Todos</option>
          <option value="pending" selected>Pendientes</option>
          <option value="in_progress">En proceso</option>
          <option value="completed">Completados</option>
          <option value="on_hold">En espera</option>
        </select>
      </div>
      <div class="form-group" style="flex:0 0 160px">
        <label>Buscar</label>
        <input type="text" id="queueSearch" placeholder="Nombre, cliente..." oninput="renderQueue()">
      </div>
    </div>

    <div class="table-wrap">
      <table class="queue-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Servicio</th>
            <th style="text-align:center;min-width:60px"><div>‚úÇ Corte</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>‚ñ§ Enchape</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>‚öô CNC</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th style="text-align:center;min-width:60px"><div>üì¶ Packing</div><div style="display:flex;gap:2px;justify-content:center;font-size:8px;color:var(--text-3);margin-top:2px"><span style="width:20px;text-align:center">M</span><span style="width:20px;text-align:center">A</span></div></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="queueBody"></tbody>
      </table>
    </div>
    <div class="empty" id="queueEmpty" style="display:none">No hay servicios en la cola</div>
  </div>
</div>

<!-- (D√≠a content merged into panel-mecanizado) -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 3: HIST√ìRICO                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-historico">
  <div class="metrics-row" id="histMetrics">
    <div class="metric-card"><div class="metric-label">D√≠as registrados</div><div class="metric-value" id="hDays">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Total piezas</div><div class="metric-value" id="hPieces">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Promedio/d√≠a</div><div class="metric-value" id="hAvgDay">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Promedio/pieza global</div><div class="metric-value" id="hAvgCycle">‚Äî</div></div>
  </div>

  <div class="card">
    <div class="card-title">Producci√≥n diaria (√∫ltimos 30 d√≠as)</div>
    <div class="day-bars" id="histBars" style="height:140px"></div>
    <div style="display:flex; justify-content:space-between; margin-top:12px; font-size:12px; color:var(--text-3);">
      <span>Click en un d√≠a para ver detalle</span>
      <span id="histSummary"></span>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Detalle por d√≠a</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th style="text-align:right">Completadas</th>
            <th style="text-align:right">Interrumpidas</th>
            <th style="text-align:right">Tiempo total</th>
            <th style="text-align:right">Promedio</th>
            <th style="text-align:right">Mediana</th>
            <th style="text-align:right">Utilizaci√≥n</th>
            <th>Rango</th>
          </tr>
        </thead>
        <tbody id="histTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- TAB 4: CAPACIDAD                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-capacidad">
  <div class="metrics-row">
    <div class="metric-card"><div class="metric-label">Capacidad CNC/d√≠a</div><div class="metric-value" id="capPieces">‚Äî</div><div class="metric-sub">piezas promedio</div></div>
    <div class="metric-card"><div class="metric-label">Mecanizado efectivo/d√≠a</div><div class="metric-value" id="capTime">‚Äî</div><div class="metric-sub" id="capTimeSub"></div></div>
    <div class="metric-card"><div class="metric-label">Promedio ciclo</div><div class="metric-value" id="capCycle">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Utilizaci√≥n promedio</div><div class="metric-value" id="capUtil">‚Äî</div></div>
  </div>

  <div class="cap-summary">
    <div class="card">
      <div class="card-title">Carga pendiente en CNC</div>
      <div class="cap-block" id="capQueueBlock">
        <div class="empty">Cargando...</div>
      </div>
    </div>
    <div class="card">
      <div class="card-title">Estimaci√≥n de capacidad</div>
      <div class="cap-block" id="capEstBlock">
        <div class="empty">Cargando...</div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:20px">
    <div class="card-title">Estimaci√≥n vs Realidad</div>
    <p style="font-size:13px; color:var(--text-2); margin-bottom:12px;">Comparaci√≥n entre la estimaci√≥n fija (80s/pieza) y los datos reales de la CNC, basado en el hist√≥rico completo.</p>
    <div id="capComparison"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: PACKING                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-packing">

  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
    <div>
      <h3 style="font-size:18px;font-weight:700;margin:0">Control Pre Packing</h3>
      <p style="font-size:13px;color:var(--text-2);margin-top:2px">Verificaci√≥n de piezas por servicio antes del embalaje</p>
    </div>
    <a href="prepacking.html" target="_blank" class="btn btn-primary" style="text-decoration:none;font-size:14px;padding:10px 20px">
      ‚Üó Abrir Esc√°ner (ventana completa)
    </a>
  </div>

  <div class="metrics-row" id="ppMetrics">
    <div class="metric-card"><div class="metric-label">En producci√≥n (MobCloud)</div><div class="metric-value" id="ppServices">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Scan en proceso</div><div class="metric-value" id="ppInProgress">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Completos</div><div class="metric-value" id="ppComplete">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Scans hoy</div><div class="metric-value" id="ppToday">‚Äî</div></div>
  </div>

  <div class="card">
    <div class="card-title" style="display:flex;justify-content:space-between;align-items:center">
      Estado por servicio
      <button class="btn btn-sm btn-secondary" onclick="loadPrePacking()">‚Üª Actualizar</button>
    </div>
    <div class="table-wrap" style="max-height:500px;overflow-y:auto">
      <table class="queue-table">
        <thead>
          <tr>
            <th>Servicio</th>
            <th>Cliente</th>
            <th style="text-align:center">Esperadas</th>
            <th style="text-align:center">Escaneadas</th>
            <th style="text-align:center">Faltantes</th>
            <th>Progreso</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="ppBody"></tbody>
      </table>
    </div>
    <div class="empty" id="ppEmpty" style="display:none">No hay servicios en producci√≥n, o no se pudo conectar con MobCloud.</div>
  </div>
</div>

</div><!-- /container -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: CORTE                            -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-corte">
  <div class="metrics-row">
    <div class="metric-card"><div class="metric-label">Servicios en cola</div><div class="metric-value" id="cqTotal">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Tiempo corte total</div><div class="metric-value" id="cqTime">‚Äî</div><div class="metric-sub">estimado MobCloud</div></div>
    <div class="metric-card"><div class="metric-label">Cortados (MobCloud)</div><div class="metric-value" id="cqDone">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Pendientes corte</div><div class="metric-value" id="cqPending">‚Äî</div></div>
  </div>
  <div class="card">
    <div class="card-title">‚úÇ Estaci√≥n de Corte ‚Äî Seccionadora SCM</div>
    <p style="color:var(--text-3);font-size:13px;margin-bottom:16px">
      Vista de corte por servicio. Los tiempos de corte provienen de la optimizaci√≥n de MobCloud (desplazamientos de seccionadora).
      <br>Futuro: integraci√≥n directa con seccionadora SCM para tracking en tiempo real.
    </p>
    <div class="table-wrap">
      <table class="queue-table">
        <thead><tr><th>#</th><th>Servicio</th><th>Cliente</th><th style="text-align:right">Tiempo corte</th><th style="text-align:center">Estado MobCloud</th><th style="text-align:center">Packing permitido</th></tr></thead>
        <tbody id="corteBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ESTACI√ìN: ENCHAPE                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-enchape">
  <div class="metrics-row">
    <div class="metric-card"><div class="metric-label">Servicios en cola</div><div class="metric-value" id="eqTotal">‚Äî</div></div>
    <div class="metric-card"><div class="metric-label">Metros tapacanto</div><div class="metric-value" id="eqMeters">‚Äî</div><div class="metric-sub">estimados</div></div>
    <div class="metric-card"><div class="metric-label">Tiempo enchape</div><div class="metric-value" id="eqTime">‚Äî</div><div class="metric-sub">a 7 m/min</div></div>
    <div class="metric-card"><div class="metric-label">Enchapados (MobCloud)</div><div class="metric-value" id="eqDone">‚Äî</div></div>
  </div>
  <div class="card">
    <div class="card-title">‚ñ§ Estaci√≥n de Enchape ‚Äî Enchapadora</div>
    <p style="color:var(--text-3);font-size:13px;margin-bottom:16px">
      Vista de enchape por servicio. Los metros de tapacanto se estiman de los lados con borde de cada pieza.
      <br>Futuro: integraci√≥n directa con enchapadora para tracking en tiempo real.
    </p>
    <div class="table-wrap">
      <table class="queue-table">
        <thead><tr><th>#</th><th>Servicio</th><th>Cliente</th><th style="text-align:right">Lados</th><th style="text-align:right">Metros est.</th><th style="text-align:right">Tiempo est.</th><th style="text-align:center">Estado MobCloud</th></tr></thead>
        <tbody id="enchapeBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- CONTROL: RENDIMIENTO                       -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="tab-panel" id="panel-rendimiento">
  <div class="card">
    <div class="card-title">Rendimiento ‚Äî Estimado vs Real por estaci√≥n</div>
    <p style="color:var(--text-3);font-size:13px;margin-bottom:16px">
      Comparaci√≥n de tiempos estimados vs reales para cada estaci√≥n de producci√≥n.
      <br>Actualmente solo disponible para Mecanizado CNC (datos reales de ciclos).
    </p>
    <div id="rendimientoContent">
      <div class="empty">Cargando datos de rendimiento...</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-backdrop" id="addModal">
  <div class="modal">
    <h3>Agregar servicio a la cola</h3>
    <div class="form-row">
      <div class="form-group"><label>Service ID (MobCloud)</label><input type="number" id="mServiceId"></div>
      <div class="form-group"><label>Nombre</label><input type="text" id="mServiceName" placeholder="Ej: Cocina L√≥pez"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Cliente</label><input type="text" id="mClientName"></div>
      <div class="form-group"><label>Fecha programada</label><input type="date" id="mScheduledDate"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Descripci√≥n</label><input type="text" id="mDescription" placeholder="Notas..."></div>
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('addModal')">Cancelar</button>
      <button class="btn btn-primary" onclick="addManualService()">Agregar</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="quoteModal">
  <div class="modal">
    <h3>Agregar desde cotizaci√≥n aceptada</h3>
    <p style="font-size:13px; color:var(--text-2); margin-bottom:14px;">Seleccion√° una cotizaci√≥n aceptada para agregar sus servicios a la cola de producci√≥n.</p>
    <div id="quoteList" class="empty">Cargando cotizaciones...</div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
      <button class="btn btn-secondary" onclick="closeModal('quoteModal')">Cerrar</button>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner" style="width:32px;height:32px;border-width:3px"></div>
  <span id="loadingText" style="color:var(--text-2);font-size:14px">Cargando...</span>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = "https://qnjizqowddtvzzfillmo.supabase.co";
const SUPABASE_ANON = "sb_publishable_Agu_I1nw4mY1qRARQBbaHQ_6lTWsFTh";
const APP_KEY = "";
const MACHINE_ID = "cx100";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const qs = s => document.querySelector(s);
const qa = s => document.querySelectorAll(s);

function fmtSec(s) { if (s==null) return "‚Äî"; s=Math.round(s); return s>=60?`${Math.floor(s/60)}m ${s%60}s`:`${s}s`; }
function fmtMin(s) { if (s==null) return "‚Äî"; const m=Math.round(s/60); return m>=60?`${Math.floor(m/60)}h ${m%60}m`:`${m} min`; }
function fmtMinFromMin(m) { if (m==null) return "‚Äî"; m=Math.round(m); return m>=60?`${Math.floor(m/60)}h ${m%60}m`:`${m} min`; }
function fmtTime(iso) { if (!iso) return "‚Äî"; return new Date(iso).toLocaleTimeString("es-UY",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:false}); }
function fmtTimeShort(iso) { if (!iso) return ""; return new Date(iso).toLocaleTimeString("es-UY",{hour:"2-digit",minute:"2-digit",hour12:false}); }
function cleanName(n) { return (n||"").replace(/^\[J\]\s*/,""); }
function todayStr() { const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }
function escH(s) { return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;"); }

const DAY_NAMES = ["Dom","Lun","Mar","Mi√©","Jue","Vie","S√°b"];

async function sbQuery(table, params="") {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?${params}`, {
    headers: { "apikey":SUPABASE_ANON, "Authorization":`Bearer ${SUPABASE_ANON}`, "Accept":"application/json" }
  });
  if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

async function invokeFunction(name, payload) {
  const r = await fetch(`${SUPABASE_URL}/functions/v1/${name}`, {
    method:"POST",
    headers: { "Content-Type":"application/json", "apikey":SUPABASE_ANON, "Authorization":`Bearer ${SUPABASE_ANON}` },
    body: JSON.stringify(payload)
  });
  const data = await r.json();
  if (!r.ok) throw new Error(data.error || data.message || r.statusText);
  return data;
}

function toast(msg, type="info") {
  const t = document.createElement("div");
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  qs("#toastContainer").appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

function showLoading(msg="Cargando...") { qs("#loadingText").textContent=msg; qs("#loadingOverlay").classList.add("active"); }
function hideLoading() { qs("#loadingOverlay").classList.remove("active"); }
function showModal(id) { document.getElementById(id).classList.add("active"); }
function closeModal(id) { document.getElementById(id).classList.remove("active"); }

function toggleDark() {
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("dark", document.documentElement.classList.contains("dark"));
}
if (localStorage.getItem("dark")==="true") document.documentElement.classList.add("dark");

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTab = "cola";
const ESTACIONES_TABS = ["corte","enchape","mecanizado","packing"];
const CONTROL_TABS = ["capacidad","historico","rendimiento"];

function switchTab(tab) {
  currentTab = tab;
  // Deactivate all tabs and panels
  qa(".nav-tab").forEach(t => t.classList.remove("active"));
  qa(".tab-panel").forEach(p => p.classList.remove("active"));
  
  // Activate the clicked tab button
  const tabBtn = qs(`#tab-${tab}`);
  if (tabBtn) tabBtn.classList.add("active");
  
  // Highlight parent dropdown label
  if (ESTACIONES_TABS.includes(tab)) {
    qs("#tab-estaciones").classList.add("active");
  } else if (CONTROL_TABS.includes(tab)) {
    qs("#tab-control").classList.add("active");
  }
  
  // Show panel ‚Äî D√≠a is a sub-section of mecanizado, handle separately  
  const panel = qs(`#panel-${tab}`);
  if (panel) panel.classList.add("active");
  
  // Load data for the tab
  const loaders = {
    cola: loadQueue,
    corte: loadCorte,
    enchape: loadEnchape,
    mecanizado: loadTracking,
    packing: loadPrePacking,
    capacidad: loadCapacity,
    historico: loadHistorical,
    rendimiento: loadRendimiento,
  };
  if (loaders[tab]) loaders[tab]();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MECANIZADO SUB-TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchMecSub(sub) {
  ["tracking","dia"].forEach(s => {
    const p = qs(`#mec-panel-${s}`);
    const t = qs(`#mec-${s}`);
    if (p) p.style.display = s === sub ? "" : "none";
    if (t) t.classList.toggle("active", s === sub);
  });
  if (sub === "dia") loadDayData();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTACI√ìN: CORTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadCorte() {
  try {
    const data = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc");
    const items = data.filter(i => i.status !== "completed");
    
    const total = items.length;
    const cutDone = items.filter(i => (i.stations||{}).corte === "completed").length;
    const totalCutMin = items.reduce((s,i) => s + (i.cutting_time_est||0), 0);
    
    qs("#cqTotal").textContent = total;
    qs("#cqTime").textContent = fmtMinFromMin(totalCutMin);
    qs("#cqDone").textContent = cutDone;
    qs("#cqPending").textContent = total - cutDone;
    
    qs("#corteBody").innerHTML = items.map((item, idx) => {
      const st = (item.stations||{}).corte || "pending";
      const dotIcon = st === "completed" ? "‚úì" : st === "in_progress" ? "‚ñ∂" : "¬∑";
      const cutMin = item.cutting_time_est || 0;
      return `<tr>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${idx+1}</td>
        <td><div class="svc-name">${escH(item.service_name||"")}</div></td>
        <td class="svc-client">${escH(item.client_name||"")}</td>
        <td style="text-align:right;font-family:var(--mono)">${cutMin > 0 ? fmtMinFromMin(cutMin) : "‚Äî"}</td>
        <td style="text-align:center"><div class="dot-mob ${st}" style="margin:0 auto">${dotIcon}</div></td>
        <td style="text-align:center;font-size:12px">${item.packing_allowed ? "‚úì" : "‚Äî"}</td>
      </tr>`;
    }).join("");
  } catch(e) { toast(e.message,"error"); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESTACI√ìN: ENCHAPE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadEnchape() {
  try {
    const data = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc");
    const items = data.filter(i => i.status !== "completed");
    
    const total = items.length;
    const edgeDone = items.filter(i => (i.stations||{}).enchape === "completed").length;
    const totalEdgeSides = items.reduce((s,i) => s + (i.total_edge_sides||0), 0);
    const totalEdgeMeters = items.reduce((s,i) => s + (i.edge_meters||0), 0);
    const totalEdgeMin = items.reduce((s,i) => s + (i.edge_time_est_min||0), 0);
    
    qs("#eqTotal").textContent = total;
    qs("#eqMeters").textContent = `${Math.round(totalEdgeMeters)} m`;
    qs("#eqTime").textContent = fmtMinFromMin(totalEdgeMin);
    qs("#eqDone").textContent = edgeDone;
    
    qs("#enchapeBody").innerHTML = items.map((item, idx) => {
      const st = (item.stations||{}).enchape || "pending";
      const dotIcon = st === "completed" ? "‚úì" : st === "in_progress" ? "‚ñ∂" : "¬∑";
      return `<tr>
        <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${idx+1}</td>
        <td><div class="svc-name">${escH(item.service_name||"")}</div></td>
        <td class="svc-client">${escH(item.client_name||"")}</td>
        <td style="text-align:right;font-family:var(--mono)">${item.total_edge_sides||0}</td>
        <td style="text-align:right;font-family:var(--mono)">${(item.edge_meters||0).toFixed(1)} m</td>
        <td style="text-align:right;font-family:var(--mono)">${item.edge_time_est_min ? fmtMinFromMin(item.edge_time_est_min) : "‚Äî"}</td>
        <td style="text-align:center"><div class="dot-mob ${st}" style="margin:0 auto">${dotIcon}</div></td>
      </tr>`;
    }).join("");
  } catch(e) { toast(e.message,"error"); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTROL: RENDIMIENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadRendimiento() {
  try {
    const [cap, queue] = await Promise.all([
      invokeFunction("production-service", { action:"capacity" }),
      sbQuery("production_queue_status", "status=in.(pending,in_progress)&order=priority.asc"),
    ]);
    
    const realAvg = cap.avg_cycle_seconds || 75;
    const fixedEst = 80;
    const diffPct = ((realAvg / fixedEst) - 1) * 100;

    // Services with CNC data
    const withCNC = queue.filter(i => (i.cnc_total_seconds||0) > 0 && (i.cnc_parts_done||0) > 0);
    
    qs("#rendimientoContent").innerHTML = `
      <div class="card" style="margin-bottom:16px">
        <div class="card-title">‚öô Mecanizado CNC ‚Äî Estimado vs Real</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center;margin-bottom:20px">
          <div style="padding:16px;background:var(--bg);border-radius:8px;">
            <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Estimaci√≥n fija</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700">80s</div>
            <div style="font-size:12px;color:var(--text-3)">por pieza</div>
          </div>
          <div style="padding:16px;background:var(--bg);border-radius:8px;">
            <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Promedio real</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700;color:var(--accent)">${Math.round(realAvg)}s</div>
            <div style="font-size:12px;color:var(--text-3)">por pieza (${cap.days_count} d√≠as)</div>
          </div>
          <div style="padding:16px;background:${diffPct>10?'var(--danger)':diffPct<-10?'var(--success)':'var(--warn)'};border-radius:8px;color:white;">
            <div style="font-size:12px;opacity:.8;margin-bottom:8px">Diferencia</div>
            <div style="font-family:var(--mono);font-size:32px;font-weight:700">${diffPct>0?"+":""}${Math.round(diffPct)}%</div>
            <div style="font-size:12px;opacity:.8">${diffPct>0?"Real m√°s lento":"Real m√°s r√°pido"}</div>
          </div>
        </div>
        ${withCNC.length ? `
        <div class="card-title">Por servicio (con datos CNC reales)</div>
        <div class="table-wrap">
          <table class="queue-table">
            <thead><tr><th>Servicio</th><th style="text-align:right">Piezas CNC</th><th style="text-align:right">Estimado</th><th style="text-align:right">Real</th><th style="text-align:right">Diferencia</th></tr></thead>
            <tbody>${withCNC.map(i => {
              const realSec = i.cnc_total_seconds;
              const estSec = (i.cnc_parts_done||0) * 80;
              const diff = estSec > 0 ? Math.round(((realSec/estSec)-1)*100) : 0;
              return `<tr>
                <td>${escH(i.service_name||"")}</td>
                <td style="text-align:right;font-family:var(--mono)">${i.cnc_parts_done}/${i.parts_with_machining}</td>
                <td style="text-align:right;font-family:var(--mono)">${fmtMin(estSec)}</td>
                <td style="text-align:right;font-family:var(--mono);font-weight:600">${fmtMin(realSec)}</td>
                <td style="text-align:right;font-family:var(--mono);color:${diff>10?'var(--danger)':diff<-10?'var(--success)':'var(--text)'}">${diff>0?"+":""}${diff}%</td>
              </tr>`;
            }).join("")}</tbody>
          </table>
        </div>` : `<p style="color:var(--text-3)">No hay servicios con datos CNC reales todav√≠a.</p>`}
      </div>
      <div class="card">
        <div class="card-title">‚úÇ Corte / ‚ñ§ Enchape ‚Äî Solo estimaciones</div>
        <p style="color:var(--text-3);font-size:13px">
          Los datos reales de corte y enchape estar√°n disponibles cuando se integren las m√°quinas correspondientes.
          Actualmente solo se muestran estimaciones de MobCloud.
        </p>
      </div>
    `;
  } catch(e) { toast(e.message,"error"); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 0: TRACKING POR PROYECTO (MECANIZADO)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let trackServices = [];
let trackProjects = [];
let trackParts = [];
let hasServiceMap = false;

function trackSetRange(range) {
  const to = new Date();
  const toStr = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  qs("#trackTo").value = toStr(to);
  if (range === "week") { const f = new Date(); f.setDate(f.getDate()-7); qs("#trackFrom").value = toStr(f); }
  else if (range === "month") { const f = new Date(); f.setDate(f.getDate()-30); qs("#trackFrom").value = toStr(f); }
  else { qs("#trackFrom").value = ""; }
  loadTracking();
}

async function loadTracking() {
  try {
    // Ensure queueData is loaded for production filter
    if (!queueData.length) {
      try { queueData = await sbQuery("production_queue_status", "order=priority.asc,created_at.asc"); } catch {}
    }
    
    const from = qs("#trackFrom").value;
    const to = qs("#trackTo").value;
    let dateFilter = "";
    if (from) dateFilter += `&log_date=gte.${from}`;
    if (to) dateFilter += `&log_date=lte.${to}`;

    // Try service-level progress (requires parts_list_json + SQL views)
    let services = [];
    let partsEnriched = [];
    try {
      [services, partsEnriched] = await Promise.all([
        sbQuery("cnc_service_progress", "order=total_cnc_seconds.desc"),
        sbQuery("cnc_part_stats_enriched", "order=total_seconds.desc&limit=1000"),
      ]);
    } catch(e) {
      console.warn("Service views not available:", e.message);
    }

    const [projects, parts] = await Promise.all([
      sbQuery("cnc_project_progress", `machine_id=eq.${MACHINE_ID}${dateFilter}&order=log_date.desc`),
      sbQuery("cnc_part_stats", `order=total_seconds.desc&limit=1000`),
    ]);

    trackServices = services;
    trackProjects = projects;
    trackParts = partsEnriched.length > 0 ? partsEnriched : parts;
    hasServiceMap = services.length > 0;

    renderTrackMetrics();
    renderTrackProjects();
    renderTrackParts();
  } catch(e) { toast(e.message, "error"); }
}

function renderTrackMetrics() {
  if (hasServiceMap) {
    const filtered = getFilteredTrackServices();
    const totalCycles = filtered.reduce((s, r) => s + (r.total_cycles || 0), 0);
    const totalSeconds = filtered.reduce((s, r) => s + (r.total_cnc_seconds || 0), 0);
    const totalMobParts = filtered.reduce((s, r) => s + (r.parts_machined || 0), 0);
    qs("#tProjects").textContent = filtered.length;
    qs("#tPieces").textContent = totalCycles.toLocaleString();
    qs("#tPiecesSub").textContent = `ciclos completados`;
    qs("#tTime").textContent = fmtMin(totalSeconds);
    qs("#tMobParts").textContent = totalMobParts;
  } else {
    const byProject = {};
    for (const row of trackProjects) byProject[row.project_folder || "(sin carpeta)"] = true;
    const totalCycles = trackProjects.reduce((s, r) => s + (r.completed_cycles || 0), 0);
    const totalSeconds = trackProjects.reduce((s, r) => s + (r.total_seconds || 0), 0);
    qs("#tProjects").textContent = Object.keys(byProject).length;
    qs("#tPieces").textContent = totalCycles.toLocaleString();
    qs("#tPiecesSub").textContent = `ciclos completados`;
    qs("#tTime").textContent = fmtMin(totalSeconds);
    qs("#tMobParts").textContent = trackParts.filter(p => p.mob_part_id).length;
  }
}

function renderTrackProjects() {
  const container = qs("#trackProjectCards");
  if (hasServiceMap) {
    renderServiceCards(container);
  } else {
    renderFolderCards(container);
  }
}

function getFilteredTrackServices() {
  let svcs = trackServices.filter(s => s.total_cycles > 0 || s.parts_needing_machining > 0);
  if (qs("#trackOnlyProd").checked && queueData.length > 0) {
    const prodIds = new Set(queueData.map(q => q.service_id));
    svcs = svcs.filter(s => prodIds.has(s.service_id));
  }
  return svcs;
}

function renderServiceCards(container) {
  const services = getFilteredTrackServices();
  if (!services.length) {
    container.innerHTML = `<div class="empty">Servicios sincronizados pero sin actividad CNC detectada a√∫n</div>`;
    return;
  }

  container.innerHTML = `<div class="track-grid">${services.map(svc => {
    const pct = svc.progress_pct || 0;
    const barClass = pct >= 100 ? "green" : pct > 0 ? "blue" : "amber";
    const avgSec = svc.avg_seconds_per_cycle || 0;
    const estMin = svc.parts_needing_machining > 0 ? Math.round(svc.parts_needing_machining * 75 / 60) : 0;
    const realMin = svc.total_cnc_seconds > 0 ? Math.round(svc.total_cnc_seconds / 60) : 0;

    return `
      <div class="track-card">
        <div class="track-card-header">
          <div>
            <div class="track-card-name">${escH(svc.service_name)}</div>
            <div style="font-size:12px;color:var(--text-2);margin-top:2px">
              ${svc.client_name ? escH(svc.client_name) : ""}
              ${svc.quote_ref ? `<span style="color:var(--text-3)">(${escH(svc.quote_ref)})</span>` : ""}
            </div>
            <div class="track-card-dates" style="margin-top:2px">
              Servicio #${svc.service_id}
              ${svc.first_machined_at ? ` ‚Äî ${new Date(svc.first_machined_at).toLocaleDateString("es-UY")} ‚Üí ${new Date(svc.last_machined_at).toLocaleDateString("es-UY")}` : ""}
            </div>
          </div>
        </div>
        <div style="margin:12px 0 8px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
            <span style="color:var(--text-2)">Piezas CNC: <strong>${svc.parts_machined}</strong> / ${svc.parts_needing_machining}</span>
            <span style="font-family:var(--mono);font-weight:700;color:${pct>=100?'var(--success)':'var(--accent)'}">${pct}%</span>
          </div>
          <div class="progress-bar" style="height:10px">
            <div class="progress-fill ${barClass}" style="width:${Math.min(100,pct)}%"></div>
          </div>
        </div>
        <div class="track-stats">
          <div class="track-stat">
            <div class="track-stat-num" style="color:var(--accent)">${svc.total_cycles}</div>
            <div class="track-stat-label">Ciclos</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${realMin > 0 ? fmtMinFromMin(realMin) : "‚Äî"}</div>
            <div class="track-stat-label">Tiempo real</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtSec(avgSec)}</div>
            <div class="track-stat-label">Prom/pieza</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;font-size:11px;color:var(--text-3);margin-top:4px">
          <span>Est CNC: ${fmtMinFromMin(estMin)}</span>
          <span>Piezas servicio: ${svc.total_parts_in_service}</span>
          <span>Qty esperada: ${svc.total_qty_expected}</span>
        </div>
      </div>
    `;
  }).join("")}</div>`;
}

function renderFolderCards(container) {
  const byProject = {};
  for (const row of trackProjects) {
    const key = row.project_folder || "(sin carpeta)";
    if (!byProject[key]) byProject[key] = { 
      name: key, totalCycles: 0, totalSeconds: 0,
      days: {}, firstDate: row.log_date, lastDate: row.log_date
    };
    const p = byProject[key];
    p.totalCycles += row.completed_cycles || 0;
    p.totalSeconds += row.total_seconds || 0;
    p.days[row.log_date] = (p.days[row.log_date] || 0) + (row.completed_cycles || 0);
    if (row.log_date < p.firstDate) p.firstDate = row.log_date;
    if (row.log_date > p.lastDate) p.lastDate = row.log_date;
  }
  const projects = Object.values(byProject).sort((a, b) => b.totalCycles - a.totalCycles);
  if (!projects.length) {
    container.innerHTML = `<div class="empty">Sin datos para el rango seleccionado</div>`;
    return;
  }

  container.innerHTML = `
    <div style="padding:10px 14px;background:var(--accent-light);border-radius:6px;margin-bottom:14px;font-size:13px;color:var(--accent)">
      <strong>Nota:</strong> Mostrando por carpeta CNC. Para ver por proyecto MobCloud real, 
      ejecutar la migraci√≥n SQL de <code>cnc_part_service_map</code>, aplicar el patch de <code>parts_list_json</code> 
      en sales-quotes-service y re-sincronizar los servicios desde Comercial.
    </div>
    <div class="track-grid">${projects.map(p => {
    const avgSec = p.totalCycles > 0 ? Math.round(p.totalSeconds / p.totalCycles) : 0;
    const daysCount = Object.keys(p.days).length;
    const allDates = Object.keys(p.days).sort();
    const maxDay = Math.max(...Object.values(p.days), 1);
    const dayBars = allDates.map(d => {
      const h = (p.days[d] / maxDay) * 30;
      const dateObj = new Date(d + "T12:00:00");
      return `<div class="track-day-bar" style="height:${Math.max(2,h)}px" title="${d} (${DAY_NAMES[dateObj.getDay()]}): ${p.days[d]} piezas"></div>`;
    }).join("");
    const projectMobParts = trackParts.filter(pt => pt.project_folder === (p.name === "(sin carpeta)" ? null : p.name));

    return `
      <div class="track-card">
        <div class="track-card-header">
          <div>
            <div class="track-card-name">${escH(p.name)}</div>
            <div class="track-card-dates">${p.firstDate} ‚Üí ${p.lastDate} (${daysCount} d√≠as)</div>
          </div>
          <span style="font-family:var(--mono);font-size:12px;color:var(--accent)">${projectMobParts.length} IDs MobCloud</span>
        </div>
        <div class="track-stats">
          <div class="track-stat">
            <div class="track-stat-num" style="color:var(--accent)">${p.totalCycles}</div>
            <div class="track-stat-label">Ciclos</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtMin(p.totalSeconds)}</div>
            <div class="track-stat-label">Tiempo</div>
          </div>
          <div class="track-stat">
            <div class="track-stat-num">${fmtSec(avgSec)}</div>
            <div class="track-stat-label">Promedio</div>
          </div>
        </div>
        ${dayBars ? `<div style="margin-top:4px"><div style="font-size:10px;color:var(--text-3);margin-bottom:4px">Producci√≥n por d√≠a</div><div class="track-days">${dayBars}</div></div>` : ""}
      </div>
    `;
  }).join("")}</div>`;
}

function renderTrackParts() {
  const search = (qs("#trackPartSearch").value || "").toLowerCase();
  let items = trackParts;
  if (search) items = items.filter(p => 
    String(p.mob_part_id).includes(search) ||
    (p.piece_name||"").toLowerCase().includes(search) ||
    (p.project_folder||"").toLowerCase().includes(search) ||
    (p.service_name||"").toLowerCase().includes(search) ||
    (p.client_name||"").toLowerCase().includes(search) ||
    (p.quote_ref||"").toLowerCase().includes(search) ||
    String(p.service_id||"").includes(search)
  );
  qs("#trackPartsBadge").textContent = items.length;

  // Check if we have enriched data (service_name present)
  const enriched = items.length > 0 && items[0].service_name !== undefined;

  qs("#trackPartsBody").innerHTML = items.map(p => `
    <tr>
      <td style="font-family:var(--mono);font-weight:600">${p.mob_part_id}</td>
      <td style="font-size:12px;color:var(--text-2)">${enriched && p.service_name 
        ? `${escH(p.service_name)}${p.client_name ? ' <span style="color:var(--text-3)">'+escH(p.client_name)+'</span>' : ''}${p.quote_ref ? ' <span style="font-family:var(--mono);font-size:10px;color:var(--text-3)">('+escH(p.quote_ref)+')</span>' : ''}` 
        : escH(p.project_folder || "‚Äî")}</td>
      <td style="text-align:right;font-family:var(--mono)">${p.repetitions_completed}${p.repetitions_interrupted > 0 ? ` <span style="color:var(--danger)">(+${p.repetitions_interrupted}‚úó)</span>` : ""}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(p.total_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(p.avg_seconds)}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${p.first_seen ? new Date(p.first_seen).toLocaleDateString("es-UY") : "‚Äî"}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${p.last_seen ? new Date(p.last_seen).toLocaleDateString("es-UY") : "‚Äî"}</td>
    </tr>
  `).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 1: COLA DE PRODUCCI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let queueData = [];
let packingProgress = {};  // service_id ‚Üí {total, scanned, complete}

async function loadQueue() {
  try {
    // Auto-sync production queue from MobCloud
    try {
      const syncResult = await invokeFunction("production-service", { action: "sync-queue" });
      const msgs = [];
      if (syncResult.synced > 0) msgs.push(`${syncResult.synced} nuevos`);
      if (syncResult.updated > 0) msgs.push(`${syncResult.updated} actualizados`);
      if (syncResult.cleaned > 0) msgs.push(`${syncResult.cleaned} eliminados`);
      if (msgs.length) toast(`MobCloud: ${msgs.join(", ")}`, "success");
    } catch (e) {
      console.warn("sync-queue failed (offline?):", e.message);
    }
    
    // Load queue + packing progress in parallel
    const [qData, ppData] = await Promise.all([
      sbQuery("production_queue_status", "order=priority.asc,created_at.asc"),
      sbQuery("vw_packing_service_progress", "").catch(() => []),
    ]);
    queueData = qData;
    
    packingProgress = {};
    for (const p of ppData) {
      packingProgress[p.service_id] = {
        total: p.total_expected || 0,
        scanned: p.total_scanned || 0,
        complete: (p.pct_complete || 0) >= 100,
      };
    }
    
    renderQueue();
  } catch(e) { toast(e.message,"error"); }
}

function renderQueue() {
  const filter = qs("#queueFilter").value;
  const search = qs("#queueSearch").value.toLowerCase();
  let items = queueData;
  if (filter) items = items.filter(i => i.status === filter);
  if (search) items = items.filter(i => 
    (i.service_name||"").toLowerCase().includes(search) || 
    (i.client_name||"").toLowerCase().includes(search) ||
    String(i.service_id).includes(search)
  );

  qs("#queueCount").textContent = items.length;
  qs("#queueEmpty").style.display = items.length ? "none" : "block";

  // Metrics
  const pending = queueData.filter(i => i.status==="pending" || i.status==="in_progress");
  const piecesPending = pending.reduce((s,i) => s + Math.max(0, (i.parts_with_machining||0) - (i.cnc_parts_done||0)), 0);
  const timePendingSec = piecesPending * 75;
  qs("#mPending").textContent = queueData.filter(i=>i.status==="pending").length;
  qs("#mInProgress").textContent = queueData.filter(i=>i.status==="in_progress").length;
  qs("#mPiecesPending").textContent = piecesPending;
  qs("#mPiecesPendingSub").textContent = `de ${pending.reduce((s,i)=>s+(i.parts_with_machining||0),0)} totales`;
  qs("#mTimePending").textContent = fmtMin(timePendingSec);
  qs("#mTimePendingSub").textContent = `~${Math.ceil(piecesPending / 184)} d√≠as h√°biles`;

  const tbody = qs("#queueBody");
  tbody.innerHTML = items.map((item, idx) => {
    const pct = item.cnc_progress_pct || 0;
    const cncEst = item.cnc_time_est_min ? fmtMinFromMin(item.cnc_time_est_min) : "";
    const cncReal = item.cnc_total_seconds > 0 ? fmtMin(item.cnc_total_seconds) : "";
    const cutEst = item.cutting_time_est > 0 ? fmtMinFromMin(item.cutting_time_est) : "";
    const edgeEst = item.edge_time_est_min ? fmtMinFromMin(item.edge_time_est_min) : "";

    // MobCloud stations (manual, from Alan)
    const st = item.stations || {};
    const stCorte = st.corte || "pending";
    const stEnchape = st.enchape || "pending";
    const stMecanizado = st.mecanizado || "pending";
    const stPacking = st.packing || "pending";
    
    // Auto-detected stations (from real machine data)
    // Corte: no machine integration yet ‚Üí no_data
    const autoCorte = "no_data";
    // Enchape: no machine integration yet ‚Üí no_data
    const autoEnchape = "no_data";
    // Mecanizado: from CNC cycles (real data!)
    const autoCNC = pct >= 100 ? "completed" : pct > 0 ? "in_progress" : "pending";
    // Packing: from barcode scans
    const pp = packingProgress[item.service_id];
    const autoPacking = pp ? (pp.complete ? "completed" : pp.scanned > 0 ? "in_progress" : "pending") : "no_data";
    
    const dotIcon = s => s === "completed" ? "‚úì" : s === "in_progress" ? "‚ñ∂" : s === "no_data" ? "" : "¬∑";

    // Dual cell helper: MobCloud circle + Auto square
    const dualCell = (mob, auto, info) => `
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${mob}" onclick="cycleStation('${item.id}','${mob === stCorte ? 'corte' : mob === stEnchape ? 'enchape' : mob === stMecanizado ? 'mecanizado' : 'packing'}',this)" title="MobCloud (manual)">${dotIcon(mob)}</div>
          <div class="dot-auto ${auto}" title="Auto-detectado">${dotIcon(auto)}</div>
        </div>
        ${info ? `<div class="station-info">${info}</div>` : ""}
      </td>`;
    
    return `<tr data-id="${item.id}">
      <td style="color:var(--text-3);font-family:var(--mono);font-size:11px">${idx+1}</td>
      <td>
        <div class="svc-name">${escH(item.service_name||"")} <span style="font-family:var(--mono);font-size:11px;color:var(--text-3)">#${item.service_id}</span></div>
        ${item.client_name ? `<div class="svc-client">${escH(item.client_name)}</div>` : ""}
        ${item.description ? `<div class="svc-desc">${escH(item.description)}</div>` : ""}
        ${item.scheduled_date ? `<div style="font-size:10px;color:var(--text-3);font-family:var(--mono);margin-top:2px">üìÖ ${item.scheduled_date}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stCorte}" onclick="cycleStation('${item.id}','corte',this)" title="MobCloud (manual)">${dotIcon(stCorte)}</div>
          <div class="dot-auto ${autoCorte}" title="Auto-detectado">${dotIcon(autoCorte)}</div>
        </div>
        ${cutEst ? `<div class="station-info">${cutEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stEnchape}" onclick="cycleStation('${item.id}','enchape',this)" title="MobCloud (manual)">${dotIcon(stEnchape)}</div>
          <div class="dot-auto ${autoEnchape}" title="Auto-detectado">${dotIcon(autoEnchape)}</div>
        </div>
        ${edgeEst ? `<div class="station-info">${edgeEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stMecanizado}" onclick="cycleStation('${item.id}','mecanizado',this)" title="MobCloud (manual)">${dotIcon(stMecanizado)}</div>
          <div class="dot-auto ${autoCNC}" title="Auto: ${item.cnc_parts_done||0}/${item.parts_with_machining||0}">${dotIcon(autoCNC)}</div>
        </div>
        <div class="station-info">${item.cnc_parts_done||0}/${item.parts_with_machining||0} pzas</div>
        ${cncEst || cncReal ? `<div class="station-info">${cncReal ? '<b>'+cncReal+'</b>' : cncEst}</div>` : ""}
      </td>
      <td class="station-cell">
        <div class="dual-dots">
          <div class="dot-mob ${stPacking}" onclick="cycleStation('${item.id}','packing',this)" title="MobCloud (manual)">${dotIcon(stPacking)}</div>
          <div class="dot-auto ${autoPacking}" title="Auto: scanner">${dotIcon(autoPacking)}</div>
        </div>
        ${pp ? `<div class="station-info">${pp.scanned}/${pp.total}</div>` : ""}
      </td>
      <td class="queue-actions">
        <button class="btn btn-sm btn-secondary" onclick="removeFromQueue('${item.id}')" title="Quitar">‚úï</button>
      </td>
    </tr>`;
  }).join("");
}

function statusLabel(s) {
  return {pending:"Pendiente",in_progress:"En proceso",completed:"Completado",on_hold:"En espera"}[s]||s;
}

async function updateStatus(id, status) {
  try {
    await invokeFunction("production-service", { action:"update", id, status });
    toast(`Estado ‚Üí ${statusLabel(status)}`,"success");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
}

async function removeFromQueue(id) {
  if (!confirm("¬øQuitar este servicio de la cola?")) return;
  try {
    await invokeFunction("production-service", { action:"remove", id });
    toast("Servicio quitado","info");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
}

// Station status cycling: pending ‚Üí in_progress ‚Üí completed ‚Üí pending
const STATION_CYCLE = { pending: "in_progress", in_progress: "completed", completed: "pending" };

async function cycleStation(itemId, station, dotEl) {
  const item = queueData.find(i => i.id === itemId);
  if (!item) return;
  
  const st = item.stations || {};
  const current = st[station] || "pending";
  const next = STATION_CYCLE[current] || "pending";
  st[station] = next;
  item.stations = st;

  // Visual update immediately
  const icon = next === "completed" ? "‚úì" : next === "in_progress" ? "‚ñ∂" : "¬∑";
  dotEl.className = `dot-mob ${next}`;
  dotEl.textContent = icon;

  // Auto-update overall status based on stations
  let newStatus = item.status;
  const allStations = ["corte","enchape","mecanizado","packing"];
  const allCompleted = allStations.every(s => (st[s] || "pending") === "completed");
  const anyInProgress = allStations.some(s => ["in_progress","completed"].includes(st[s] || "pending"));
  if (allCompleted) newStatus = "completed";
  else if (anyInProgress) newStatus = "in_progress";
  else newStatus = "pending";

  // Persist
  try {
    await invokeFunction("production-service", { 
      action: "update-stations", 
      id: itemId, 
      stations: st,
      status: newStatus
    });
  } catch(e) { 
    console.warn("Station save:", e.message);
  }
}

async function recalcAll() {
  showLoading("Recalculando progreso CNC...");
  try {
    const r = await invokeFunction("production-service", { action:"recalc" });
    toast(`Recalculados: ${r.recalculated?.length || 0} servicios`,"success");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

function showAddModal() { showModal("addModal"); }

async function addManualService() {
  const sid = qs("#mServiceId").value;
  if (!sid) { toast("Ingres√° el Service ID","error"); return; }
  showLoading("Agregando...");
  try {
    await invokeFunction("production-service", {
      action: "add-manual",
      service_id: parseInt(sid),
      service_name: qs("#mServiceName").value,
      client_name: qs("#mClientName").value,
      description: qs("#mDescription").value,
      scheduled_date: qs("#mScheduledDate").value || null,
    });
    toast("Servicio agregado","success");
    closeModal("addModal");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

async function showAddFromQuoteModal() {
  showModal("quoteModal");
  const list = qs("#quoteList");
  list.innerHTML = '<div class="empty"><div class="spinner"></div> Cargando...</div>';
  
  try {
    const quotes = await sbQuery("quotes", "status=eq.accepted&order=created_at.desc&limit=20&select=id,referencia,client_name,grand_total,currency,created_at");
    if (!quotes.length) {
      list.innerHTML = '<div class="empty">No hay cotizaciones aceptadas</div>';
      return;
    }
    list.innerHTML = quotes.map(q => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:6px;margin-bottom:8px;cursor:pointer;transition:border-color .15s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
        <div>
          <div style="font-weight:600;font-size:14px">${escH(q.referencia||"")} ‚Äî ${escH(q.client_name||"Sin cliente")}</div>
          <div style="font-size:12px;color:var(--text-3)">${new Date(q.created_at).toLocaleDateString("es-UY")}</div>
        </div>
        <button class="btn btn-sm btn-primary" onclick="addFromQuote('${q.id}')">Agregar</button>
      </div>
    `).join("");
  } catch(e) {
    list.innerHTML = `<div class="empty">${e.message}</div>`;
  }
}

async function addFromQuote(quoteId) {
  showLoading("Agregando servicios...");
  try {
    const r = await invokeFunction("production-service", { action:"add-from-quote", quote_id: quoteId });
    toast(`Agregados: ${r.added} servicios`,"success");
    closeModal("quoteModal");
    loadQueue();
  } catch(e) { toast(e.message,"error"); }
  finally { hideLoading(); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 2: PANEL DEL D√çA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let dayCycles = [];
let dayStats = null;

function setDayToday() { qs("#dayDate").value = todayStr(); loadDayData(); }
function shiftDay(dir) {
  const d = new Date(qs("#dayDate").value + "T12:00:00");
  d.setDate(d.getDate() + dir);
  qs("#dayDate").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  loadDayData();
}

async function loadDayData() {
  if (!qs("#dayDate").value) qs("#dayDate").value = todayStr();
  const date = qs("#dayDate").value;
  try {
    [dayCycles, dayStats] = await Promise.all([
      sbQuery("cnc_cycles", `machine_id=eq.${MACHINE_ID}&log_date=eq.${date}&order=started_at.desc`),
      sbQuery("cnc_daily_stats", `machine_id=eq.${MACHINE_ID}&log_date=eq.${date}`).then(a => a[0] || null),
    ]);
    renderDayMetrics();
    renderDayTimeline();
    renderDayHistogram();
    renderDayCycles();
  } catch(e) { toast(e.message,"error"); }
}

function renderDayMetrics() {
  if (!dayStats) {
    ["dPieces","dTime","dAvg","dUtil"].forEach(id => qs(`#${id}`).textContent = "‚Äî");
    qs("#dPiecesSub").textContent = ""; qs("#dTimeSub").textContent = ""; qs("#dAvgSub").textContent = "";
    return;
  }
  qs("#dPieces").textContent = dayStats.completed_cycles || 0;
  qs("#dPiecesSub").textContent = dayStats.interrupted_cycles > 0 ? `+ ${dayStats.interrupted_cycles} interrumpidas` : "";
  qs("#dTime").textContent = fmtMin(dayStats.total_machining_seconds);
  qs("#dTimeSub").textContent = `${dayStats.unique_programs||0} programas √∫nicos`;
  qs("#dAvg").textContent = fmtSec(dayStats.avg_cycle_seconds);
  qs("#dAvgSub").textContent = `mediana: ${fmtSec(dayStats.median_cycle_seconds)}`;
  qs("#dUtil").textContent = `${dayStats.utilization_pct||0}%`;
}

function renderDayTimeline() {
  const c = qs("#dayTimeline");
  const completed = dayCycles.filter(x => x.started_at && x.ended_at);
  if (!completed.length) { c.innerHTML = `<div class="empty" style="padding:10px">Sin datos</div>`; return; }

  const dayStart = new Date(completed[completed.length-1].started_at);
  dayStart.setHours(7,0,0,0);
  const dayEnd = new Date(completed[0].ended_at);
  dayEnd.setHours(Math.max(dayEnd.getHours()+1, 18),0,0,0);
  const rangeMs = dayEnd - dayStart;

  let html = "";
  for (let h=dayStart.getHours(); h<=dayEnd.getHours(); h++) {
    const t = new Date(dayStart); t.setHours(h,0,0,0);
    const pct = (t - dayStart) / rangeMs * 100;
    if (pct >= 0 && pct <= 100) html += `<div class="tl-grid" style="left:${pct}%"></div>`;
  }

  completed.forEach(x => {
    const s = new Date(x.started_at).getTime(), e = new Date(x.ended_at).getTime();
    const left = Math.max(0, (s - dayStart) / rangeMs * 100);
    const width = Math.max(0.3, (e - s) / rangeMs * 100);
    html += `<div class="tl-bar ${x.status}" style="left:${left}%;width:${width}%" title="${cleanName(x.piece_name)} ‚Äî ${fmtSec(x.duration_seconds)}"></div>`;
  });

  html += `<div class="tl-axis">`;
  for (let h=dayStart.getHours(); h<=dayEnd.getHours(); h++) html += `<span>${String(h).padStart(2,"0")}:00</span>`;
  html += `</div>`;
  c.innerHTML = html;
}

function renderDayHistogram() {
  const c = qs("#dayHistogram");
  const completed = dayCycles.filter(x => x.status==="completed");
  if (!completed.length) { c.innerHTML = `<div class="empty" style="width:100%">Sin datos</div>`; return; }

  const buckets = [{min:0,max:30,l:"<30s"},{min:30,max:60,l:"30-60"},{min:60,max:90,l:"60-90"},{min:90,max:120,l:"90-120"},{min:120,max:180,l:"2-3m"},{min:180,max:300,l:"3-5m"},{min:300,max:Infinity,l:">5m"}];
  const counts = buckets.map(b => ({...b, n: completed.filter(x => x.duration_seconds >= b.min && x.duration_seconds < b.max).length}));
  const maxN = Math.max(...counts.map(x=>x.n), 1);

  c.innerHTML = counts.map(b => `
    <div class="hist-col">
      <div class="hist-cnt">${b.n||""}</div>
      <div class="hist-bar" style="height:${(b.n/maxN)*90}px"></div>
      <div class="hist-lbl">${b.l}</div>
    </div>
  `).join("");
}

function renderDayCycles() {
  const search = (qs("#dayCycleSearch").value||"").toLowerCase();
  const filter = qs("#dayCycleFilter").value;
  let items = dayCycles;
  if (filter) items = items.filter(x => x.status === filter);
  if (search) items = items.filter(x => 
    cleanName(x.piece_name).toLowerCase().includes(search) || 
    String(x.mob_part_id||"").includes(search) ||
    (x.project_folder||"").toLowerCase().includes(search)
  );
  qs("#dayCycleCount").textContent = items.length;

  qs("#dayCyclesBody").innerHTML = items.map(x => `
    <tr>
      <td><span class="cycle-status ${x.status}"></span></td>
      <td class="piece-name" title="${escH(cleanName(x.piece_name))}">${escH(cleanName(x.piece_name))}</td>
      <td style="font-size:12px;color:var(--text-2)">${escH(x.project_folder||"‚Äî")}</td>
      <td style="text-align:right;font-family:var(--mono);font-weight:${x.status==='completed'?600:400}">${fmtSec(x.duration_seconds)}</td>
      <td style="font-family:var(--mono);font-size:12px">${fmtTime(x.started_at)}</td>
      <td style="font-family:var(--mono);font-size:12px">${fmtTime(x.ended_at)}</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${x.mob_part_id||"‚Äî"}</td>
    </tr>
  `).join("");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 3: HIST√ìRICO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let histData = [];

async function loadHistorical() {
  try {
    histData = await sbQuery("cnc_daily_stats", `machine_id=eq.${MACHINE_ID}&order=log_date.desc&limit=30`);
    renderHistorical();
  } catch(e) { toast(e.message,"error"); }
}

function renderHistorical() {
  if (!histData.length) return;

  const sorted = [...histData].sort((a,b) => a.log_date.localeCompare(b.log_date));
  const totalPieces = sorted.reduce((s,d) => s + (d.completed_cycles||0), 0);
  const avgDay = Math.round(totalPieces / sorted.length);
  const avgCycle = Math.round(sorted.reduce((s,d) => s + (d.avg_cycle_seconds||0), 0) / sorted.length);

  qs("#hDays").textContent = sorted.length;
  qs("#hPieces").textContent = totalPieces.toLocaleString();
  qs("#hAvgDay").textContent = avgDay;
  qs("#hAvgCycle").textContent = fmtSec(avgCycle);

  // Bar chart
  const maxP = Math.max(...sorted.map(d => d.completed_cycles||0), 1);
  qs("#histBars").innerHTML = sorted.map(d => {
    const h = ((d.completed_cycles||0) / maxP) * 120;
    const date = new Date(d.log_date + "T12:00:00");
    const isToday = d.log_date === todayStr();
    return `
      <div class="day-col" onclick="goToDay('${d.log_date}')" title="${d.log_date}: ${d.completed_cycles} piezas, avg ${Math.round(d.avg_cycle_seconds)}s">
        <div class="day-cnt">${d.completed_cycles}</div>
        <div class="day-bar${isToday?" today":""}" style="height:${h}px"></div>
        <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${DAY_NAMES[date.getDay()]}</div>
        <div class="day-lbl" style="${isToday?"color:var(--success);font-weight:700":""}">${date.getDate()}</div>
      </div>
    `;
  }).join("");

  qs("#histSummary").textContent = `Total: ${totalPieces} piezas ‚Äî Prom: ${avgDay}/d√≠a ‚Äî Ciclo: ${avgCycle}s`;

  // Table
  qs("#histTableBody").innerHTML = [...histData].map(d => `
    <tr style="cursor:pointer" onclick="goToDay('${d.log_date}')">
      <td style="font-weight:600">${d.log_date}</td>
      <td style="text-align:right;font-family:var(--mono)">${d.completed_cycles}</td>
      <td style="text-align:right;font-family:var(--mono);color:${d.interrupted_cycles>0?"var(--danger)":"var(--text-3)"}">${d.interrupted_cycles}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtMin(d.total_machining_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(d.avg_cycle_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${fmtSec(d.median_cycle_seconds)}</td>
      <td style="text-align:right;font-family:var(--mono)">${d.utilization_pct||0}%</td>
      <td style="font-family:var(--mono);font-size:11px;color:var(--text-3)">${fmtTimeShort(d.first_cycle_at)} ‚Äî ${fmtTimeShort(d.last_cycle_at)}</td>
    </tr>
  `).join("");
}

function goToDay(date) {
  qs("#dayDate").value = date;
  switchTab("mecanizado");
  switchMecSub("dia");
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 4: CAPACIDAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function loadCapacity() {
  try {
    const [cap, queue] = await Promise.all([
      invokeFunction("production-service", { action:"capacity" }),
      sbQuery("production_queue_status", "status=in.(pending,in_progress)&order=priority.asc"),
    ]);

    qs("#capPieces").textContent = cap.avg_pieces_per_day || "‚Äî";
    qs("#capTime").textContent = fmtMinFromMin(cap.avg_machining_min_per_day);
    qs("#capTimeSub").textContent = `basado en ${cap.days_count} d√≠as`;
    qs("#capCycle").textContent = fmtSec(cap.avg_cycle_seconds);
    qs("#capUtil").textContent = `${cap.utilization_avg||0}%`;

    // Queue load
    const totalPieces = queue.reduce((s,i) => s + Math.max(0, (i.parts_with_machining||0) - (i.cnc_parts_done||0)), 0);
    const totalCutMin = queue.reduce((s,i) => s + (i.cutting_time_est||0), 0);
    const totalEdgeMin = queue.reduce((s,i) => s + (i.edge_time_est_min||0), 0);
    const totalCncMin = Math.round(totalPieces * (cap.avg_cycle_seconds||75) / 60);
    const daysNeeded = cap.avg_pieces_per_day > 0 ? Math.ceil(totalPieces / cap.avg_pieces_per_day) : "?";

    qs("#capQueueBlock").innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><span style="font-size:12px;color:var(--text-3)">Servicios pendientes</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${queue.length}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Piezas CNC pendientes</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${totalPieces}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo CNC estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalCncMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo corte estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalCutMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Tiempo enchape estimado</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtMinFromMin(totalEdgeMin)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">D√≠as h√°biles estimados</span><div style="font-family:var(--mono);font-size:24px;font-weight:700;color:var(--accent)">${daysNeeded}</div></div>
      </div>
    `;

    qs("#capEstBlock").innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div><span style="font-size:12px;color:var(--text-3)">Capacidad CNC/d√≠a</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${cap.avg_pieces_per_day} pzas</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Mecanizado efectivo/d√≠a</span><div style="font-family:var(--mono);font-size:24px;font-weight:700">${fmtMinFromMin(cap.avg_machining_min_per_day)}</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Utilizaci√≥n promedio</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${cap.utilization_avg}%</div></div>
        <div><span style="font-size:12px;color:var(--text-3)">Ciclo promedio real</span><div style="font-family:var(--mono);font-size:18px;font-weight:600">${fmtSec(cap.avg_cycle_seconds)}</div></div>
      </div>
      <div style="margin-top:14px;padding:10px;background:var(--surface);border-radius:6px;font-size:13px;color:var(--text-2);">
        <strong>Nota:</strong> El promedio real (${cap.avg_cycle_seconds}s/pieza) vs la estimaci√≥n fija (80s/pieza) 
        da un error del <strong>${cap.avg_cycle_seconds ? Math.round((cap.avg_cycle_seconds/80 - 1)*100) : 0}%</strong>. 
        Las estimaciones en la cola usan el promedio real.
      </div>
    `;

    // Comparison
    renderComparison(cap);

  } catch(e) { toast(e.message,"error"); }
}

function renderComparison(cap) {
  const c = qs("#capComparison");
  const realAvg = cap.avg_cycle_seconds || 75;
  const fixedEst = 80;
  const diff = realAvg - fixedEst;
  const diffPct = ((realAvg / fixedEst) - 1) * 100;

  c.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;text-align:center;">
      <div style="padding:16px;background:var(--bg);border-radius:8px;">
        <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Estimaci√≥n fija</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700">80s</div>
        <div style="font-size:12px;color:var(--text-3)">por pieza</div>
      </div>
      <div style="padding:16px;background:var(--bg);border-radius:8px;">
        <div style="font-size:12px;color:var(--text-3);margin-bottom:8px">Promedio real</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700;color:var(--accent)">${Math.round(realAvg)}s</div>
        <div style="font-size:12px;color:var(--text-3)">por pieza (${cap.days_count} d√≠as)</div>
      </div>
      <div style="padding:16px;background:${diffPct>10?'var(--danger)':diffPct<-10?'var(--success)':'var(--warn)'};border-radius:8px;color:white;">
        <div style="font-size:12px;opacity:.8;margin-bottom:8px">Diferencia</div>
        <div style="font-family:var(--mono);font-size:32px;font-weight:700">${diffPct>0?"+":""}${Math.round(diffPct)}%</div>
        <div style="font-size:12px;opacity:.8">${diff>0?"Real m√°s lento":"Real m√°s r√°pido"}</div>
      </div>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TAB 5: PACKING (was Pre Packing)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPrePacking() {
  try {
    // Get production list from MobCloud
    let prodServices = [];
    try {
      prodServices = await invokeFunction("production-service", { action: "list-production" });
    } catch (e) {
      console.warn("Production list not available:", e.message);
    }

    // Get packing progress from local views
    let ppData = [];
    try {
      ppData = await sbQuery("vw_packing_service_progress", "order=service_id.desc");
    } catch (e) { console.warn("Packing views not ready:", e.message); }
    const ppMap = {};
    for (const p of ppData) ppMap[p.service_id] = p;

    // Today's scan count
    const todayStart = todayStr() + "T00:00:00";
    let todayScans = 0;
    try {
      const scans = await sbQuery("packing_scans", `scanned_at=gte.${todayStart}&select=id`);
      todayScans = scans?.length || 0;
    } catch (e) {}

    // Merge: production services + packing progress
    const merged = prodServices.map(s => {
      const pp = ppMap[s.service_id] || {};
      return { ...s, expected: +(pp.expected||0), scanned: +(pp.scanned||0), missing: +(pp.missing||0), complete: !!pp.complete };
    });

    // Metrics
    const total = merged.length;
    const withParts = merged.filter(s => s.has_parts_cached).length;
    const inProgress = merged.filter(s => s.scanned > 0 && !s.complete).length;
    const complete = merged.filter(s => s.complete).length;
    
    qs("#ppServices").textContent = total;
    qs("#ppInProgress").textContent = inProgress;
    qs("#ppComplete").textContent = complete;
    qs("#ppToday").textContent = todayScans;

    // Table
    const tbody = qs("#ppBody");
    qs("#ppEmpty").style.display = merged.length ? "none" : "block";

    tbody.innerHTML = merged.map(s => {
      const exp = s.expected || 0;
      const sc = s.scanned || 0;
      const mis = s.missing || 0;
      const pct = exp > 0 ? Math.round(sc / exp * 100) : 0;
      const barClass = pct >= 100 ? "green" : pct > 0 ? "blue" : "";
      const name = s.internal_code || "Servicio " + s.service_id;
      const partsIcon = s.has_parts_cached ? "‚úì" : "‚ö†";
      const partsColor = s.has_parts_cached ? "var(--success)" : "var(--warn)";

      // Step badges
      const stepBadge = (val, label) => val 
        ? `<span style="font-size:10px;color:var(--success)">‚úì${label}</span>` 
        : `<span style="font-size:10px;color:var(--text-3)">¬∑${label}</span>`;

      return `<tr>
        <td>
          <div style="font-weight:600">${escH(name)}</div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--text-3)">#${s.service_id} <span style="color:${partsColor}">${partsIcon} partes</span></div>
          <div style="margin-top:3px;display:flex;gap:6px">
            ${stepBadge(s.step_cut,"Corte")} ${stepBadge(s.step_edge,"Enchape")} ${stepBadge(s.step_machining,"CNC")} ${stepBadge(s.step_packing,"Pack")}
          </div>
        </td>
        <td style="font-size:12px">${escH(s.client_name || "")}</td>
        <td style="text-align:center;font-family:var(--mono)">${exp || "‚Äî"}</td>
        <td style="text-align:center;font-family:var(--mono)">${sc || "‚Äî"}</td>
        <td style="text-align:center;font-family:var(--mono);${mis>0?"color:var(--danger);font-weight:700":""}">${mis || "‚Äî"}</td>
        <td style="min-width:110px">
          ${exp > 0 ? `<div style="display:flex;align-items:center;gap:6px">
            <div class="progress-bar" style="flex:1"><div class="progress-fill ${barClass}" style="width:${Math.min(100,pct)}%"></div></div>
            <span style="font-family:var(--mono);font-size:11px;min-width:32px">${pct}%</span>
          </div>` : `<span style="font-size:11px;color:var(--text-3)">${s.has_parts_cached?"Sin scans":"Sincronizar"}</span>`}
        </td>
        <td><a href="prepacking.html" target="_blank" class="btn btn-sm btn-secondary" style="text-decoration:none;font-size:11px">Escanear ‚Üó</a></td>
      </tr>`;
    }).join("");
  } catch (e) {
    console.error("loadPrePacking:", e);
    toast(e.message, "error");
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
trackSetRange("month");
qs("#dayDate").value = todayStr();
// Load Cola (default tab)
loadQueue();
</script>
</body>
</html>
