<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Operaciones ‚Äì MobCloud + Corte</title>

  <style>
    :root{
      --bg:#070a10;
      --card:#0d1117;
      --card2:#111a24;
      --txt:#e7edf6;
      --muted:#9fb0c3;
      --border:#223247;

      --success:#00ff88;
      --warning:#ffcc00;
      --danger:#ff4d4d;
      --accent:#00f2ff;

      --shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(circle at 50% 0%, #121a24 0%, #070a10 60%, #05070c 100%);
      color:var(--txt);
      min-height:100vh;
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 18px;
      border-bottom:1px solid var(--border);
      background: rgba(7,10,16,0.6);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .title{ font-size:18px; font-weight:900; letter-spacing:0.06em; }
    .brand .sub{ font-size:12px; color:var(--muted); }

    .hdr-right{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      font-size:12px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background: rgba(255,255,255,0.02);
    }

    .btn{
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #2b3e55;
      background:#132233;
      color:var(--txt);
      cursor:pointer;
    }
    .btn:hover{ filter: brightness(1.08); }
    .btn:disabled{ opacity:0.55; cursor:not-allowed; }

    .tabs{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.02);
      color:var(--muted);
      padding:8px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      letter-spacing:0.04em;
      user-select:none;
    }
    .tab.active{
      color: var(--txt);
      border-color: rgba(0,242,255,0.35);
      box-shadow: 0 0 0 2px rgba(0,242,255,0.08);
    }

    main{ padding:16px 18px 24px; display:grid; gap:14px; }
    .card{
      background: var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px;
    }

    .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .span-12{ grid-column: span 12; }
    .span-8{ grid-column: span 8; }
    .span-7{ grid-column: span 7; }
    .span-6{ grid-column: span 6; }
    .span-5{ grid-column: span 5; }
    .span-4{ grid-column: span 4; }
    .span-3{ grid-column: span 3; }

    .k{
      font-size:11px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:8px;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .field{ display:flex; flex-direction:column; gap:6px; min-width: 180px; }
    label{
      font-size:11px;
      color:var(--muted);
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    input, select{
      background: rgba(255,255,255,0.03);
      border:1px solid var(--border);
      color: var(--txt);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    input::placeholder{ color: rgba(159,176,195,0.6); }
    select option{ background:#0b111a; }

    .metrics{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    .metric{
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(34,50,71,0.65);
      border-radius:14px;
      padding:12px;
    }
    .metric .m-k{ font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:0.08em; }
    .metric .m-v{ font-size:26px; font-weight:900; margin-top:6px; }
    .metric .m-s{ font-size:12px; color:var(--muted); margin-top:4px; }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{
      padding:10px 8px;
      border-bottom:1px solid rgba(34,50,71,0.7);
      vertical-align:top;
    }
    th{
      text-align:left;
      color:var(--muted);
      font-size:11px;
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-weight:800;
    }

    .tag{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
    }
    .tag.ok{ color: var(--success); border-color: rgba(0,255,136,0.25); background: rgba(0,255,136,0.06); }
    .tag.warn{ color: var(--warning); border-color: rgba(255,204,0,0.25); background: rgba(255,204,0,0.06); }
    .tag.bad{ color: var(--danger); border-color: rgba(255,77,77,0.25); background: rgba(255,77,77,0.06); }
    .tag.info{ color:#66b3ff; border-color: rgba(102,179,255,0.25); background: rgba(102,179,255,0.06); }

    .muted{ color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    .hidden{ display:none !important; }

    /* Print */
    @media print {
      header, .no-print { display:none !important; }
      body { background: white !important; color: #111 !important; }
      .card { box-shadow:none !important; border: 1px solid #ddd !important; }
      table, th, td { border-color:#ddd !important; color:#111 !important; }
      .tag { border-color:#999 !important; color:#111 !important; background:transparent !important; }
      .muted { color:#333 !important; }

      /* Imprimir solo Pre Packing */
      main > section { display:none !important; }
      #tab-packing { display:block !important; }
    }
  </style>
</head>

<body>
<header>
  <div class="brand">
    <div class="title">OPERACIONES</div>
    <div class="sub">MobCloud + Corte ‚Ä¢ Supabase</div>
  </div>

  <div class="hdr-right">
    <div class="tabs no-print">
      <div class="tab active" data-tab="produccion">Producci√≥n</div>
      <div class="tab" data-tab="compras">Compras</div>
      <div class="tab" data-tab="herrajes">Herrajes</div>
      <div class="tab" data-tab="complejidad">Complejidad</div>
      <div class="tab" data-tab="packing">Pre Packing</div>
    </div>

    <div class="pill">SYNC: <span id="lastSync">-</span></div>
    <button class="btn no-print" id="btnRefresh">Refrescar</button>
  </div>
</header>

<main>
  <!-- PRODUCCI√ìN -->
  <section id="tab-produccion" class="card">
    <div class="k">Producci√≥n ‚Ä¢ Backlog</div>

    <div class="grid no-print">
      <div class="span-12">
        <div class="row">
          <div class="field">
            <label>L√≠nea</label>
            <select id="prodLine"><option value="">Todas</option></select>
          </div>

          <div class="field">
            <label>Estados</label>
            <input id="prodStatus" value="7,13,17,18,19,21,22"/>
          </div>

          <div class="field">
            <label>Buscar (c√≥digo/cliente)</label>
            <input id="prodSearch" placeholder="CJ7 / U901 / cliente..." />
          </div>

          <div class="field">
            <label>Mostrar</label>
            <select id="prodLimit">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </div>

      <div class="span-12">
        <div class="metrics">
          <div class="metric">
            <div class="m-k">Servicios</div>
            <div class="m-v" id="mServices">-</div>
            <div class="m-s">filtrados</div>
          </div>
          <div class="metric">
            <div class="m-k">Vencidos</div>
            <div class="m-v" id="mOverdue">-</div>
            <div class="m-s">estimated_delivery &lt; hoy</div>
          </div>
          <div class="metric">
            <div class="m-k">Con enchape</div>
            <div class="m-v" id="mEdge">-</div>
            <div class="m-s">edge_used = 1</div>
          </div>
          <div class="metric">
            <div class="m-k">Con mecanizado</div>
            <div class="m-v" id="mMach">-</div>
            <div class="m-s">machining_used = 1</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="span-12">
        <table>
          <thead>
          <tr>
            <th class="nowrap">Entrega</th>
            <th>Servicio</th>
            <th>L√≠nea</th>
            <th class="nowrap">Status</th>
            <th class="nowrap">Corte</th>
            <th class="nowrap">Enchape</th>
            <th class="nowrap">Mecanizado</th>
            <th class="nowrap">Packing</th>
            <th class="right nowrap">Cut (plan)</th>
          </tr>
          </thead>
          <tbody id="prodTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- COMPRAS H√çBRIDO -->
<section id="tab-compras" class="card hidden">
  <div class="k">Compras ‚Ä¢ Operativa</div>

  <!-- Header con toggle de vistas -->
  <div class="header-controls" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; margin-bottom:16px;">
    <div class="view-toggle" style="display:flex; gap:6px; background:rgba(255,255,255,0.03); padding:4px; border-radius:10px; border:1px solid var(--border);">
      <button class="view-btn active" data-view="list" onclick="switchBuyView('list')" style="padding:10px 18px; border:none; background:transparent; color:var(--muted); border-radius:8px; font-size:13px; font-weight:800; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; gap:8px;">
        <span style="font-size:18px;">üìã</span>
        <span>Lista con Checklist</span>
      </button>
      <button class="view-btn" data-view="dashboard" onclick="switchBuyView('dashboard')" style="padding:10px 18px; border:none; background:transparent; color:var(--muted); border-radius:8px; font-size:13px; font-weight:800; cursor:pointer; transition:all 0.2s ease; display:flex; align-items:center; gap:8px;">
        <span style="font-size:18px;">üìä</span>
        <span>Dashboard</span>
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="grid no-print">
    <div class="span-12">
      <div class="row">
        <div class="field">
          <label>Pr√≥ximos d√≠as</label>
          <select id="buyDays">
            <option value="7" selected>7</option>
            <option value="14">14</option>
            <option value="30">30</option>
          </select>
        </div>

        <div class="field">
          <label>L√≠nea</label>
          <select id="buyLine"><option value="">Todas</option></select>
        </div>

        <div class="field">
          <label>Estados</label>
          <input id="buyStatus" value="7,13,17,18,19,21,22"/>
        </div>

        <div class="field">
          <label>Buscar item</label>
          <input id="buySearch" placeholder="tabl/058 / parana / tornillo..." />
        </div>
      </div>
    </div>
  </div>

  <!-- Chips de categor√≠a -->
  <div class="category-chips no-print" id="buyCategoryChips" style="display:flex; gap:8px; overflow-x:auto; padding:12px 0; margin-bottom:16px; border-top:1px solid var(--border); border-bottom:1px solid var(--border);">
    <!-- Generado din√°micamente -->
  </div>

  <!-- KPIs superiores -->
  <div class="grid no-print">
    <div class="span-3">
      <div class="metric" style="background:linear-gradient(135deg, rgba(0,242,255,0.1) 0%, rgba(0,242,255,0.05) 100%); border:1px solid rgba(0,242,255,0.3);">
        <div class="m-k">Costo Total</div>
        <div class="m-v" id="buyTotalCost">$0</div>
        <div class="m-s">estimado</div>
      </div>
    </div>
    <div class="span-3">
      <div class="metric">
        <div class="m-k">Items √önicos</div>
        <div class="m-v" id="buyTotalItems">0</div>
        <div class="m-s">productos</div>
      </div>
    </div>
    <div class="span-3">
      <div class="metric">
        <div class="m-k">Categor√≠as</div>
        <div class="m-v" id="buyTotalCategories">0</div>
        <div class="m-s">grupos</div>
      </div>
    </div>
    <div class="span-3">
      <div class="metric">
        <div class="m-k">Progreso</div>
        <div class="m-v" id="buyCheckedPercent">0%</div>
        <div class="m-s"><span id="buyCheckedCount">0</span> de <span id="buyTotalCount">0</span></div>
      </div>
    </div>
  </div>

  <!-- VISTA LISTA -->
  <div id="buyListView">
    <div class="grid no-print">
      <div class="span-12">
        <div class="row" style="gap:10px;">
          <button class="btn" onclick="buyExpandAll()">Expandir todo</button>
          <button class="btn" onclick="buyCollapseAll()">Colapsar todo</button>
          <button class="btn" onclick="buyUncheckAll()">Desmarcar todo</button>
          <button class="btn" style="background:linear-gradient(135deg, #00f2ff 0%, #00b8d4 100%); border-color:#00f2ff; color:#000; font-weight:800;" onclick="window.print()">üìÑ Imprimir</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="span-12" id="buyListContainer">
        <!-- Generado din√°micamente -->
      </div>
    </div>
  </div>

  <!-- VISTA DASHBOARD -->
  <div id="buyDashboardView" style="display:none;">
    <div class="grid">
      <!-- Gr√°fico de dona -->
      <div class="span-7">
        <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; min-height:350px;">
          <div class="k">Distribuci√≥n de Costos por Categor√≠a</div>
          <canvas id="buyCategoryChart" style="max-height:300px;"></canvas>
        </div>
      </div>

      <!-- Top 5 items -->
      <div class="span-5">
        <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; min-height:350px;">
          <div class="k">Top 5 Items M√°s Costosos</div>
          <div id="buyTopItems" style="display:grid; gap:10px;">
            <!-- Generado din√°micamente -->
          </div>
        </div>
      </div>

      <!-- Gr√°fico de barras -->
      <div class="span-12">
        <div style="background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; min-height:300px;">
          <div class="k">An√°lisis de Cantidades por Categor√≠a</div>
          <canvas id="buyQuantityChart" style="max-height:280px;"></canvas>
        </div>
      </div>

      <!-- Tabla resumen -->
      <div class="span-12">
        <div class="k">Resumen por Categor√≠a</div>
        <table>
          <thead>
            <tr>
              <th>Categor√≠a</th>
              <th class="right">Items</th>
              <th class="right">Costo Total</th>
              <th class="right">% del Total</th>
            </tr>
          </thead>
          <tbody id="buySummaryTable">
            <!-- Generado din√°micamente -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<style>
/* Estilos espec√≠ficos para Compras H√≠brido */
.view-btn:hover { background:rgba(255,255,255,0.05); }
.view-btn.active {
  background:linear-gradient(135deg, #00f2ff 0%, #00b8d4 100%);
  color:#000;
  box-shadow:0 2px 8px rgba(0,242,255,0.3);
}

.category-chips::-webkit-scrollbar { height:6px; }
.category-chips::-webkit-scrollbar-track { background:rgba(255,255,255,0.02); border-radius:3px; }
.category-chips::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1); border-radius:3px; }

.buy-chip {
  padding:8px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.02);
  font-size:12px;
  font-weight:800;
  cursor:pointer;
  white-space:nowrap;
  transition:all 0.2s ease;
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.buy-chip:hover { background:rgba(255,255,255,0.05); border-color:rgba(0,242,255,0.3); }
.buy-chip.active {
  background:linear-gradient(135deg, rgba(0,242,255,0.2) 0%, rgba(0,242,255,0.1) 100%);
  border-color:var(--accent);
  color:var(--accent);
}

.buy-category-section { margin-bottom:20px; }

.buy-category-header {
  background:linear-gradient(135deg, rgba(0,242,255,0.1) 0%, rgba(0,242,255,0.05) 100%);
  border:1px solid rgba(0,242,255,0.3);
  border-radius:12px;
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  transition:all 0.2s ease;
  margin-bottom:10px;
}
.buy-category-header:hover {
  background:linear-gradient(135deg, rgba(0,242,255,0.15) 0%, rgba(0,242,255,0.08) 100%);
  border-color:rgba(0,242,255,0.5);
}
.buy-category-header.collapsed { opacity:0.7; }

.buy-category-title { display:flex; align-items:center; gap:12px; }
.buy-category-icon { font-size:24px; }
.buy-category-name { font-size:16px; font-weight:900; text-transform:uppercase; letter-spacing:0.05em; }

.buy-category-stats { display:flex; align-items:center; gap:16px; font-size:13px; }
.buy-category-count { background:rgba(0,242,255,0.15); padding:4px 10px; border-radius:8px; font-weight:800; }
.buy-category-total { font-weight:900; color:var(--accent); }

.buy-category-toggle { font-size:20px; transition:transform 0.3s ease; }
.buy-category-toggle.collapsed { transform:rotate(-90deg); }

.buy-category-items {
  border-left:2px solid rgba(0,242,255,0.2);
  margin-left:20px;
  padding-left:0;
  max-height:2000px;
  overflow:hidden;
  transition:max-height 0.3s ease;
}
.buy-category-items.collapsed { max-height:0; }

.buy-item-card {
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px 14px;
  margin-bottom:8px;
  display:grid;
  grid-template-columns:40px 1fr auto;
  gap:12px;
  align-items:center;
  transition:all 0.2s ease;
}
.buy-item-card:hover { background:rgba(255,255,255,0.04); border-color:rgba(0,242,255,0.3); }
.buy-item-card.checked { opacity:0.5; background:rgba(0,255,136,0.05); }

.buy-item-checkbox { width:24px; height:24px; cursor:pointer; accent-color:var(--success); }

.buy-item-info { display:flex; flex-direction:column; gap:4px; }
.buy-item-key { font-family:ui-monospace, monospace; font-size:13px; color:var(--accent); font-weight:700; }
.buy-item-desc { font-size:13px; color:var(--txt); }

.buy-item-details { text-align:right; }
.buy-item-qty { font-size:18px; font-weight:900; margin-bottom:2px; }
.buy-item-unit { font-size:11px; color:var(--muted); margin-bottom:4px; }
.buy-item-cost { font-size:12px; color:var(--muted); font-weight:700; }

.buy-top-item {
  background:rgba(255,255,255,0.02);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all 0.2s ease;
}
.buy-top-item:hover { background:rgba(255,255,255,0.04); border-color:rgba(0,242,255,0.3); }

.buy-top-rank {
  width:32px;
  height:32px;
  background:linear-gradient(135deg, rgba(0,242,255,0.2) 0%, rgba(0,242,255,0.1) 100%);
  border:1px solid rgba(0,242,255,0.4);
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:14px;
  color:var(--accent);
}

.buy-top-info { flex:1; margin-left:14px; }
.buy-top-name { font-weight:800; font-size:13px; margin-bottom:2px; }
.buy-top-desc { font-size:11px; color:var(--muted); }
.buy-top-cost { font-size:18px; font-weight:900; color:var(--accent); }

@media print {
  .view-toggle, .category-chips, .btn { display:none !important; }
  .buy-item-checkbox { opacity:0.3; }
  #buyDashboardView { display:none !important; }
  #buyListView { display:block !important; }
}
</style>

<script>
// Variables globales para Compras
let buyRawData = [];
let buyGroupedData = {};
let buyCheckedItems = new Set();
let buyCurrentFilter = '';
let buyCurrentView = 'list';
let buyCategoryChart, buyQuantityChart;

const buyCategoryIcons = {
  "TABLEROS": "ü™µ", "CANTOS": "üìè", "HERRAJES": "üîß", "TORNILLOS": "üî©",
  "ADHESIVOS": "üß¥", "ABRASIVOS": "üî®", "EMBALAJE": "üì¶", "VARIOS": "üõ†Ô∏è",
  "MELAMINAS": "üé®", "MADERAS": "üå≥", "ACCESORIOS": "‚öôÔ∏è", "VIDRIOS": "üíé"
};

function switchBuyView(view) {
  buyCurrentView = view;
  
  // Toggle buttons
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  
  // Toggle views
  document.getElementById('buyListView').style.display = view === 'list' ? 'block' : 'none';
  document.getElementById('buyDashboardView').style.display = view === 'dashboard' ? 'block' : 'none';
  
  // Si cambiamos a dashboard, actualizar gr√°ficos
  if (view === 'dashboard') {
    setTimeout(() => buyRenderDashboard(), 100);
  }
}

function buyGroupByCategory(data) {
  const grouped = {};
  data.forEach(item => {
    const cat = item.category || 'VARIOS';
    if (!grouped[cat]) grouped[cat] = [];
    grouped[cat].push({
      key: item.item_key || '',
      desc: item.description || '',
      qty: Number(item.qty || 0),
      unit: item.unit || '',
      cost: Number(item.cost_estimated || 0)
    });
  });
  return grouped;
}

function buyRenderCategoryChips() {
  const container = document.getElementById('buyCategoryChips');
  container.innerHTML = '';

  const allChip = document.createElement('div');
  allChip.className = 'buy-chip active';
  allChip.onclick = () => buyFilterCategory('');
  allChip.innerHTML = '<span>Todas</span>';
  container.appendChild(allChip);

  Object.keys(buyGroupedData).sort().forEach(category => {
    const chip = document.createElement('div');
    chip.className = 'buy-chip';
    chip.dataset.category = category;
    chip.onclick = () => buyFilterCategory(category);
    const icon = buyCategoryIcons[category] || 'üì¶';
    chip.innerHTML = `<span style="font-size:16px;">${icon}</span><span>${category}</span>`;
    container.appendChild(chip);
  });
}

function buyFilterCategory(category) {
  buyCurrentFilter = category;
  
  document.querySelectorAll('.buy-chip').forEach(chip => {
    const isAll = !chip.dataset.category && category === '';
    const isMatch = chip.dataset.category === category;
    chip.classList.toggle('active', isAll || isMatch);
  });
  
  buyRenderListView();
  if (buyCurrentView === 'dashboard') {
    buyRenderDashboard();
  }
}

function buyUpdateKPIs() {
  const totalCost = buyRawData.reduce((sum, item) => sum + Number(item.cost_estimated || 0), 0);
  const totalItems = buyRawData.length;
  const categories = Object.keys(buyGroupedData).length;

  document.getElementById('buyTotalCost').textContent = '$' + totalCost.toLocaleString('es-UY', {maximumFractionDigits:0});
  document.getElementById('buyTotalItems').textContent = totalItems;
  document.getElementById('buyTotalCategories').textContent = categories;
  document.getElementById('buyTotalCount').textContent = totalItems;
  buyUpdateCheckedCount();
}

function buyRenderListView() {
  const container = document.getElementById('buyListContainer');
  container.innerHTML = '';

  const categories = buyCurrentFilter ? [buyCurrentFilter] : Object.keys(buyGroupedData).sort();

  categories.forEach(category => {
    if (!buyGroupedData[category]) return;

    const items = buyGroupedData[category];
    const categoryTotal = items.reduce((sum, item) => sum + item.cost, 0);

    const section = document.createElement('div');
    section.className = 'buy-category-section';

    const header = document.createElement('div');
    header.className = 'buy-category-header';
    header.onclick = () => buyToggleCategory(category);
    const icon = buyCategoryIcons[category] || 'üì¶';
    header.innerHTML = `
      <div class="buy-category-title">
        <div class="buy-category-icon">${icon}</div>
        <div class="buy-category-name">${category}</div>
      </div>
      <div class="buy-category-stats">
        <div class="buy-category-count">${items.length} items</div>
        <div class="buy-category-total">$${categoryTotal.toLocaleString('es-UY', {maximumFractionDigits:0})}</div>
        <div class="buy-category-toggle" id="buy-toggle-${category}">‚ñº</div>
      </div>
    `;
    section.appendChild(header);

    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'buy-category-items';
    itemsContainer.id = `buy-items-${category}`;

    items.forEach((item, idx) => {
      const itemId = `${category}-${idx}`;
      const card = document.createElement('div');
      card.className = 'buy-item-card';
      card.id = `buy-card-${itemId}`;
      if (buyCheckedItems.has(itemId)) card.classList.add('checked');

      card.innerHTML = `
        <input type="checkbox" class="buy-item-checkbox" id="buy-check-${itemId}" ${buyCheckedItems.has(itemId) ? 'checked' : ''} onchange="buyToggleCheck('${itemId}')">
        <div class="buy-item-info">
          <div class="buy-item-key">${escapeHtml(item.key)}</div>
          <div class="buy-item-desc">${escapeHtml(item.desc)}</div>
        </div>
        <div class="buy-item-details">
          <div class="buy-item-qty">${item.qty.toFixed(2).replace(/\.00$/, '')}</div>
          <div class="buy-item-unit">${escapeHtml(item.unit)}</div>
          <div class="buy-item-cost">$${item.cost.toLocaleString('es-UY', {maximumFractionDigits:0})}</div>
        </div>
      `;
      itemsContainer.appendChild(card);
    });

    section.appendChild(itemsContainer);
    container.appendChild(section);
  });
}

function buyRenderDashboard() {
  const allItems = buyRawData;
  
  // Top 5 items
  buyRenderTopItems(allItems);
  
  // Gr√°ficos
  const categories = Object.keys(buyGroupedData).sort();
  const categoryTotals = {};
  categories.forEach(cat => {
    categoryTotals[cat] = buyGroupedData[cat].reduce((sum, item) => sum + item.cost, 0);
  });
  
  buyRenderCategoryChart(categories, categoryTotals);
  buyRenderQuantityChart(categories);
  buyRenderSummaryTable(categories, categoryTotals);
}

function buyRenderTopItems(allItems) {
  const container = document.getElementById('buyTopItems');
  container.innerHTML = '';

  const items = allItems.map(item => ({
    key: item.item_key,
    desc: item.description,
    cost: Number(item.cost_estimated || 0)
  }));

  const sorted = items.sort((a, b) => b.cost - a.cost).slice(0, 5);

  sorted.forEach((item, idx) => {
    const card = document.createElement('div');
    card.className = 'buy-top-item';
    card.innerHTML = `
      <div class="buy-top-rank">${idx + 1}</div>
      <div class="buy-top-info">
        <div class="buy-top-name">${escapeHtml(item.key)}</div>
        <div class="buy-top-desc">${escapeHtml(item.desc)}</div>
      </div>
      <div class="buy-top-cost">$${item.cost.toLocaleString('es-UY', {maximumFractionDigits:0})}</div>
    `;
    container.appendChild(card);
  });
}

function buyRenderCategoryChart(categories, categoryTotals) {
  const ctx = document.getElementById('buyCategoryChart');
  
  if (buyCategoryChart) buyCategoryChart.destroy();

  const colors = [
    'rgba(0,242,255,0.8)', 'rgba(0,255,136,0.8)', 'rgba(255,204,0,0.8)', 'rgba(255,149,0,0.8)',
    'rgba(147,112,219,0.8)', 'rgba(255,105,180,0.8)', 'rgba(64,224,208,0.8)', 'rgba(255,215,0,0.8)',
    'rgba(30,144,255,0.8)', 'rgba(255,69,0,0.8)', 'rgba(50,205,50,0.8)', 'rgba(255,20,147,0.8)'
  ];

  buyCategoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: categories,
      datasets: [{
        data: categories.map(cat => categoryTotals[cat]),
        backgroundColor: colors,
        borderColor: colors.map(c => c.replace('0.8', '1')),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'right',
          labels: { 
            color: '#e7edf6', 
            padding: 12,
            font: { size: 11 },
            generateLabels: function(chart) {
              const data = chart.data;
              return data.labels.map((label, i) => {
                const value = data.datasets[0].data[i];
                return {
                  text: `${label}: $${value.toLocaleString('es-UY', {maximumFractionDigits:0})}`,
                  fillStyle: data.datasets[0].backgroundColor[i],
                  hidden: false,
                  index: i
                };
              });
            }
          }
        }
      }
    }
  });
}

function buyRenderQuantityChart(categories) {
  const ctx = document.getElementById('buyQuantityChart');
  
  if (buyQuantityChart) buyQuantityChart.destroy();

  const categoryQtys = categories.map(cat => {
    return buyGroupedData[cat].reduce((sum, item) => sum + item.qty, 0);
  });

  buyQuantityChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [{
        label: 'Cantidad Total',
        data: categoryQtys,
        backgroundColor: 'rgba(0,242,255,0.7)',
        borderColor: '#00f2ff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#9fb0c3' }, grid: { color: 'rgba(34, 50, 71, 0.5)' } },
        y: { beginAtZero: true, ticks: { color: '#9fb0c3' }, grid: { color: 'rgba(34, 50, 71, 0.5)' } }
      }
    }
  });
}

function buyRenderSummaryTable(categories, categoryTotals) {
  const tbody = document.getElementById('buySummaryTable');
  tbody.innerHTML = '';

  const totalCost = Object.values(categoryTotals).reduce((sum, cost) => sum + cost, 0);
  const sorted = categories.sort((a, b) => categoryTotals[b] - categoryTotals[a]);

  sorted.forEach(category => {
    const items = buyGroupedData[category];
    const cost = categoryTotals[category];
    const percent = ((cost / totalCost) * 100).toFixed(1);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${escapeHtml(category)}</b></td>
      <td class="right">${items.length}</td>
      <td class="right">$${cost.toLocaleString('es-UY', {maximumFractionDigits:0})}</td>
      <td class="right">${percent}%</td>
    `;
    tbody.appendChild(tr);
  });
}

function buyToggleCategory(category) {
  const items = document.getElementById(`buy-items-${category}`);
  const toggle = document.getElementById(`buy-toggle-${category}`);
  const header = toggle.closest('.buy-category-header');
  
  items.classList.toggle('collapsed');
  toggle.classList.toggle('collapsed');
  header.classList.toggle('collapsed');
}

function buyExpandAll() {
  document.querySelectorAll('.buy-category-items').forEach(el => el.classList.remove('collapsed'));
  document.querySelectorAll('.buy-category-toggle').forEach(el => el.classList.remove('collapsed'));
  document.querySelectorAll('.buy-category-header').forEach(el => el.classList.remove('collapsed'));
}

function buyCollapseAll() {
  document.querySelectorAll('.buy-category-items').forEach(el => el.classList.add('collapsed'));
  document.querySelectorAll('.buy-category-toggle').forEach(el => el.classList.add('collapsed'));
  document.querySelectorAll('.buy-category-header').forEach(el => el.classList.add('collapsed'));
}

function buyToggleCheck(itemId) {
  const checkbox = document.getElementById(`buy-check-${itemId}`);
  const card = document.getElementById(`buy-card-${itemId}`);
  
  if (checkbox.checked) {
    buyCheckedItems.add(itemId);
    card.classList.add('checked');
  } else {
    buyCheckedItems.delete(itemId);
    card.classList.remove('checked');
  }
  
  buyUpdateCheckedCount();
}

function buyUncheckAll() {
  buyCheckedItems.clear();
  document.querySelectorAll('.buy-item-checkbox').forEach(cb => cb.checked = false);
  document.querySelectorAll('.buy-item-card').forEach(card => card.classList.remove('checked'));
  buyUpdateCheckedCount();
}

function buyUpdateCheckedCount() {
  const total = document.getElementById('buyTotalCount').textContent;
  const checked = buyCheckedItems.size;
  document.getElementById('buyCheckedCount').textContent = checked;
  
  const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
  document.getElementById('buyCheckedPercent').textContent = percent + '%';
}

// ---- FUNCI√ìN PRINCIPAL: refreshPurchases (reemplaza la original) ----
async function refreshPurchases(){
  const days = Number(document.getElementById("buyDays").value || 7);
  const line = document.getElementById("buyLine").value || null;
  const status = document.getElementById("buyStatus").value || null;

  const { data, error } = await sb.rpc("fn_lista_compras_operativa", {
    p_days: days,
    p_line_name: (line && line.trim() !== "") ? line : null,
    p_status_list: (status && status.trim() !== "") ? status : null
  });
  if(error) throw error;

  const search = document.getElementById("buySearch").value.trim().toLowerCase();
  let rows = (data || []);
  if(search){
    rows = rows.filter(r =>
      String(r.category||"").toLowerCase().includes(search)
      || String(r.item_key||"").toLowerCase().includes(search)
      || String(r.description||"").toLowerCase().includes(search)
    );
  }

  // Guardar datos raw y agrupar
  buyRawData = rows;
  buyGroupedData = buyGroupByCategory(rows);

  // Renderizar componentes
  buyRenderCategoryChips();
  buyRenderListView();
  buyUpdateKPIs();
  
  // Si estamos en vista dashboard, actualizar
  if (buyCurrentView === 'dashboard') {
    setTimeout(() => buyRenderDashboard(), 100);
  }
}
</script>

  <!-- HERRAJES -->
  <section id="tab-herrajes" class="card hidden">
    <div class="k">Herrajes ‚Ä¢ Checklist</div>

    <div class="grid no-print">
      <div class="span-12">
        <div class="row">
          <div class="field" style="min-width:340px;">
            <label>Servicio</label>
            <select id="printService"><option value="">Seleccionar...</option></select>
          </div>

          <button class="btn" id="btnLoadChecklist">Cargar checklist</button>
          <button class="btn" id="btnPrint" disabled>Imprimir</button>
        </div>
        <div class="muted" style="margin-top:10px;">
          Tip: ‚ÄúCant.‚Äù es para preparar. Si viene en pack, muestra compra sugerida.
        </div>
      </div>
    </div>

    <div id="printArea" class="grid">
      <div class="span-12">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-size:18px; font-weight:900;">Checklist de herrajes</div>
            <div class="muted" id="printHeader">‚Äî</div>
          </div>
          <div class="mono muted" id="printServiceId"></div>
        </div>
      </div>

      <div class="span-12">
        <table>
          <thead>
          <tr>
            <th style="width:52px;">OK</th>
            <th>Componente</th>
            <th class="right nowrap">Cant.</th>
            <th class="nowrap">C√≥digo</th>
            <th class="right nowrap">Redondeo</th>
          </tr>
          </thead>
          <tbody id="printTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- COMPLEJIDAD -->
  <section id="tab-complejidad" class="card hidden">
    <div class="k">Complejidad & Programaci√≥n sugerida</div>

    <div class="grid no-print">
      <div class="span-12">
        <div class="row">
          <div class="field">
            <label>L√≠nea</label>
            <select id="cxLine"><option value="">Todas</option></select>
          </div>

          <div class="field">
            <label>Estados</label>
            <input id="cxStatus" value="7,13,17,18,19,21,22"/>
          </div>

          <div class="field">
            <label>Ventana (d√≠as)</label>
            <select id="cxWindow">
              <option value="7">7</option>
              <option value="14" selected>14</option>
              <option value="30">30</option>
            </select>
          </div>

          <div class="field">
            <label>Mostrar</label>
            <select id="cxLimit">
              <option value="50">50</option>
              <option value="100" selected>100</option>
              <option value="200">200</option>
              <option value="500">500</option>
            </select>
          </div>
        </div>
      </div>

      <div class="span-12">
        <div class="row">
          <div class="field">
            <label>Cap. Corte (min)</label>
            <input id="capCut" type="number" value="540" />
          </div>
          <div class="field">
            <label>Cap. Enchape (min)</label>
            <input id="capEdge" type="number" value="540" />
          </div>
          <div class="field">
            <label>Cap. Mecanizado (min)</label>
            <input id="capMach" type="number" value="540" />
          </div>

          <div class="field">
            <label>Coef enchape (min/m)</label>
            <input id="coefEdge" type="number" step="0.01" value="0.60" />
          </div>
          <div class="field">
            <label>Coef drill (min/hole)</label>
            <input id="coefDrill" type="number" step="0.001" value="0.015" />
          </div>
          <div class="field">
            <label>Coef ranura (min)</label>
            <input id="coefFurrow" type="number" step="0.1" value="2.50" />
          </div>
          <div class="field">
            <label>Coef milling (min)</label>
            <input id="coefMill" type="number" step="0.1" value="1.00" />
          </div>

          <button class="btn" id="btnRunSchedule">Calcular programaci√≥n</button>
        </div>
      </div>

      <div class="span-12">
        <div class="metrics">
          <div class="metric">
            <div class="m-k">Entran hoy</div>
            <div class="m-v" id="mFit">-</div>
            <div class="m-s">within_capacity=true</div>
          </div>
          <div class="metric">
            <div class="m-k">Cut acum.</div>
            <div class="m-v" id="mCumCut">-</div>
            <div class="m-s">min</div>
          </div>
          <div class="metric">
            <div class="m-k">Edge acum.</div>
            <div class="m-v" id="mCumEdge">-</div>
            <div class="m-s">min</div>
          </div>
          <div class="metric">
            <div class="m-k">Mach acum.</div>
            <div class="m-v" id="mCumMach">-</div>
            <div class="m-s">min</div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="span-12">
        <div class="k">Programaci√≥n sugerida (rank)</div>
        <table>
          <thead>
          <tr>
            <th class="nowrap">#</th>
            <th>Servicio</th>
            <th class="nowrap">Entrega</th>
            <th class="right nowrap">Score</th>
            <th class="right nowrap">Cut</th>
            <th class="right nowrap">Edge</th>
            <th class="right nowrap">Mach</th>
            <th class="right nowrap">Œ£ Cut</th>
            <th class="right nowrap">Œ£ Edge</th>
            <th class="right nowrap">Œ£ Mach</th>
            <th class="nowrap">Estado</th>
          </tr>
          </thead>
          <tbody id="cxSchedTbody"></tbody>
        </table>
      </div>

      <div class="span-12" style="margin-top:10px;">
        <div class="k">Ranking complejidad (top)</div>
        <table>
          <thead>
          <tr>
            <th>Servicio</th>
            <th class="nowrap">Entrega</th>
            <th class="right nowrap">Score</th>
            <th class="right nowrap">Piezas</th>
            <th class="right nowrap">m¬≤</th>
            <th class="right nowrap">Cantos</th>
            <th class="right nowrap">Drills</th>
            <th class="right nowrap">Ranuras</th>
          </tr>
          </thead>
          <tbody id="cxRankTbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRE PACKING -->
  <section id="tab-packing" class="card hidden">
    <div class="k">Pre Packing ‚Ä¢ Control por m√≥dulo</div>
    <div class="muted" id="packPrintHeader" style="margin-bottom:10px;"></div>

    <!-- controles (no print) -->
    <div class="grid no-print">
      <div class="span-12">
        <div class="row">
          <div class="field" style="min-width:340px;">
            <label>Servicio</label>
            <select id="packService"><option value="">Seleccionar...</option></select>
          </div>

          <div class="field" style="min-width:260px;">
            <label>Scan piece_id</label>
            <input id="packScan" placeholder="Escanear y Enter..." />
          </div>

          <button class="btn" id="btnPackReset" disabled>Resetear</button>
          <button class="btn" id="btnPackUndo" disabled>Deshacer √∫ltimo</button>
          <button class="btn" id="btnPackPrint" disabled>Imprimir remito interno</button>

          <div class="pill">Progreso: <span id="packProgressLbl">-</span></div>
        </div>
        <div class="muted" style="margin-top:8px;">
          Tip: escane√° el ID de la pieza. Cada scan suma 1 hasta completar la cantidad esperada.
        </div>
      </div>
    </div>

    <!-- KPIs (SIEMPRE visibles, tambi√©n en impresi√≥n) -->
    <div class="grid">
      <div class="span-12">
        <div class="metrics">
          <div class="metric">
            <div class="m-k">Esperadas</div>
            <div class="m-v" id="packExpected">-</div>
            <div class="m-s">piezas (qty)</div>
          </div>
          <div class="metric">
            <div class="m-k">Escaneadas</div>
            <div class="m-v" id="packScanned">-</div>
            <div class="m-s">packing_ready</div>
          </div>
          <div class="metric">
            <div class="m-k">Faltantes</div>
            <div class="m-v" id="packMissing">-</div>
            <div class="m-s">alerta si &gt; 0</div>
          </div>
          <div class="metric">
            <div class="m-k">M√≥dulos completos</div>
            <div class="m-v" id="packModulesOk">-</div>
            <div class="m-s">de <span id="packModulesTotal">-</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- tablas -->
    <div class="grid">
      <div class="span-5">
        <div class="k">M√≥dulos</div>
        <table>
          <thead>
          <tr>
            <th>M√≥dulo</th>
            <th class="right">OK</th>
            <th class="right">Faltan</th>
          </tr>
          </thead>
          <tbody id="packModulesTbody"></tbody>
        </table>
      </div>

      <div class="span-7">
        <div class="k">Piezas</div>
        <table>
          <thead>
          <tr>
            <th>Pieza</th>
            <th class="right nowrap">Esc/Exp</th>
            <th class="right nowrap">Faltan</th>
          </tr>
          </thead>
          <tbody id="packPiecesTbody"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ========= CONFIG =========
  const SUPABASE_URL = "https://qnjizqowddtvzzfillmo.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_Agu_I1nw4mY1qRARQBbaHQ_6lTWsFTh";
  // ==========================

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function fmtDate(isoDate){ return isoDate ? isoDate : "-"; }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function csvToSet(csv){
    const raw = (csv||"").split(",").map(x=>x.trim()).filter(Boolean);
    return new Set(raw);
  }
  function num(n, d=0){
    const v = Number(n ?? 0);
    return isFinite(v) ? v.toFixed(d) : "-";
  }

  // Tabs
  const tabs = document.querySelectorAll(".tab");
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    document.getElementById("tab-produccion").classList.toggle("hidden", name!=="produccion");
    document.getElementById("tab-compras").classList.toggle("hidden", name!=="compras");
    document.getElementById("tab-herrajes").classList.toggle("hidden", name!=="herrajes");
    document.getElementById("tab-complejidad").classList.toggle("hidden", name!=="complejidad");
    document.getElementById("tab-packing").classList.toggle("hidden", name!=="packing");
  }
  tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

  let cachedServices = [];
  let cachedLines = [];

  async function refreshLines(){
    const { data, error } = await sb
      .from("mob_services")
      .select("production_line_name")
      .not("production_line_name","is",null)
      .limit(10000);

    if(error) throw error;

    const lines = Array.from(new Set((data||[]).map(x => x.production_line_name).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));

    cachedLines = lines;

    // set lines into selects
    const prodLine = document.getElementById("prodLine");
    const buyLine  = document.getElementById("buyLine");
    const cxLine   = document.getElementById("cxLine");

    prodLine.innerHTML = `<option value="">Todas</option>` + lines.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
    buyLine.innerHTML  = `<option value="">Todas</option>` + lines.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
    cxLine.innerHTML   = `<option value="">Todas</option>` + lines.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join("");
  }

  async function refreshServices(){
    const { data, error } = await sb
      .from("mob_services")
      .select("service_id, internal_code, clients_names, production_line_name, status, estimated_delivery, step_cut_at, step_edge_at, step_machining_at, step_packing_at, edge_used, machining_used, packing_allowed, cutting_times")
      .order("estimated_delivery", { ascending: true, nullsFirst: false })
      .limit(10000);
    if(error) throw error;
    cachedServices = data || [];
  }

  // ---- Producci√≥n ----
  function computeMetrics(services){
    const todayYMD = new Date().toISOString().slice(0,10);
    let overdue = 0, edge = 0, mach = 0;
    for(const s of services){
      if(s.estimated_delivery && s.estimated_delivery < todayYMD) overdue++;
      if(Number(s.edge_used||0) === 1) edge++;
      if(Number(s.machining_used||0) === 1) mach++;
    }
    document.getElementById("mServices").textContent = services.length;
    document.getElementById("mOverdue").textContent = overdue;
    document.getElementById("mEdge").textContent = edge;
    document.getElementById("mMach").textContent = mach;
  }

  function renderProductionTable(){
    const line = document.getElementById("prodLine").value;
    const statusSet = csvToSet(document.getElementById("prodStatus").value);
    const search = document.getElementById("prodSearch").value.trim().toLowerCase();
    const limit = Number(document.getElementById("prodLimit").value || 100);

    let filtered = cachedServices.filter(s => {
      if(line && s.production_line_name !== line) return false;
      if(statusSet.size && !statusSet.has(String(s.status))) return false;
      if(search){
        const a = (s.internal_code||"").toLowerCase();
        const b = (s.clients_names||"").toLowerCase();
        if(!a.includes(search) && !b.includes(search)) return false;
      }
      return true;
    }).slice(0, limit);

    computeMetrics(filtered);

    const tbody = document.getElementById("prodTbody");
    tbody.innerHTML = "";

    for(const s of filtered){
      const cut = s.step_cut_at ? `<span class="tag ok">OK</span>` : `<span class="tag bad">PEND</span>`;
      const edge = (Number(s.edge_used||0)===1)
        ? (s.step_edge_at ? `<span class="tag ok">OK</span>` : `<span class="tag warn">PEND</span>`)
        : `<span class="tag">N/A</span>`;
      const mach = (Number(s.machining_used||0)===1)
        ? (s.step_machining_at ? `<span class="tag ok">OK</span>` : `<span class="tag warn">PEND</span>`)
        : `<span class="tag">N/A</span>`;
      const pack = (Number(s.packing_allowed||0)===1)
        ? (s.step_packing_at ? `<span class="tag ok">OK</span>` : `<span class="tag warn">PEND</span>`)
        : `<span class="tag">N/A</span>`;

      const code = escapeHtml(s.internal_code || "");
      const client = escapeHtml(s.clients_names || "");
      const lineName = escapeHtml(s.production_line_name || "-");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${fmtDate(s.estimated_delivery)}</td>
        <td><div style="font-weight:900;">${code}</div><div class="muted">${client}</div><div class="mono muted">#${s.service_id}</div></td>
        <td>${lineName}</td>
        <td class="nowrap">${s.status ?? "-"}</td>
        <td class="nowrap">${cut}</td>
        <td class="nowrap">${edge}</td>
        <td class="nowrap">${mach}</td>
        <td class="nowrap">${pack}</td>
        <td class="right nowrap">${s.cutting_times ?? "-"}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ---- Compras (operativa) ----
  async function refreshPurchases(){
    const days = Number(document.getElementById("buyDays").value || 7);
    const line = document.getElementById("buyLine").value || null;
    const status = document.getElementById("buyStatus").value || null;

    const { data, error } = await sb.rpc("fn_lista_compras_operativa", {
      p_days: days,
      p_line_name: (line && line.trim() !== "") ? line : null,
      p_status_list: (status && status.trim() !== "") ? status : null
    });
    if(error) throw error;

    const search = document.getElementById("buySearch").value.trim().toLowerCase();
    let rows = (data || []);
    if(search){
      rows = rows.filter(r =>
        String(r.category||"").toLowerCase().includes(search)
        || String(r.item_key||"").toLowerCase().includes(search)
        || String(r.description||"").toLowerCase().includes(search)
      );
    }

    const tbody = document.getElementById("buyTbody");
    tbody.innerHTML = "";

    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap"><span class="tag">${escapeHtml(r.category)}</span></td>
        <td class="mono nowrap">${escapeHtml(r.item_key)}</td>
        <td>${escapeHtml(r.description)}</td>
        <td class="right nowrap">${Number(r.qty||0).toFixed(2).replace(/\.00$/,'')}</td>
        <td class="nowrap">${escapeHtml(r.unit)}</td>
        <td class="right nowrap">${Number(r.cost_estimated||0).toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ---- Herrajes ----
  function populateHerrajesSelect(){
    const sel = document.getElementById("printService");
    sel.innerHTML = `<option value="">Seleccionar...</option>` +
      cachedServices.slice()
        .sort((a,b)=>String(a.internal_code||"").localeCompare(String(b.internal_code||"")))
        .map(s => {
          const label = `${s.internal_code || s.service_id} ‚Äî ${s.clients_names || ""}`.trim();
          return `<option value="${s.service_id}">${escapeHtml(label)}</option>`;
        }).join("");
  }

  async function loadChecklistForService(serviceId){
    const { data, error } = await sb.rpc("fn_checklist_herrajes", { p_service_id: Number(serviceId) });
    if(error) throw error;

    const svc = cachedServices.find(s => Number(s.service_id) === Number(serviceId));
    const head = document.getElementById("printHeader");
    const sidEl = document.getElementById("printServiceId");

    if(svc){
      head.textContent = `${svc.internal_code || ""} ‚Ä¢ ${svc.clients_names || ""} ‚Ä¢ Entrega: ${svc.estimated_delivery || "-"} ‚Ä¢ L√≠nea: ${svc.production_line_name || "-"}`;
    } else {
      head.textContent = `Servicio ${serviceId}`;
    }
    sidEl.textContent = `service_id: ${serviceId}`;

    const tbody = document.getElementById("printTbody");
    tbody.innerHTML = "";

    for(const r of (data || [])){
      const qtyReal = Number(r.qty_real || 0);
      const rounding = Number(r.rounding || 1);
      const qtyCompra = Number(r.qty_compra_sugerida || 0);
      const showCompra = rounding > 1 && qtyCompra > qtyReal;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="right"><input type="checkbox" /></td>
        <td>
          <div style="font-weight:900;">${escapeHtml(r.component_name || "")}</div>
          ${showCompra ? `<div class="muted" style="font-size:11px; margin-top:4px;">Compra sugerida: <b>${qtyCompra.toFixed(0)}</b> (pack ${rounding.toFixed(0)})</div>` : ``}
        </td>
        <td class="right nowrap" style="font-weight:900;">${qtyReal.toFixed(0)}</td>
        <td class="mono nowrap">${escapeHtml(r.component_code || "")}</td>
        <td class="right nowrap">${rounding.toFixed(0)}</td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById("btnPrint").disabled = false;
  }

  // ---- Complejidad ----
  async function refreshComplexityRank(){
    const line = document.getElementById("cxLine").value || null;
    const statusSet = csvToSet(document.getElementById("cxStatus").value);
    const limit = Number(document.getElementById("cxLimit").value || 100);

    const { data, error } = await sb
      .from("vw_service_complexity")
      .select("service_id, internal_code, clients_names, production_line_name, status, estimated_delivery, complexity_score, pieces_total, area_m2, edged_sides_total, drills_est_total, furrows_total")
      .order("complexity_score", { ascending:false })
      .limit(1000);

    if(error) throw error;

    let rows = (data || []).filter(r => {
      if(line && r.production_line_name !== line) return false;
      if(statusSet.size && !statusSet.has(String(r.status))) return false;
      return true;
    }).slice(0, limit);

    const tbody = document.getElementById("cxRankTbody");
    tbody.innerHTML = "";

    for(const r of rows){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${escapeHtml(r.internal_code || "")}</div>
          <div class="muted">${escapeHtml(r.clients_names || "")}</div>
          <div class="mono muted">#${r.service_id}</div>
        </td>
        <td class="nowrap">${fmtDate(r.estimated_delivery)}</td>
        <td class="right nowrap">${num(r.complexity_score,1)}</td>
        <td class="right nowrap">${num(r.pieces_total,0)}</td>
        <td class="right nowrap">${num(r.area_m2,2)}</td>
        <td class="right nowrap">${num(r.edged_sides_total,0)}</td>
        <td class="right nowrap">${num(r.drills_est_total,0)}</td>
        <td class="right nowrap">${num(r.furrows_total,0)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function refreshSchedule(){
    const daysWindow = Number(document.getElementById("cxWindow").value || 14);
    const line = document.getElementById("cxLine").value || null;
    const status = document.getElementById("cxStatus").value || null;

    const capCut = Number(document.getElementById("capCut").value || 540);
    const capEdge = Number(document.getElementById("capEdge").value || 540);
    const capMach = Number(document.getElementById("capMach").value || 540);

    const coefEdge = Number(document.getElementById("coefEdge").value || 0.60);
    const coefDrill = Number(document.getElementById("coefDrill").value || 0.015);
    const coefFurrow = Number(document.getElementById("coefFurrow").value || 2.50);
    const coefMill = Number(document.getElementById("coefMill").value || 1.00);

    const { data, error } = await sb.rpc("fn_daily_schedule_suggested", {
      p_days_window: daysWindow,
      p_line_name: (line && line.trim() !== "") ? line : null,
      p_status_list: (status && status.trim() !== "") ? status : null,
      p_cap_cut_min: capCut,
      p_cap_edge_min: capEdge,
      p_cap_mach_min: capMach,
      p_edge_min_per_meter: coefEdge,
      p_drill_min_per_hole: coefDrill,
      p_furrow_min_each: coefFurrow,
      p_milling_min_each: coefMill
    });

    if(error) throw error;

    const rows = data || [];
    const tbody = document.getElementById("cxSchedTbody");
    tbody.innerHTML = "";

    let fit = 0;
    let lastCut = 0, lastEdge = 0, lastMach = 0;

    for(const r of rows){
      if(r.within_capacity) {
        fit++;
        lastCut = Number(r.cum_cut_min||0);
        lastEdge = Number(r.cum_edge_min||0);
        lastMach = Number(r.cum_mach_min||0);
      }

      const tag = r.within_capacity ? `<span class="tag ok">ENTRA</span>` : `<span class="tag bad">FUERA</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="nowrap">${r.rank}</td>
        <td>
          <div style="font-weight:900;">${escapeHtml(r.internal_code || "")}</div>
          <div class="muted">${escapeHtml(r.clients_names || "")}</div>
          <div class="mono muted">#${r.service_id}</div>
        </td>
        <td class="nowrap">${fmtDate(r.estimated_delivery)}</td>
        <td class="right nowrap">${num(r.complexity_score,1)}</td>
        <td class="right nowrap">${num(r.cut_plan_min,1)}</td>
        <td class="right nowrap">${num(r.edge_est_min,1)}</td>
        <td class="right nowrap">${num(r.mach_est_min,1)}</td>
        <td class="right nowrap">${num(r.cum_cut_min,1)}</td>
        <td class="right nowrap">${num(r.cum_edge_min,1)}</td>
        <td class="right nowrap">${num(r.cum_mach_min,1)}</td>
        <td class="nowrap">${tag}</td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById("mFit").textContent = fit;
    document.getElementById("mCumCut").textContent = num(lastCut,0);
    document.getElementById("mCumEdge").textContent = num(lastEdge,0);
    document.getElementById("mCumMach").textContent = num(lastMach,0);
  }

  // ---- Pre Packing ----
  function populatePackingServiceSelect(){
    const sel = document.getElementById("packService");
    sel.innerHTML = `<option value="">Seleccionar...</option>` +
      cachedServices.slice()
        .sort((a,b)=>String(a.internal_code||"").localeCompare(String(b.internal_code||"")))
        .map(s => {
          const label = `${s.internal_code || s.service_id} ‚Äî ${s.clients_names || ""}`.trim();
          return `<option value="${s.service_id}">${escapeHtml(label)}</option>`;
        }).join("");
  }

  async function loadPackingData(serviceId){
    const { data: svcProg, error: e1 } = await sb
      .from("vw_packing_service_progress")
      .select("service_id, expected, scanned, missing, excess, complete")
      .eq("service_id", serviceId)
      .maybeSingle();
    if (e1) throw e1;

    const { data: mods, error: e2 } = await sb
      .from("vw_packing_module_progress")
      .select("module_label, expected, scanned, missing, excess, complete")
      .eq("service_id", serviceId)
      .order("module_label", { ascending: true });
    if (e2) throw e2;

    const { data: pieces, error: e3 } = await sb
      .from("vw_packing_piece_progress")
      .select("module_label, piece_id, piece_label, qty_expected, qty_scanned, qty_missing, qty_excess, sequence")
      .eq("service_id", serviceId)
      .order("module_label", { ascending: true })
      .order("sequence", { ascending: true })
      .order("piece_id", { ascending: true });
    if (e3) throw e3;

    renderPacking(serviceId, svcProg, mods || [], pieces || []);
  }

  function renderPacking(serviceId, svcProg, mods, pieces){
    const expected = Number(svcProg?.expected || 0);
    const scanned  = Number(svcProg?.scanned || 0);
    const missing  = Number(svcProg?.missing || 0);

    document.getElementById("packExpected").textContent = expected.toFixed(0);
    document.getElementById("packScanned").textContent = scanned.toFixed(0);
    document.getElementById("packMissing").textContent = missing.toFixed(0);

    const okMods = mods.filter(m => m.complete).length;
    document.getElementById("packModulesOk").textContent = okMods;
    document.getElementById("packModulesTotal").textContent = mods.length;

    const pct = expected > 0 ? Math.round((scanned/expected)*100) : 0;
    document.getElementById("packProgressLbl").textContent = `${scanned.toFixed(0)}/${expected.toFixed(0)} (${pct}%)`;

    document.getElementById("btnPackPrint").disabled = (expected === 0);
    document.getElementById("btnPackReset").disabled = (!serviceId);
    document.getElementById("btnPackUndo").disabled = (!serviceId);

    const svc = cachedServices.find(s => Number(s.service_id) === Number(serviceId));
    const nowStr = new Date().toLocaleString();
    const name = svc?.internal_code ? svc.internal_code : `SERVICE_${serviceId}`;
    const client = svc?.clients_names ? ` ‚Ä¢ ${svc.clients_names}` : "";
    document.getElementById("packPrintHeader").textContent =
      `${name}${client} ‚Ä¢ REMITO INTERNO ‚Ä¢ ${nowStr} ‚Ä¢ Piezas: ${scanned}/${expected} ‚Ä¢ Faltan: ${missing} ‚Ä¢ M√≥dulos completos: ${okMods}/${mods.length}`;

    const mt = document.getElementById("packModulesTbody");
    mt.innerHTML = "";
    for(const m of mods){
      const tag = m.complete ? `<span class="tag ok">OK</span>` : `<span class="tag warn">PEND</span>`;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${escapeHtml(m.module_label)}</div>
          <div class="muted" style="font-size:12px;">${tag} ‚Ä¢ ${Number(m.scanned||0).toFixed(0)}/${Number(m.expected||0).toFixed(0)}</div>
        </td>
        <td class="right">${m.complete ? "‚úÖ" : "‚Äî"}</td>
        <td class="right">${Number(m.missing||0).toFixed(0)}</td>
      `;
      mt.appendChild(tr);
    }

    const pt = document.getElementById("packPiecesTbody");
    pt.innerHTML = "";
    for(const p of pieces){
      const exp = Number(p.qty_expected||0);
      const sc  = Number(p.qty_scanned||0);
      const mis = Number(p.qty_missing||0);
      const exc = Number(p.qty_excess||0);

      let status;
      if (exc > 0) status = `<span class="tag info">EXCESO</span>`;
      else if (mis === 0 && exp > 0) status = `<span class="tag ok">OK</span>`;
      else status = `<span class="tag bad">FALTA</span>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <div style="font-weight:900;">${escapeHtml(p.module_label)}</div>
          <div class="muted">${escapeHtml(p.piece_label)}</div>
          <div class="mono muted">piece_id: ${p.piece_id}</div>
        </td>
        <td class="right nowrap">${status} <span class="mono">${sc}/${exp}</span></td>
        <td class="right nowrap">${mis.toFixed(0)}</td>
      `;
      pt.appendChild(tr);
    }
  }

  async function scanPackingPiece(serviceId, pieceId){
    const { error } = await sb.rpc("fn_packing_ready_scan", {
      p_service_id: Number(serviceId),
      p_piece_id: Number(pieceId),
      p_qty: 1,
      p_scanned_by: null
    });
    if (error) throw error;
  }

  // Wiring
  document.getElementById("btnRefresh").addEventListener("click", async () => boot());

  ["prodLine","prodStatus","prodSearch","prodLimit"].forEach(id => {
    document.getElementById(id).addEventListener("input", renderProductionTable);
    document.getElementById(id).addEventListener("change", renderProductionTable);
  });

  ["buyDays","buyLine","buyStatus","buySearch"].forEach(id => {
    document.getElementById(id).addEventListener("input", refreshPurchases);
    document.getElementById(id).addEventListener("change", refreshPurchases);
  });

  document.getElementById("btnLoadChecklist").addEventListener("click", async () => {
    const sid = document.getElementById("printService").value;
    if(!sid) return;
    document.getElementById("btnLoadChecklist").disabled = true;
    try{ await loadChecklistForService(sid); }
    finally { document.getElementById("btnLoadChecklist").disabled = false; }
  });

  document.getElementById("btnPrint").addEventListener("click", () => window.print());

  ["cxLine","cxStatus","cxWindow","cxLimit"].forEach(id => {
    document.getElementById(id).addEventListener("change", async () => refreshComplexityRank());
  });

  document.getElementById("btnRunSchedule").addEventListener("click", async () => {
    document.getElementById("btnRunSchedule").disabled = true;
    try{ await refreshSchedule(); }
    finally { document.getElementById("btnRunSchedule").disabled = false; }
  });

  // Pre Packing events
  document.getElementById("packService").addEventListener("change", async () => {
    const sid = Number(document.getElementById("packService").value);
    if(!sid) return;
    await loadPackingData(sid);
  });

  document.getElementById("packScan").addEventListener("keydown", async (ev) => {
    if (ev.key !== "Enter") return;

    const sid = Number(document.getElementById("packService").value);
    const txt = document.getElementById("packScan").value.trim();
    if(!sid || !txt) return;

    const pieceId = Number(txt.replace(/\D/g,''));
    if(!pieceId) return;

    document.getElementById("packScan").value = "";

    try{
      await scanPackingPiece(sid, pieceId);
      await loadPackingData(sid);
    } catch(e){
      console.error(e);
      alert("No pude registrar el scan. Revis√° que el piece_id pertenezca al servicio.");
    }
  });

  document.getElementById("btnPackReset").addEventListener("click", async () => {
    const sid = Number(document.getElementById("packService").value);
    if(!sid) return;
    if(!confirm("¬øResetear el control de este servicio? Se borrar√°n todos los scans de Pre Packing.")) return;

    const { error } = await sb.rpc("fn_packing_ready_reset", { p_service_id: sid });
    if (error) { alert("No pude resetear."); console.error(error); return; }
    await loadPackingData(sid);
  });

  document.getElementById("btnPackUndo").addEventListener("click", async () => {
    const sid = Number(document.getElementById("packService").value);
    if(!sid) return;

    const { error } = await sb.rpc("fn_packing_ready_undo", { p_service_id: sid });
    if (error) { alert("No pude deshacer."); console.error(error); return; }
    await loadPackingData(sid);
  });

  document.getElementById("btnPackPrint").addEventListener("click", async () => {
    setTab("packing");
    const sid = Number(document.getElementById("packService").value);
    if (!sid) { alert("Seleccion√° un servicio antes de imprimir."); return; }

    await loadPackingData(sid);

    const svc = cachedServices.find(s => Number(s.service_id) === sid);
    const serviceName = svc?.internal_code ? svc.internal_code : `SERVICE_${sid}`;

    const oldTitle = document.title;
    document.title = `${serviceName} - REMITO INTERNO`;
    window.print();
    setTimeout(() => { document.title = oldTitle; }, 500);
  });

  async function boot(){
    document.getElementById("btnRefresh").disabled = true;
    try{
      await refreshServices();
      await refreshLines();
      renderProductionTable();
      await refreshPurchases();

      populateHerrajesSelect();
      populatePackingServiceSelect();

      await refreshComplexityRank();

      document.getElementById("lastSync").textContent = new Date().toLocaleTimeString();
    } catch (e){
      console.error(e);
      document.getElementById("lastSync").textContent = "ERROR";
      alert("Error cargando datos. Revis√° consola (F12).");
    } finally {
      document.getElementById("btnRefresh").disabled = false;
    }
  }

  boot();
</script>
</body>
</html>

